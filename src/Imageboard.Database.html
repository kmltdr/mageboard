<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# OPTIONS_GHC -fno-warn-orphans #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE OverloadedStrings, TypeOperators, RecordWildCards #-}</span><span>
</span><span id="line-3"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Imageboard.Database</span><span> </span><span class="hs-special">(</span><span>
</span><span id="line-4"></span><span>    </span><span class="annot"><a href="Imageboard.Database.html#setupDb"><span class="hs-identifier">setupDb</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-5"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Post and thread insertion</span></span><span>
</span><span id="line-6"></span><span>    </span><span class="annot"><a href="Imageboard.Database.html#insertPost"><span class="hs-identifier">insertPost</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-7"></span><span>    </span><span class="annot"><a href="Imageboard.Database.html#insertFile"><span class="hs-identifier">insertFile</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-8"></span><span>    </span><span class="annot"><a href="Imageboard.Database.html#insertPostWithFile"><span class="hs-identifier">insertPostWithFile</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-9"></span><span>    </span><span class="annot"><a href="Imageboard.Database.html#insertThread"><span class="hs-identifier">insertThread</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-10"></span><span>    </span><span class="annot"><a href="Imageboard.Database.html#insertThreadWithFile"><span class="hs-identifier">insertThreadWithFile</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-11"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Post and thread queries</span></span><span>
</span><span id="line-12"></span><span>    </span><span class="annot"><a href="Imageboard.Database.html#getPosts"><span class="hs-identifier">getPosts</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-13"></span><span>    </span><span class="annot"><a href="Imageboard.Database.html#getThread"><span class="hs-identifier">getThread</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-14"></span><span>    </span><span class="annot"><a href="Imageboard.Database.html#checkThread"><span class="hs-identifier">checkThread</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-15"></span><span>    </span><span class="annot"><a href="Imageboard.Database.html#getThreads"><span class="hs-identifier">getThreads</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-16"></span><span>    </span><span class="annot"><a href="Imageboard.Database.html#getThreadInfo"><span class="hs-identifier">getThreadInfo</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-17"></span><span>    </span><span class="annot"><a href="Imageboard.Database.html#getFileId"><span class="hs-identifier">getFileId</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-18"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Board queries and management</span></span><span>
</span><span id="line-19"></span><span>    </span><span class="annot"><a href="Imageboard.Database.html#getConstraints"><span class="hs-identifier">getConstraints</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-20"></span><span>    </span><span class="annot"><a href="Imageboard.Database.html#getBoardNames"><span class="hs-identifier">getBoardNames</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-21"></span><span>    </span><span class="annot"><a href="Imageboard.Database.html#getBoardInfo"><span class="hs-identifier">getBoardInfo</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-22"></span><span>    </span><span class="annot"><a href="Imageboard.Database.html#getBoardInfos"><span class="hs-identifier">getBoardInfos</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-23"></span><span>    </span><span class="annot"><a href="Imageboard.Database.html#updateBoard"><span class="hs-identifier">updateBoard</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-24"></span><span>    </span><span class="annot"><a href="Imageboard.Database.html#insertBoard"><span class="hs-identifier">insertBoard</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-25"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Account management</span></span><span>
</span><span id="line-26"></span><span>    </span><span class="annot"><a href="Imageboard.Database.html#getPasswordHash"><span class="hs-identifier">getPasswordHash</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-27"></span><span>    </span><span class="annot"><a href="Imageboard.Database.html#insertSessionToken"><span class="hs-identifier">insertSessionToken</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-28"></span><span>    </span><span class="annot"><a href="Imageboard.Database.html#removeSessionToken"><span class="hs-identifier">removeSessionToken</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-29"></span><span>    </span><span class="annot"><a href="Imageboard.Database.html#getAccounts"><span class="hs-identifier">getAccounts</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-30"></span><span>    </span><span class="annot"><a href="Imageboard.Database.html#getAccountByToken"><span class="hs-identifier">getAccountByToken</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-31"></span><span>    </span><span class="annot"><a href="Imageboard.Database.html#checkAccount"><span class="hs-identifier">checkAccount</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-32"></span><span>    </span><span class="annot"><a href="Imageboard.Database.html#checkSession"><span class="hs-identifier">checkSession</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-33"></span><span>    </span><span class="annot"><a href="Imageboard.Database.html#insertAccount"><span class="hs-identifier">insertAccount</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-34"></span><span>    </span><span class="annot"><a href="Imageboard.Database.html#changePassword"><span class="hs-identifier">changePassword</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-35"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Moderation</span></span><span>
</span><span id="line-36"></span><span>    </span><span class="annot"><a href="Imageboard.Database.html#removeFile"><span class="hs-identifier">removeFile</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-37"></span><span>    </span><span class="annot"><a href="Imageboard.Database.html#removePost"><span class="hs-identifier">removePost</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-38"></span><span>    </span><span class="annot"><a href="Imageboard.Database.html#unlinkFile"><span class="hs-identifier">unlinkFile</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-39"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Toggle one of ThreadFlags</span></span><span>
</span><span id="line-40"></span><span>    </span><span class="annot"><a href="Imageboard.Database.html#toggleSticky"><span class="hs-identifier">toggleSticky</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-41"></span><span>    </span><span class="annot"><a href="Imageboard.Database.html#toggleLock"><span class="hs-identifier">toggleLock</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-42"></span><span>    </span><span class="annot"><a href="Imageboard.Database.html#toggleAutosage"><span class="hs-identifier">toggleAutosage</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-43"></span><span>    </span><span class="annot"><a href="Imageboard.Database.html#toggleCycle"><span class="hs-identifier">toggleCycle</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-44"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Captcha</span></span><span>
</span><span id="line-45"></span><span>    </span><span class="annot"><a href="Imageboard.Database.html#insertCaptcha"><span class="hs-identifier">insertCaptcha</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-46"></span><span>    </span><span class="annot"><a href="Imageboard.Database.html#checkCaptcha"><span class="hs-identifier">checkCaptcha</span></a></span><span>
</span><span id="line-47"></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-48"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">liftM2</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">liftM4</span></span><span class="hs-special">)</span><span>
</span><span id="line-49"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Text</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Text</span></span><span class="hs-special">)</span><span>
</span><span id="line-50"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">listToMaybe</span></span><span class="hs-special">)</span><span>
</span><span id="line-51"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Functor</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-operator">(&lt;&amp;&gt;)</span></span><span class="hs-special">)</span><span>
</span><span id="line-52"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Text.IO</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">T</span></span><span>
</span><span id="line-53"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Database.SQLite.Simple</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">DB</span></span><span>
</span><span id="line-54"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Database.SQLite.Simple</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">NamedParam</span></span><span class="hs-special">(</span><span class="annot"><span class="hs-operator">(:=)</span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-operator">(:.)</span></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-55"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Database.SQLite.Simple.FromRow</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">DB</span></span><span>
</span><span id="line-56"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Database.SQLite.Simple.FromField</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">DB</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">FieldParser</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">fieldData</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">returnError</span></span><span class="hs-special">)</span><span>
</span><span id="line-57"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Database.SQLite.Simple.Ok</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">DB</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Ok</span></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-58"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Database.SQLite.Simple.Time.Implementation</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">DB</span></span><span>
</span><span id="line-59"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Database.SQLite3</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">DirectDB</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">open</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">close</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">exec</span></span><span class="hs-special">)</span><span>
</span><span id="line-60"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Time.Clock</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">UTCTime</span></span><span class="hs-special">)</span><span>
</span><span id="line-61"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Time.Clock.POSIX</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">posixSecondsToUTCTime</span></span><span class="hs-special">)</span><span>
</span><span id="line-62"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Password.Bcrypt</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">P</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">hashPassword</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">PasswordHash</span></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span class="annot"><span class="hs-identifier">Bcrypt</span></span><span class="hs-special">)</span><span>
</span><span id="line-63"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Imageboard.Types.html"><span class="hs-identifier">Imageboard.Types</span></a></span><span>
</span><span id="line-64"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Imageboard.Config.html"><span class="hs-identifier">Imageboard.Config</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Config</span></span><span>
</span><span id="line-65"></span><span>
</span><span id="line-66"></span><span class="annot"><a href="Imageboard.Database.html#parseDate"><span class="hs-identifier hs-type">parseDate</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DB.FieldParser</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">UTCTime</span></span><span>
</span><span id="line-67"></span><span id="parseDate"><span class="annot"><span class="annottext">parseDate :: FieldParser UTCTime
</span><a href="Imageboard.Database.html#parseDate"><span class="hs-identifier hs-var hs-var">parseDate</span></a></span></span><span> </span><span id="local-6989586621679159286"><span class="annot"><span class="annottext">f :: Field
</span><a href="#local-6989586621679159286"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Field -&gt; SQLData
</span><span class="hs-identifier hs-var">DB.fieldData</span></span><span> </span><span class="annot"><span class="annottext">Field
</span><a href="#local-6989586621679159286"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="hs-keyword">of</span><span> </span><span>
</span><span id="line-68"></span><span>    </span><span class="hs-comment">-- INTEGER as Unix Time, the number of seconds since 1970-01-01 00:00:00 UTC. </span><span>
</span><span id="line-69"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">DB.SQLInteger</span></span><span> </span><span id="local-6989586621679159284"><span class="annot"><span class="annottext">x :: Int64
</span><a href="#local-6989586621679159284"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">UTCTime -&gt; Ok UTCTime
forall a. a -&gt; Ok a
</span><span class="hs-identifier hs-var">DB.Ok</span></span><span> </span><span class="annot"><span class="annottext">(UTCTime -&gt; Ok UTCTime)
-&gt; (POSIXTime -&gt; UTCTime) -&gt; POSIXTime -&gt; Ok UTCTime
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">POSIXTime -&gt; UTCTime
</span><span class="hs-identifier hs-var">posixSecondsToUTCTime</span></span><span> </span><span class="annot"><span class="annottext">(POSIXTime -&gt; Ok UTCTime) -&gt; POSIXTime -&gt; Ok UTCTime
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int64 -&gt; POSIXTime
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">Int64
</span><a href="#local-6989586621679159284"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-70"></span><span>    </span><span class="hs-comment">-- TEXT as ISO8601 strings (&quot;YYYY-MM-DD HH:MM:SS.SSS&quot;). </span><span>
</span><span id="line-71"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">DB.SQLText</span></span><span> </span><span id="local-6989586621679159280"><span class="annot"><span class="annottext">x :: Text
</span><a href="#local-6989586621679159280"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Text -&gt; Either String UTCTime
</span><span class="hs-identifier hs-var">DB.parseUTCTime</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679159280"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="hs-keyword">of</span><span> </span><span>
</span><span id="line-72"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621679159278"><span class="annot"><span class="annottext">s :: String
</span><a href="#local-6989586621679159278"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(String -&gt; String -&gt; String -&gt; ResultError)
-&gt; Field -&gt; String -&gt; Ok UTCTime
forall a err.
(Typeable a, Exception err) =&gt;
(String -&gt; String -&gt; String -&gt; err) -&gt; Field -&gt; String -&gt; Ok a
</span><span class="hs-identifier hs-var">DB.returnError</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String -&gt; ResultError
</span><span class="hs-identifier hs-var">DB.ConversionFailed</span></span><span> </span><span class="annot"><span class="annottext">Field
</span><a href="#local-6989586621679159286"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679159278"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-73"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span id="local-6989586621679159276"><span class="annot"><span class="annottext">t :: UTCTime
</span><a href="#local-6989586621679159276"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">UTCTime -&gt; Ok UTCTime
forall a. a -&gt; Ok a
</span><span class="hs-identifier hs-var">DB.Ok</span></span><span> </span><span class="annot"><span class="annottext">(UTCTime -&gt; Ok UTCTime) -&gt; UTCTime -&gt; Ok UTCTime
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621679159276"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-74"></span><span>    </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(String -&gt; String -&gt; String -&gt; ResultError)
-&gt; Field -&gt; String -&gt; Ok UTCTime
forall a err.
(Typeable a, Exception err) =&gt;
(String -&gt; String -&gt; String -&gt; err) -&gt; Field -&gt; String -&gt; Ok a
</span><span class="hs-identifier hs-var">DB.returnError</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String -&gt; ResultError
</span><span class="hs-identifier hs-var">DB.Incompatible</span></span><span> </span><span class="annot"><span class="annottext">Field
</span><a href="#local-6989586621679159286"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;expecting an SQLInteger column type&quot;</span></span><span>
</span><span id="line-75"></span><span>
</span><span id="line-76"></span><span class="annot"><a href="Imageboard.Database.html#mkThreadHead"><span class="hs-identifier hs-type">mkThreadHead</span></a></span><span> </span><span class="hs-glyph">::</span><span>  </span><span class="annot"><a href="Imageboard.Types.html#Post"><span class="hs-identifier hs-type">Post</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">:.</span></span><span> </span><span class="annot"><a href="Imageboard.Types.html#ThreadInfo"><span class="hs-identifier hs-type">ThreadInfo</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Imageboard.Types.html#ThreadHead"><span class="hs-identifier hs-type">ThreadHead</span></a></span><span>
</span><span id="line-77"></span><span id="mkThreadHead"><span class="annot"><span class="annottext">mkThreadHead :: (Post :. ThreadInfo) -&gt; ThreadHead
</span><a href="Imageboard.Database.html#mkThreadHead"><span class="hs-identifier hs-var hs-var">mkThreadHead</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679159273"><span class="annot"><span class="annottext">p :: Post
</span><a href="#local-6989586621679159273"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span class="annot"><span class="hs-operator hs-type">:.</span></span><span> </span><span id="local-6989586621679159271"><span class="annot"><span class="annottext">i :: ThreadInfo
</span><a href="#local-6989586621679159271"><span class="hs-identifier hs-var">i</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Post -&gt; ThreadInfo -&gt; ThreadHead
</span><a href="Imageboard.Types.html#ThreadHead"><span class="hs-identifier hs-var">ThreadHead</span></a></span><span> </span><span class="annot"><span class="annottext">Post
</span><a href="#local-6989586621679159273"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="annot"><span class="annottext">ThreadInfo
</span><a href="#local-6989586621679159271"><span class="hs-identifier hs-var">i</span></a></span><span>
</span><span id="line-78"></span><span>
</span><span id="line-79"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DB.FromRow</span></span><span> </span><span class="annot"><a href="Imageboard.Types.html#Post"><span class="hs-identifier hs-type">Post</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-80"></span><span>    </span><span id="local-6989586621679159267"><span class="annot"><span class="annottext">fromRow :: RowParser Post
</span><span class="hs-identifier hs-var hs-var hs-var hs-var">fromRow</span></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PostLocation -&gt; UTCTime -&gt; PostStub -&gt; Maybe File -&gt; Post
</span><a href="Imageboard.Types.html#Post"><span class="hs-identifier hs-var">Post</span></a></span><span>  </span><span class="annot"><span class="annottext">(PostLocation -&gt; UTCTime -&gt; PostStub -&gt; Maybe File -&gt; Post)
-&gt; RowParser PostLocation
-&gt; RowParser (UTCTime -&gt; PostStub -&gt; Maybe File -&gt; Post)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text -&gt; Int -&gt; Maybe Int -&gt; PostLocation
</span><a href="Imageboard.Types.html#PostLocation"><span class="hs-identifier hs-var">PostLocation</span></a></span><span>
</span><span id="line-81"></span><span>                            </span><span class="annot"><span class="annottext">(Text -&gt; Int -&gt; Maybe Int -&gt; PostLocation)
-&gt; RowParser Text -&gt; RowParser (Int -&gt; Maybe Int -&gt; PostLocation)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">RowParser Text
forall a. FromField a =&gt; RowParser a
</span><span class="hs-identifier hs-var">DB.field</span></span><span>
</span><span id="line-82"></span><span>                            </span><span class="annot"><span class="annottext">RowParser (Int -&gt; Maybe Int -&gt; PostLocation)
-&gt; RowParser Int -&gt; RowParser (Maybe Int -&gt; PostLocation)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">RowParser Int
forall a. FromField a =&gt; RowParser a
</span><span class="hs-identifier hs-var">DB.field</span></span><span>
</span><span id="line-83"></span><span>                            </span><span class="annot"><span class="annottext">RowParser (Maybe Int -&gt; PostLocation)
-&gt; RowParser (Maybe Int) -&gt; RowParser PostLocation
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">RowParser (Maybe Int)
forall a. FromField a =&gt; RowParser a
</span><span class="hs-identifier hs-var">DB.field</span></span><span class="hs-special">)</span><span>
</span><span id="line-84"></span><span>                    </span><span class="annot"><span class="annottext">RowParser (UTCTime -&gt; PostStub -&gt; Maybe File -&gt; Post)
-&gt; RowParser UTCTime -&gt; RowParser (PostStub -&gt; Maybe File -&gt; Post)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">FieldParser UTCTime -&gt; RowParser UTCTime
forall a. FieldParser a -&gt; RowParser a
</span><span class="hs-identifier hs-var">DB.fieldWith</span></span><span> </span><span class="annot"><span class="annottext">FieldParser UTCTime
</span><a href="Imageboard.Database.html#parseDate"><span class="hs-identifier hs-var">parseDate</span></a></span><span> </span><span>
</span><span id="line-85"></span><span>                    </span><span class="annot"><span class="annottext">RowParser (PostStub -&gt; Maybe File -&gt; Post)
-&gt; RowParser PostStub -&gt; RowParser (Maybe File -&gt; Post)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text -&gt; Text -&gt; PostStub
</span><a href="Imageboard.Types.html#Stub"><span class="hs-identifier hs-var">Stub</span></a></span><span>   </span><span>
</span><span id="line-86"></span><span>                        </span><span class="annot"><span class="annottext">(Text -&gt; Text -&gt; Text -&gt; Text -&gt; PostStub)
-&gt; RowParser Text -&gt; RowParser (Text -&gt; Text -&gt; Text -&gt; PostStub)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">RowParser Text
forall a. FromField a =&gt; RowParser a
</span><span class="hs-identifier hs-var">DB.field</span></span><span> </span><span>
</span><span id="line-87"></span><span>                        </span><span class="annot"><span class="annottext">RowParser (Text -&gt; Text -&gt; Text -&gt; PostStub)
-&gt; RowParser Text -&gt; RowParser (Text -&gt; Text -&gt; PostStub)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">RowParser Text
forall a. FromField a =&gt; RowParser a
</span><span class="hs-identifier hs-var">DB.field</span></span><span> </span><span>
</span><span id="line-88"></span><span>                        </span><span class="annot"><span class="annottext">RowParser (Text -&gt; Text -&gt; PostStub)
-&gt; RowParser Text -&gt; RowParser (Text -&gt; PostStub)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">RowParser Text
forall a. FromField a =&gt; RowParser a
</span><span class="hs-identifier hs-var">DB.field</span></span><span> </span><span>
</span><span id="line-89"></span><span>                        </span><span class="annot"><span class="annottext">RowParser (Text -&gt; PostStub)
-&gt; RowParser Text -&gt; RowParser PostStub
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">RowParser Text
forall a. FromField a =&gt; RowParser a
</span><span class="hs-identifier hs-var">DB.field</span></span><span class="hs-special">)</span><span>
</span><span id="line-90"></span><span>                    </span><span class="annot"><span class="annottext">RowParser (Maybe File -&gt; Post)
-&gt; RowParser (Maybe File) -&gt; RowParser Post
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Text -&gt; FileType -&gt; Int -&gt; Maybe Dimensions -&gt; File)
-&gt; Maybe Text
-&gt; Maybe FileType
-&gt; Maybe Int
-&gt; Maybe (Maybe Dimensions)
-&gt; Maybe File
forall (m :: * -&gt; *) a1 a2 a3 a4 r.
Monad m =&gt;
(a1 -&gt; a2 -&gt; a3 -&gt; a4 -&gt; r) -&gt; m a1 -&gt; m a2 -&gt; m a3 -&gt; m a4 -&gt; m r
</span><span class="hs-identifier hs-var">liftM4</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; FileType -&gt; Int -&gt; Maybe Dimensions -&gt; File
</span><a href="Imageboard.Types.html#File"><span class="hs-identifier hs-var">File</span></a></span><span>    </span><span>
</span><span id="line-91"></span><span>                        </span><span class="annot"><span class="annottext">(Maybe Text
 -&gt; Maybe FileType
 -&gt; Maybe Int
 -&gt; Maybe (Maybe Dimensions)
 -&gt; Maybe File)
-&gt; RowParser (Maybe Text)
-&gt; RowParser
     (Maybe FileType
      -&gt; Maybe Int -&gt; Maybe (Maybe Dimensions) -&gt; Maybe File)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">RowParser (Maybe Text)
forall a. FromField a =&gt; RowParser a
</span><span class="hs-identifier hs-var">DB.field</span></span><span> </span><span>
</span><span id="line-92"></span><span>                        </span><span class="annot"><span class="annottext">RowParser
  (Maybe FileType
   -&gt; Maybe Int -&gt; Maybe (Maybe Dimensions) -&gt; Maybe File)
-&gt; RowParser (Maybe FileType)
-&gt; RowParser (Maybe Int -&gt; Maybe (Maybe Dimensions) -&gt; Maybe File)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; FileType
forall a. Enum a =&gt; Int -&gt; a
</span><span class="hs-identifier hs-var">toEnum</span></span><span> </span><span class="annot"><span class="annottext">(Int -&gt; FileType) -&gt; Maybe Int -&gt; Maybe FileType
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Maybe Int -&gt; Maybe FileType)
-&gt; RowParser (Maybe Int) -&gt; RowParser (Maybe FileType)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">RowParser (Maybe Int)
forall a. FromField a =&gt; RowParser a
</span><span class="hs-identifier hs-var">DB.field</span></span><span class="hs-special">)</span><span> </span><span>
</span><span id="line-93"></span><span>                        </span><span class="annot"><span class="annottext">RowParser (Maybe Int -&gt; Maybe (Maybe Dimensions) -&gt; Maybe File)
-&gt; RowParser (Maybe Int)
-&gt; RowParser (Maybe (Maybe Dimensions) -&gt; Maybe File)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">RowParser (Maybe Int)
forall a. FromField a =&gt; RowParser a
</span><span class="hs-identifier hs-var">DB.field</span></span><span> </span><span>
</span><span id="line-94"></span><span>                        </span><span class="annot"><span class="annottext">RowParser (Maybe (Maybe Dimensions) -&gt; Maybe File)
-&gt; RowParser (Maybe (Maybe Dimensions)) -&gt; RowParser (Maybe File)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe Dimensions -&gt; Maybe (Maybe Dimensions)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(Maybe Dimensions -&gt; Maybe (Maybe Dimensions))
-&gt; RowParser (Maybe Dimensions)
-&gt; RowParser (Maybe (Maybe Dimensions))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Int -&gt; Int -&gt; Dimensions)
-&gt; Maybe Int -&gt; Maybe Int -&gt; Maybe Dimensions
forall (m :: * -&gt; *) a1 a2 r.
Monad m =&gt;
(a1 -&gt; a2 -&gt; r) -&gt; m a1 -&gt; m a2 -&gt; m r
</span><span class="hs-identifier hs-var">liftM2</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Dimensions
</span><a href="Imageboard.Types.html#Dim"><span class="hs-identifier hs-var">Dim</span></a></span><span> </span><span>
</span><span id="line-95"></span><span>                            </span><span class="annot"><span class="annottext">(Maybe Int -&gt; Maybe Int -&gt; Maybe Dimensions)
-&gt; RowParser (Maybe Int)
-&gt; RowParser (Maybe Int -&gt; Maybe Dimensions)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">RowParser (Maybe Int)
forall a. FromField a =&gt; RowParser a
</span><span class="hs-identifier hs-var">DB.field</span></span><span>
</span><span id="line-96"></span><span>                            </span><span class="annot"><span class="annottext">RowParser (Maybe Int -&gt; Maybe Dimensions)
-&gt; RowParser (Maybe Int) -&gt; RowParser (Maybe Dimensions)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">RowParser (Maybe Int)
forall a. FromField a =&gt; RowParser a
</span><span class="hs-identifier hs-var">DB.field</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-97"></span><span>
</span><span id="line-98"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DB.FromRow</span></span><span> </span><span class="annot"><a href="Imageboard.Types.html#ThreadInfo"><span class="hs-identifier hs-type">ThreadInfo</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-99"></span><span>    </span><span id="local-6989586621679159255"><span class="annot"><span class="annottext">fromRow :: RowParser ThreadInfo
</span><a href="#local-6989586621679159255"><span class="hs-identifier hs-var hs-var hs-var hs-var">fromRow</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UTCTime -&gt; ThreadFlags -&gt; Int -&gt; ThreadInfo
</span><a href="Imageboard.Types.html#ThreadInfo"><span class="hs-identifier hs-var">ThreadInfo</span></a></span><span> </span><span>
</span><span id="line-100"></span><span>                </span><span class="annot"><span class="annottext">(UTCTime -&gt; ThreadFlags -&gt; Int -&gt; ThreadInfo)
-&gt; RowParser UTCTime
-&gt; RowParser (ThreadFlags -&gt; Int -&gt; ThreadInfo)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">FieldParser UTCTime -&gt; RowParser UTCTime
forall a. FieldParser a -&gt; RowParser a
</span><span class="hs-identifier hs-var">DB.fieldWith</span></span><span> </span><span class="annot"><span class="annottext">FieldParser UTCTime
</span><a href="Imageboard.Database.html#parseDate"><span class="hs-identifier hs-var">parseDate</span></a></span><span>
</span><span id="line-101"></span><span>                </span><span class="annot"><span class="annottext">RowParser (ThreadFlags -&gt; Int -&gt; ThreadInfo)
-&gt; RowParser ThreadFlags -&gt; RowParser (Int -&gt; ThreadInfo)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool -&gt; Bool -&gt; ThreadFlags
</span><a href="Imageboard.Types.html#Flags"><span class="hs-identifier hs-var">Flags</span></a></span><span> </span><span>
</span><span id="line-102"></span><span>                    </span><span class="annot"><span class="annottext">(Bool -&gt; Bool -&gt; Bool -&gt; Bool -&gt; ThreadFlags)
-&gt; RowParser Bool
-&gt; RowParser (Bool -&gt; Bool -&gt; Bool -&gt; ThreadFlags)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">RowParser Bool
forall a. FromField a =&gt; RowParser a
</span><span class="hs-identifier hs-var">DB.field</span></span><span>
</span><span id="line-103"></span><span>                    </span><span class="annot"><span class="annottext">RowParser (Bool -&gt; Bool -&gt; Bool -&gt; ThreadFlags)
-&gt; RowParser Bool -&gt; RowParser (Bool -&gt; Bool -&gt; ThreadFlags)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">RowParser Bool
forall a. FromField a =&gt; RowParser a
</span><span class="hs-identifier hs-var">DB.field</span></span><span> </span><span>
</span><span id="line-104"></span><span>                    </span><span class="annot"><span class="annottext">RowParser (Bool -&gt; Bool -&gt; ThreadFlags)
-&gt; RowParser Bool -&gt; RowParser (Bool -&gt; ThreadFlags)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">RowParser Bool
forall a. FromField a =&gt; RowParser a
</span><span class="hs-identifier hs-var">DB.field</span></span><span>
</span><span id="line-105"></span><span>                    </span><span class="annot"><span class="annottext">RowParser (Bool -&gt; ThreadFlags)
-&gt; RowParser Bool -&gt; RowParser ThreadFlags
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">RowParser Bool
forall a. FromField a =&gt; RowParser a
</span><span class="hs-identifier hs-var">DB.field</span></span><span class="hs-special">)</span><span>
</span><span id="line-106"></span><span>                </span><span class="annot"><span class="annottext">RowParser (Int -&gt; ThreadInfo)
-&gt; RowParser Int -&gt; RowParser ThreadInfo
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">RowParser Int
forall a. FromField a =&gt; RowParser a
</span><span class="hs-identifier hs-var">DB.field</span></span><span>
</span><span id="line-107"></span><span>
</span><span id="line-108"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DB.FromRow</span></span><span> </span><span class="annot"><a href="Imageboard.Types.html#BoardConstraints"><span class="hs-identifier hs-type">BoardConstraints</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-109"></span><span>    </span><span id="local-6989586621679159251"><span class="annot"><span class="annottext">fromRow :: RowParser BoardConstraints
</span><a href="#local-6989586621679159251"><span class="hs-identifier hs-var hs-var hs-var hs-var">fromRow</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Int -&gt; Int -&gt; Int -&gt; Int -&gt; Int -&gt; BoardConstraints
</span><a href="Imageboard.Types.html#Constraints"><span class="hs-identifier hs-var">Constraints</span></a></span><span>
</span><span id="line-110"></span><span>                </span><span class="annot"><span class="annottext">(Bool -&gt; Int -&gt; Int -&gt; Int -&gt; Int -&gt; Int -&gt; BoardConstraints)
-&gt; RowParser Bool
-&gt; RowParser (Int -&gt; Int -&gt; Int -&gt; Int -&gt; Int -&gt; BoardConstraints)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">RowParser Bool
forall a. FromField a =&gt; RowParser a
</span><span class="hs-identifier hs-var">DB.field</span></span><span>
</span><span id="line-111"></span><span>                </span><span class="annot"><span class="annottext">RowParser (Int -&gt; Int -&gt; Int -&gt; Int -&gt; Int -&gt; BoardConstraints)
-&gt; RowParser Int
-&gt; RowParser (Int -&gt; Int -&gt; Int -&gt; Int -&gt; BoardConstraints)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">RowParser Int
forall a. FromField a =&gt; RowParser a
</span><span class="hs-identifier hs-var">DB.field</span></span><span> </span><span>
</span><span id="line-112"></span><span>                </span><span class="annot"><span class="annottext">RowParser (Int -&gt; Int -&gt; Int -&gt; Int -&gt; BoardConstraints)
-&gt; RowParser Int
-&gt; RowParser (Int -&gt; Int -&gt; Int -&gt; BoardConstraints)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">RowParser Int
forall a. FromField a =&gt; RowParser a
</span><span class="hs-identifier hs-var">DB.field</span></span><span>
</span><span id="line-113"></span><span>                </span><span class="annot"><span class="annottext">RowParser (Int -&gt; Int -&gt; Int -&gt; BoardConstraints)
-&gt; RowParser Int -&gt; RowParser (Int -&gt; Int -&gt; BoardConstraints)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">RowParser Int
forall a. FromField a =&gt; RowParser a
</span><span class="hs-identifier hs-var">DB.field</span></span><span>
</span><span id="line-114"></span><span>                </span><span class="annot"><span class="annottext">RowParser (Int -&gt; Int -&gt; BoardConstraints)
-&gt; RowParser Int -&gt; RowParser (Int -&gt; BoardConstraints)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">RowParser Int
forall a. FromField a =&gt; RowParser a
</span><span class="hs-identifier hs-var">DB.field</span></span><span>
</span><span id="line-115"></span><span>                </span><span class="annot"><span class="annottext">RowParser (Int -&gt; BoardConstraints)
-&gt; RowParser Int -&gt; RowParser BoardConstraints
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">RowParser Int
forall a. FromField a =&gt; RowParser a
</span><span class="hs-identifier hs-var">DB.field</span></span><span> </span><span>
</span><span id="line-116"></span><span>
</span><span id="line-117"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DB.FromRow</span></span><span> </span><span class="annot"><a href="Imageboard.Types.html#BoardInfo"><span class="hs-identifier hs-type">BoardInfo</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-118"></span><span>    </span><span id="local-6989586621679159248"><span class="annot"><span class="annottext">fromRow :: RowParser BoardInfo
</span><a href="#local-6989586621679159248"><span class="hs-identifier hs-var hs-var hs-var hs-var">fromRow</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text -&gt; BoardInfo
</span><a href="Imageboard.Types.html#BoardInfo"><span class="hs-identifier hs-var">BoardInfo</span></a></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; Text -&gt; Text -&gt; BoardInfo)
-&gt; RowParser Text -&gt; RowParser (Text -&gt; Text -&gt; BoardInfo)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">RowParser Text
forall a. FromField a =&gt; RowParser a
</span><span class="hs-identifier hs-var">DB.field</span></span><span> </span><span class="annot"><span class="annottext">RowParser (Text -&gt; Text -&gt; BoardInfo)
-&gt; RowParser Text -&gt; RowParser (Text -&gt; BoardInfo)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">RowParser Text
forall a. FromField a =&gt; RowParser a
</span><span class="hs-identifier hs-var">DB.field</span></span><span> </span><span class="annot"><span class="annottext">RowParser (Text -&gt; BoardInfo)
-&gt; RowParser Text -&gt; RowParser BoardInfo
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">RowParser Text
forall a. FromField a =&gt; RowParser a
</span><span class="hs-identifier hs-var">DB.field</span></span><span> </span><span>
</span><span id="line-119"></span><span>
</span><span id="line-120"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DB.FromRow</span></span><span> </span><span class="annot"><a href="Imageboard.Types.html#AccountInfo"><span class="hs-identifier hs-type">AccountInfo</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-121"></span><span>    </span><span id="local-6989586621679159245"><span class="annot"><span class="annottext">fromRow :: RowParser AccountInfo
</span><a href="#local-6989586621679159245"><span class="hs-identifier hs-var hs-var hs-var hs-var">fromRow</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text -&gt; UTCTime -&gt; Role -&gt; AccountInfo
</span><a href="Imageboard.Types.html#AccountInfo"><span class="hs-identifier hs-var">AccountInfo</span></a></span><span> </span><span>
</span><span id="line-122"></span><span>                </span><span class="annot"><span class="annottext">(Text -&gt; UTCTime -&gt; Role -&gt; AccountInfo)
-&gt; RowParser Text -&gt; RowParser (UTCTime -&gt; Role -&gt; AccountInfo)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">RowParser Text
forall a. FromField a =&gt; RowParser a
</span><span class="hs-identifier hs-var">DB.field</span></span><span> </span><span>
</span><span id="line-123"></span><span>                </span><span class="annot"><span class="annottext">RowParser (UTCTime -&gt; Role -&gt; AccountInfo)
-&gt; RowParser UTCTime -&gt; RowParser (Role -&gt; AccountInfo)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">FieldParser UTCTime -&gt; RowParser UTCTime
forall a. FieldParser a -&gt; RowParser a
</span><span class="hs-identifier hs-var">DB.fieldWith</span></span><span> </span><span class="annot"><span class="annottext">FieldParser UTCTime
</span><a href="Imageboard.Database.html#parseDate"><span class="hs-identifier hs-var">parseDate</span></a></span><span>
</span><span id="line-124"></span><span>                </span><span class="annot"><span class="annottext">RowParser (Role -&gt; AccountInfo)
-&gt; RowParser Role -&gt; RowParser AccountInfo
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Role
forall a. Enum a =&gt; Int -&gt; a
</span><span class="hs-identifier hs-var">toEnum</span></span><span> </span><span class="annot"><span class="annottext">(Int -&gt; Role) -&gt; RowParser Int -&gt; RowParser Role
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">RowParser Int
forall a. FromField a =&gt; RowParser a
</span><span class="hs-identifier hs-var">DB.field</span></span><span class="hs-special">)</span><span> </span><span>
</span><span id="line-125"></span><span>
</span><span id="line-126"></span><span class="hs-comment">-- | Create sqlite3 database file using schema file.</span><span>
</span><span id="line-127"></span><span class="annot"><a href="Imageboard.Database.html#setupDb"><span class="hs-identifier hs-type">setupDb</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-128"></span><span id="setupDb"><span class="annot"><span class="annottext">setupDb :: IO ()
</span><a href="Imageboard.Database.html#setupDb"><span class="hs-identifier hs-var hs-var">setupDb</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-129"></span><span>    </span><span id="local-6989586621679159243"><span class="annot"><span class="annottext">Database
</span><a href="#local-6989586621679159243"><span class="hs-identifier hs-var">conn</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Text -&gt; IO Database
</span><span class="hs-identifier hs-var">DirectDB.open</span></span><span> </span><span class="annot"><span class="annottext">Text
forall a. IsString a =&gt; a
</span><a href="Imageboard.Config.html#postsDb"><span class="hs-identifier hs-var">Config.postsDb</span></a></span><span>
</span><span id="line-130"></span><span>    </span><span id="local-6989586621679159241"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679159241"><span class="hs-identifier hs-var">schema</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; IO Text
</span><span class="hs-identifier hs-var">T.readFile</span></span><span> </span><span class="annot"><span class="annottext">String
forall a. IsString a =&gt; a
</span><a href="Imageboard.Config.html#schemaFile"><span class="hs-identifier hs-var">Config.schemaFile</span></a></span><span>
</span><span id="line-131"></span><span>    </span><span class="annot"><span class="annottext">Database -&gt; Text -&gt; IO ()
</span><span class="hs-identifier hs-var">DirectDB.exec</span></span><span> </span><span class="annot"><span class="annottext">Database
</span><a href="#local-6989586621679159243"><span class="hs-identifier hs-var">conn</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679159241"><span class="hs-identifier hs-var">schema</span></a></span><span>
</span><span id="line-132"></span><span>    </span><span class="hs-comment">-- Insert default admin account.</span><span>
</span><span id="line-133"></span><span>    </span><span id="local-6989586621679159238"><span class="annot"><span class="annottext">PasswordHash Bcrypt
</span><a href="#local-6989586621679159238"><span class="hs-identifier hs-var">hash</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Password -&gt; IO (PasswordHash Bcrypt)
forall (m :: * -&gt; *).
MonadIO m =&gt;
Password -&gt; m (PasswordHash Bcrypt)
</span><span class="hs-identifier hs-var">P.hashPassword</span></span><span> </span><span class="annot"><span class="hs-string">&quot;password&quot;</span></span><span>
</span><span id="line-134"></span><span>    </span><span class="annot"><span class="annottext">Connection -&gt; Query -&gt; [NamedParam] -&gt; IO ()
</span><span class="hs-identifier hs-var">DB.executeNamed</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Database -&gt; Connection
</span><span class="hs-identifier hs-var">DB.Connection</span></span><span> </span><span class="annot"><span class="annottext">Database
</span><a href="#local-6989586621679159243"><span class="hs-identifier hs-var">conn</span></a></span><span class="hs-special">)</span><span>   </span><span>
</span><span id="line-135"></span><span>        </span><span class="annot"><span class="hs-string">&quot;INSERT OR IGNORE INTO Accounts (Username, Password, Role) \
        \VALUES (:user, :hash, 0)&quot;</span></span><span>
</span><span id="line-137"></span><span>        </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="hs-string">&quot;:user&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; NamedParam
forall v. ToField v =&gt; Text -&gt; v -&gt; NamedParam
</span><span class="hs-operator hs-var">:=</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-string">&quot;admin&quot;</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span class="hs-special">)</span><span>
</span><span id="line-138"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-string">&quot;:hash&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; NamedParam
forall v. ToField v =&gt; Text -&gt; v -&gt; NamedParam
</span><span class="hs-operator hs-var">:=</span></span><span> </span><span class="annot"><span class="annottext">PasswordHash Bcrypt -&gt; Text
forall a. PasswordHash a -&gt; Text
</span><span class="hs-identifier hs-var hs-var">unPasswordHash</span></span><span> </span><span class="annot"><span class="annottext">PasswordHash Bcrypt
</span><a href="#local-6989586621679159238"><span class="hs-identifier hs-var">hash</span></a></span><span class="hs-special">]</span><span> </span><span>
</span><span id="line-139"></span><span>    </span><span class="annot"><span class="annottext">Database -&gt; IO ()
</span><span class="hs-identifier hs-var">DirectDB.close</span></span><span> </span><span class="annot"><span class="annottext">Database
</span><a href="#local-6989586621679159243"><span class="hs-identifier hs-var">conn</span></a></span><span>
</span><span id="line-140"></span><span>
</span><span id="line-141"></span><span id="local-6989586621679159361"><span class="annot"><a href="Imageboard.Database.html#runDb"><span class="hs-identifier hs-type">runDb</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">DB.Connection</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621679159361"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621679159361"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span>
</span><span id="line-142"></span><span id="runDb"><span class="annot"><span class="annottext">runDb :: (Connection -&gt; IO a) -&gt; IO a
</span><a href="Imageboard.Database.html#runDb"><span class="hs-identifier hs-var hs-var">runDb</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; (Connection -&gt; IO a) -&gt; IO a
forall a. String -&gt; (Connection -&gt; IO a) -&gt; IO a
</span><span class="hs-identifier hs-var">DB.withConnection</span></span><span> </span><span class="annot"><span class="annottext">String
forall a. IsString a =&gt; a
</span><a href="Imageboard.Config.html#postsDb"><span class="hs-identifier hs-var">Config.postsDb</span></a></span><span>
</span><span id="line-143"></span><span>
</span><span id="line-144"></span><span class="annot"><a href="Imageboard.Database.html#foreignKeyPragma"><span class="hs-identifier hs-type">foreignKeyPragma</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DB.Connection</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-145"></span><span id="foreignKeyPragma"><span class="annot"><span class="annottext">foreignKeyPragma :: Connection -&gt; IO ()
</span><a href="Imageboard.Database.html#foreignKeyPragma"><span class="hs-identifier hs-var hs-var">foreignKeyPragma</span></a></span></span><span> </span><span id="local-6989586621679159231"><span class="annot"><span class="annottext">c :: Connection
</span><a href="#local-6989586621679159231"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Connection -&gt; Query -&gt; IO ()
</span><span class="hs-identifier hs-var">DB.execute_</span></span><span> </span><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621679159231"><span class="hs-identifier hs-var">c</span></a></span><span>   </span><span class="annot"><span class="hs-string">&quot;PRAGMA foreign_keys=1&quot;</span></span><span>
</span><span id="line-146"></span><span>
</span><span id="line-147"></span><span class="hs-comment">-- | Insert file information into database.</span><span>
</span><span id="line-148"></span><span class="annot"><a href="Imageboard.Database.html#insertFile"><span class="hs-identifier hs-type">insertFile</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Imageboard.Types.html#File"><span class="hs-identifier hs-type">File</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-comment">-- ^ File Id.</span><span>
</span><span id="line-149"></span><span id="insertFile"><span class="annot"><span class="annottext">insertFile :: File -&gt; IO Int
</span><a href="Imageboard.Database.html#insertFile"><span class="hs-identifier hs-var hs-var">insertFile</span></a></span></span><span> </span><span id="local-6989586621679159229"><span class="annot"><span class="annottext">f :: File
</span><a href="#local-6989586621679159229"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Connection -&gt; IO Int) -&gt; IO Int
forall a. (Connection -&gt; IO a) -&gt; IO a
</span><a href="Imageboard.Database.html#runDb"><span class="hs-identifier hs-var">runDb</span></a></span><span> </span><span class="annot"><span class="annottext">((Connection -&gt; IO Int) -&gt; IO Int)
-&gt; (Connection -&gt; IO Int) -&gt; IO Int
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679159228"><span class="annot"><span class="annottext">c :: Connection
</span><a href="#local-6989586621679159228"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-150"></span><span>    </span><span class="annot"><span class="annottext">Connection -&gt; Query -&gt; [NamedParam] -&gt; IO ()
</span><span class="hs-identifier hs-var">DB.executeNamed</span></span><span> </span><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621679159228"><span class="hs-identifier hs-var">c</span></a></span><span>   </span><span class="annot"><span class="hs-string">&quot;INSERT INTO Files (Name, Extension, Size, Width, Height) \
                        \VALUES (:name, :ext, :size, :width, :height)&quot;</span></span><span> </span><span>
</span><span id="line-152"></span><span>                        </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="hs-string">&quot;:name&quot;</span></span><span>   </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; NamedParam
forall v. ToField v =&gt; Text -&gt; v -&gt; NamedParam
</span><span class="hs-operator hs-var">:=</span></span><span> </span><span class="annot"><span class="annottext">File -&gt; Text
</span><a href="Imageboard.Types.html#filename"><span class="hs-identifier hs-var hs-var">filename</span></a></span><span> </span><span class="annot"><span class="annottext">File
</span><a href="#local-6989586621679159229"><span class="hs-identifier hs-var">f</span></a></span><span>
</span><span id="line-153"></span><span>                        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-string">&quot;:ext&quot;</span></span><span>    </span><span class="annot"><span class="annottext">Text -&gt; Int -&gt; NamedParam
forall v. ToField v =&gt; Text -&gt; v -&gt; NamedParam
</span><span class="hs-operator hs-var">:=</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FileType -&gt; Int
forall a. Enum a =&gt; a -&gt; Int
</span><span class="hs-identifier hs-var">fromEnum</span></span><span> </span><span class="annot"><span class="annottext">(FileType -&gt; Int) -&gt; FileType -&gt; Int
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">File -&gt; FileType
</span><a href="Imageboard.Types.html#ext"><span class="hs-identifier hs-var hs-var">ext</span></a></span><span> </span><span class="annot"><span class="annottext">File
</span><a href="#local-6989586621679159229"><span class="hs-identifier hs-var">f</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-154"></span><span>                        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-string">&quot;:size&quot;</span></span><span>   </span><span class="annot"><span class="annottext">Text -&gt; Int -&gt; NamedParam
forall v. ToField v =&gt; Text -&gt; v -&gt; NamedParam
</span><span class="hs-operator hs-var">:=</span></span><span> </span><span class="annot"><span class="annottext">File -&gt; Int
</span><a href="Imageboard.Types.html#size"><span class="hs-identifier hs-var hs-var">size</span></a></span><span> </span><span class="annot"><span class="annottext">File
</span><a href="#local-6989586621679159229"><span class="hs-identifier hs-var">f</span></a></span><span>
</span><span id="line-155"></span><span>                        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-string">&quot;:width&quot;</span></span><span>  </span><span class="annot"><span class="annottext">Text -&gt; Maybe Int -&gt; NamedParam
forall v. ToField v =&gt; Text -&gt; v -&gt; NamedParam
</span><span class="hs-operator hs-var">:=</span></span><span> </span><span class="annot"><span class="annottext">Dimensions -&gt; Int
</span><a href="Imageboard.Types.html#width"><span class="hs-identifier hs-var hs-var">width</span></a></span><span> </span><span class="annot"><span class="annottext">(Dimensions -&gt; Int) -&gt; Maybe Dimensions -&gt; Maybe Int
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">File -&gt; Maybe Dimensions
</span><a href="Imageboard.Types.html#dim"><span class="hs-identifier hs-var hs-var">dim</span></a></span><span> </span><span class="annot"><span class="annottext">File
</span><a href="#local-6989586621679159229"><span class="hs-identifier hs-var">f</span></a></span><span>
</span><span id="line-156"></span><span>                        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-string">&quot;:height&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Maybe Int -&gt; NamedParam
forall v. ToField v =&gt; Text -&gt; v -&gt; NamedParam
</span><span class="hs-operator hs-var">:=</span></span><span> </span><span class="annot"><span class="annottext">Dimensions -&gt; Int
</span><a href="Imageboard.Types.html#height"><span class="hs-identifier hs-var hs-var">height</span></a></span><span> </span><span class="annot"><span class="annottext">(Dimensions -&gt; Int) -&gt; Maybe Dimensions -&gt; Maybe Int
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">File -&gt; Maybe Dimensions
</span><a href="Imageboard.Types.html#dim"><span class="hs-identifier hs-var hs-var">dim</span></a></span><span> </span><span class="annot"><span class="annottext">File
</span><a href="#local-6989586621679159229"><span class="hs-identifier hs-var">f</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-157"></span><span>    </span><span class="annot"><span class="annottext">Int64 -&gt; Int
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">(Int64 -&gt; Int) -&gt; IO Int64 -&gt; IO Int
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Connection -&gt; IO Int64
</span><span class="hs-identifier hs-var">DB.lastInsertRowId</span></span><span> </span><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621679159228"><span class="hs-identifier hs-var">c</span></a></span><span>
</span><span id="line-158"></span><span>
</span><span id="line-159"></span><span class="hs-comment">-- | Insert post with no file attached into database.</span><span>
</span><span id="line-160"></span><span class="annot"><a href="Imageboard.Database.html#insertPost"><span class="hs-identifier hs-type">insertPost</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Imageboard.Types.html#Board"><span class="hs-identifier hs-type">Board</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Imageboard.Types.html#PostStub"><span class="hs-identifier hs-type">PostStub</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span>
</span><span id="line-161"></span><span id="insertPost"><span class="annot"><span class="annottext">insertPost :: Text -&gt; Int -&gt; PostStub -&gt; IO ()
</span><a href="Imageboard.Database.html#insertPost"><span class="hs-identifier hs-var hs-var">insertPost</span></a></span></span><span> </span><span id="local-6989586621679159218"><span class="annot"><span class="annottext">b :: Text
</span><a href="#local-6989586621679159218"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span id="local-6989586621679159217"><span class="annot"><span class="annottext">p :: Int
</span><a href="#local-6989586621679159217"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span id="local-6989586621679159216"><span class="annot"><span class="annottext">s :: PostStub
</span><a href="#local-6989586621679159216"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Connection -&gt; IO ()) -&gt; IO ()
forall a. (Connection -&gt; IO a) -&gt; IO a
</span><a href="Imageboard.Database.html#runDb"><span class="hs-identifier hs-var">runDb</span></a></span><span> </span><span class="annot"><span class="annottext">((Connection -&gt; IO ()) -&gt; IO ()) -&gt; (Connection -&gt; IO ()) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679159215"><span class="annot"><span class="annottext">c :: Connection
</span><a href="#local-6989586621679159215"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Connection -&gt; IO () -&gt; IO ()
forall a. Connection -&gt; IO a -&gt; IO a
</span><span class="hs-identifier hs-var">DB.withTransaction</span></span><span> </span><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621679159215"><span class="hs-identifier hs-var">c</span></a></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-162"></span><span>    </span><span class="annot"><span class="annottext">Connection -&gt; Query -&gt; [NamedParam] -&gt; IO ()
</span><span class="hs-identifier hs-var">DB.executeNamed</span></span><span> </span><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621679159215"><span class="hs-identifier hs-var">c</span></a></span><span>   </span><span class="annot"><span class="hs-string">&quot;INSERT INTO Posts (Name, Email, Subject, Text, Parent, Board) \
                        \VALUES (:name, :email, :subject, :text, :parent, :board)&quot;</span></span><span> </span><span>
</span><span id="line-164"></span><span>                        </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="hs-string">&quot;:name&quot;</span></span><span>       </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; NamedParam
forall v. ToField v =&gt; Text -&gt; v -&gt; NamedParam
</span><span class="hs-operator hs-var">:=</span></span><span> </span><span class="annot"><span class="annottext">PostStub -&gt; Text
</span><a href="Imageboard.Types.html#author"><span class="hs-identifier hs-var hs-var">author</span></a></span><span> </span><span class="annot"><span class="annottext">PostStub
</span><a href="#local-6989586621679159216"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-165"></span><span>                        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-string">&quot;:email&quot;</span></span><span>      </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; NamedParam
forall v. ToField v =&gt; Text -&gt; v -&gt; NamedParam
</span><span class="hs-operator hs-var">:=</span></span><span> </span><span class="annot"><span class="annottext">PostStub -&gt; Text
</span><a href="Imageboard.Types.html#email"><span class="hs-identifier hs-var hs-var">email</span></a></span><span> </span><span class="annot"><span class="annottext">PostStub
</span><a href="#local-6989586621679159216"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-166"></span><span>                        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-string">&quot;:subject&quot;</span></span><span>    </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; NamedParam
forall v. ToField v =&gt; Text -&gt; v -&gt; NamedParam
</span><span class="hs-operator hs-var">:=</span></span><span> </span><span class="annot"><span class="annottext">PostStub -&gt; Text
</span><a href="Imageboard.Types.html#subject"><span class="hs-identifier hs-var hs-var">subject</span></a></span><span> </span><span class="annot"><span class="annottext">PostStub
</span><a href="#local-6989586621679159216"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-167"></span><span>                        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-string">&quot;:text&quot;</span></span><span>       </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; NamedParam
forall v. ToField v =&gt; Text -&gt; v -&gt; NamedParam
</span><span class="hs-operator hs-var">:=</span></span><span> </span><span class="annot"><span class="annottext">PostStub -&gt; Text
</span><a href="Imageboard.Types.html#text"><span class="hs-identifier hs-var hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">PostStub
</span><a href="#local-6989586621679159216"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-168"></span><span>                        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-string">&quot;:parent&quot;</span></span><span>     </span><span class="annot"><span class="annottext">Text -&gt; Int -&gt; NamedParam
forall v. ToField v =&gt; Text -&gt; v -&gt; NamedParam
</span><span class="hs-operator hs-var">:=</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679159217"><span class="hs-identifier hs-var">p</span></a></span><span>
</span><span id="line-169"></span><span>                        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-string">&quot;:board&quot;</span></span><span>      </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; NamedParam
forall v. ToField v =&gt; Text -&gt; v -&gt; NamedParam
</span><span class="hs-operator hs-var">:=</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679159218"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-170"></span><span>
</span><span id="line-171"></span><span class="hs-comment">-- | Insert post with file attached, using previously obtained file Id.</span><span>
</span><span id="line-172"></span><span class="annot"><a href="Imageboard.Database.html#insertPostWithFile"><span class="hs-identifier hs-type">insertPostWithFile</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Imageboard.Types.html#Board"><span class="hs-identifier hs-type">Board</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Imageboard.Types.html#PostStub"><span class="hs-identifier hs-type">PostStub</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-comment">-- ^ fileId </span><span>
</span><span id="line-173"></span><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- ^ Post Id.</span><span>
</span><span id="line-174"></span><span id="insertPostWithFile"><span class="annot"><span class="annottext">insertPostWithFile :: Text -&gt; Int -&gt; PostStub -&gt; Int -&gt; IO ()
</span><a href="Imageboard.Database.html#insertPostWithFile"><span class="hs-identifier hs-var hs-var">insertPostWithFile</span></a></span></span><span> </span><span id="local-6989586621679159209"><span class="annot"><span class="annottext">b :: Text
</span><a href="#local-6989586621679159209"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span id="local-6989586621679159208"><span class="annot"><span class="annottext">p :: Int
</span><a href="#local-6989586621679159208"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span id="local-6989586621679159207"><span class="annot"><span class="annottext">s :: PostStub
</span><a href="#local-6989586621679159207"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span id="local-6989586621679159206"><span class="annot"><span class="annottext">f :: Int
</span><a href="#local-6989586621679159206"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Connection -&gt; IO ()) -&gt; IO ()
forall a. (Connection -&gt; IO a) -&gt; IO a
</span><a href="Imageboard.Database.html#runDb"><span class="hs-identifier hs-var">runDb</span></a></span><span> </span><span class="annot"><span class="annottext">((Connection -&gt; IO ()) -&gt; IO ()) -&gt; (Connection -&gt; IO ()) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679159205"><span class="annot"><span class="annottext">c :: Connection
</span><a href="#local-6989586621679159205"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Connection -&gt; IO () -&gt; IO ()
forall a. Connection -&gt; IO a -&gt; IO a
</span><span class="hs-identifier hs-var">DB.withTransaction</span></span><span> </span><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621679159205"><span class="hs-identifier hs-var">c</span></a></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-175"></span><span>    </span><span class="annot"><span class="annottext">Connection -&gt; Query -&gt; [NamedParam] -&gt; IO ()
</span><span class="hs-identifier hs-var">DB.executeNamed</span></span><span> </span><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621679159205"><span class="hs-identifier hs-var">c</span></a></span><span>   </span><span class="annot"><span class="hs-string">&quot;INSERT INTO Posts (Name, Email, Subject, Text, FileId, Parent, Board) \
                        \VALUES (:name, :email, :subject, :text, :fileid, :parent, :board)&quot;</span></span><span> </span><span>
</span><span id="line-177"></span><span>                        </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="hs-string">&quot;:name&quot;</span></span><span>       </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; NamedParam
forall v. ToField v =&gt; Text -&gt; v -&gt; NamedParam
</span><span class="hs-operator hs-var">:=</span></span><span> </span><span class="annot"><span class="annottext">PostStub -&gt; Text
</span><a href="Imageboard.Types.html#author"><span class="hs-identifier hs-var hs-var">author</span></a></span><span> </span><span class="annot"><span class="annottext">PostStub
</span><a href="#local-6989586621679159207"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-178"></span><span>                        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-string">&quot;:email&quot;</span></span><span>      </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; NamedParam
forall v. ToField v =&gt; Text -&gt; v -&gt; NamedParam
</span><span class="hs-operator hs-var">:=</span></span><span> </span><span class="annot"><span class="annottext">PostStub -&gt; Text
</span><a href="Imageboard.Types.html#email"><span class="hs-identifier hs-var hs-var">email</span></a></span><span> </span><span class="annot"><span class="annottext">PostStub
</span><a href="#local-6989586621679159207"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-179"></span><span>                        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-string">&quot;:subject&quot;</span></span><span>    </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; NamedParam
forall v. ToField v =&gt; Text -&gt; v -&gt; NamedParam
</span><span class="hs-operator hs-var">:=</span></span><span> </span><span class="annot"><span class="annottext">PostStub -&gt; Text
</span><a href="Imageboard.Types.html#subject"><span class="hs-identifier hs-var hs-var">subject</span></a></span><span> </span><span class="annot"><span class="annottext">PostStub
</span><a href="#local-6989586621679159207"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-180"></span><span>                        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-string">&quot;:text&quot;</span></span><span>       </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; NamedParam
forall v. ToField v =&gt; Text -&gt; v -&gt; NamedParam
</span><span class="hs-operator hs-var">:=</span></span><span> </span><span class="annot"><span class="annottext">PostStub -&gt; Text
</span><a href="Imageboard.Types.html#text"><span class="hs-identifier hs-var hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">PostStub
</span><a href="#local-6989586621679159207"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-181"></span><span>                        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-string">&quot;:fileid&quot;</span></span><span>     </span><span class="annot"><span class="annottext">Text -&gt; Int -&gt; NamedParam
forall v. ToField v =&gt; Text -&gt; v -&gt; NamedParam
</span><span class="hs-operator hs-var">:=</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679159206"><span class="hs-identifier hs-var">f</span></a></span><span>
</span><span id="line-182"></span><span>                        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-string">&quot;:parent&quot;</span></span><span>     </span><span class="annot"><span class="annottext">Text -&gt; Int -&gt; NamedParam
forall v. ToField v =&gt; Text -&gt; v -&gt; NamedParam
</span><span class="hs-operator hs-var">:=</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679159208"><span class="hs-identifier hs-var">p</span></a></span><span>
</span><span id="line-183"></span><span>                        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-string">&quot;:board&quot;</span></span><span>      </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; NamedParam
forall v. ToField v =&gt; Text -&gt; v -&gt; NamedParam
</span><span class="hs-operator hs-var">:=</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679159209"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-184"></span><span>
</span><span id="line-185"></span><span class="hs-comment">-- | Insert new thread with no file attached.</span><span>
</span><span id="line-186"></span><span class="annot"><a href="Imageboard.Database.html#insertThread"><span class="hs-identifier hs-type">insertThread</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Imageboard.Types.html#Board"><span class="hs-identifier hs-type">Board</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Imageboard.Types.html#PostStub"><span class="hs-identifier hs-type">PostStub</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-187"></span><span id="insertThread"><span class="annot"><span class="annottext">insertThread :: Text -&gt; PostStub -&gt; IO ()
</span><a href="Imageboard.Database.html#insertThread"><span class="hs-identifier hs-var hs-var">insertThread</span></a></span></span><span> </span><span id="local-6989586621679159204"><span class="annot"><span class="annottext">b :: Text
</span><a href="#local-6989586621679159204"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span id="local-6989586621679159203"><span class="annot"><span class="annottext">s :: PostStub
</span><a href="#local-6989586621679159203"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Connection -&gt; IO ()) -&gt; IO ()
forall a. (Connection -&gt; IO a) -&gt; IO a
</span><a href="Imageboard.Database.html#runDb"><span class="hs-identifier hs-var">runDb</span></a></span><span> </span><span class="annot"><span class="annottext">((Connection -&gt; IO ()) -&gt; IO ()) -&gt; (Connection -&gt; IO ()) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679159202"><span class="annot"><span class="annottext">c :: Connection
</span><a href="#local-6989586621679159202"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Connection -&gt; IO () -&gt; IO ()
forall a. Connection -&gt; IO a -&gt; IO a
</span><span class="hs-identifier hs-var">DB.withTransaction</span></span><span> </span><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621679159202"><span class="hs-identifier hs-var">c</span></a></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-188"></span><span>    </span><span class="annot"><span class="annottext">Connection -&gt; Query -&gt; [NamedParam] -&gt; IO ()
</span><span class="hs-identifier hs-var">DB.executeNamed</span></span><span> </span><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621679159202"><span class="hs-identifier hs-var">c</span></a></span><span>   </span><span class="annot"><span class="hs-string">&quot;INSERT INTO Posts (Name, Email, Subject, Text, Board, \
                        \LastBump, Sticky, Lock, Autosage, Cycle, ReplyCount) \
                        \VALUES (:name, :email, :subject, :text, :board, \
                        \0, 0, 0, 0, 0, 0)&quot;</span></span><span> </span><span>
</span><span id="line-192"></span><span>                        </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="hs-string">&quot;:name&quot;</span></span><span>       </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; NamedParam
forall v. ToField v =&gt; Text -&gt; v -&gt; NamedParam
</span><span class="hs-operator hs-var">:=</span></span><span> </span><span class="annot"><span class="annottext">PostStub -&gt; Text
</span><a href="Imageboard.Types.html#author"><span class="hs-identifier hs-var hs-var">author</span></a></span><span> </span><span class="annot"><span class="annottext">PostStub
</span><a href="#local-6989586621679159203"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-193"></span><span>                        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-string">&quot;:email&quot;</span></span><span>      </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; NamedParam
forall v. ToField v =&gt; Text -&gt; v -&gt; NamedParam
</span><span class="hs-operator hs-var">:=</span></span><span> </span><span class="annot"><span class="annottext">PostStub -&gt; Text
</span><a href="Imageboard.Types.html#email"><span class="hs-identifier hs-var hs-var">email</span></a></span><span> </span><span class="annot"><span class="annottext">PostStub
</span><a href="#local-6989586621679159203"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-194"></span><span>                        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-string">&quot;:subject&quot;</span></span><span>    </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; NamedParam
forall v. ToField v =&gt; Text -&gt; v -&gt; NamedParam
</span><span class="hs-operator hs-var">:=</span></span><span> </span><span class="annot"><span class="annottext">PostStub -&gt; Text
</span><a href="Imageboard.Types.html#subject"><span class="hs-identifier hs-var hs-var">subject</span></a></span><span> </span><span class="annot"><span class="annottext">PostStub
</span><a href="#local-6989586621679159203"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-195"></span><span>                        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-string">&quot;:text&quot;</span></span><span>       </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; NamedParam
forall v. ToField v =&gt; Text -&gt; v -&gt; NamedParam
</span><span class="hs-operator hs-var">:=</span></span><span> </span><span class="annot"><span class="annottext">PostStub -&gt; Text
</span><a href="Imageboard.Types.html#text"><span class="hs-identifier hs-var hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">PostStub
</span><a href="#local-6989586621679159203"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-196"></span><span>                        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-string">&quot;:board&quot;</span></span><span>      </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; NamedParam
forall v. ToField v =&gt; Text -&gt; v -&gt; NamedParam
</span><span class="hs-operator hs-var">:=</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679159204"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-197"></span><span>
</span><span id="line-198"></span><span class="hs-comment">-- | Insert post with file attached, using previously obtained file Id.</span><span>
</span><span id="line-199"></span><span class="annot"><a href="Imageboard.Database.html#insertThreadWithFile"><span class="hs-identifier hs-type">insertThreadWithFile</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Imageboard.Types.html#Board"><span class="hs-identifier hs-type">Board</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Imageboard.Types.html#PostStub"><span class="hs-identifier hs-type">PostStub</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-200"></span><span id="insertThreadWithFile"><span class="annot"><span class="annottext">insertThreadWithFile :: Text -&gt; PostStub -&gt; Int -&gt; IO ()
</span><a href="Imageboard.Database.html#insertThreadWithFile"><span class="hs-identifier hs-var hs-var">insertThreadWithFile</span></a></span></span><span> </span><span id="local-6989586621679159201"><span class="annot"><span class="annottext">b :: Text
</span><a href="#local-6989586621679159201"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span id="local-6989586621679159200"><span class="annot"><span class="annottext">s :: PostStub
</span><a href="#local-6989586621679159200"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span id="local-6989586621679159199"><span class="annot"><span class="annottext">f :: Int
</span><a href="#local-6989586621679159199"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Connection -&gt; IO ()) -&gt; IO ()
forall a. (Connection -&gt; IO a) -&gt; IO a
</span><a href="Imageboard.Database.html#runDb"><span class="hs-identifier hs-var">runDb</span></a></span><span> </span><span class="annot"><span class="annottext">((Connection -&gt; IO ()) -&gt; IO ()) -&gt; (Connection -&gt; IO ()) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679159198"><span class="annot"><span class="annottext">c :: Connection
</span><a href="#local-6989586621679159198"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Connection -&gt; IO () -&gt; IO ()
forall a. Connection -&gt; IO a -&gt; IO a
</span><span class="hs-identifier hs-var">DB.withTransaction</span></span><span> </span><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621679159198"><span class="hs-identifier hs-var">c</span></a></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-201"></span><span>    </span><span class="annot"><span class="annottext">Connection -&gt; Query -&gt; [NamedParam] -&gt; IO ()
</span><span class="hs-identifier hs-var">DB.executeNamed</span></span><span> </span><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621679159198"><span class="hs-identifier hs-var">c</span></a></span><span>   </span><span class="annot"><span class="hs-string">&quot;INSERT INTO Posts (Name, Email, Subject, Text, FileId, Board, \
                        \LastBump, Sticky, Lock, Autosage, Cycle, ReplyCount) \
                        \VALUES (:name, :email, :subject, :text, :fileid, :board, \
                        \0, 0, 0, 0, 0, 0)&quot;</span></span><span>  </span><span>
</span><span id="line-205"></span><span>                        </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="hs-string">&quot;:name&quot;</span></span><span>       </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; NamedParam
forall v. ToField v =&gt; Text -&gt; v -&gt; NamedParam
</span><span class="hs-operator hs-var">:=</span></span><span> </span><span class="annot"><span class="annottext">PostStub -&gt; Text
</span><a href="Imageboard.Types.html#author"><span class="hs-identifier hs-var hs-var">author</span></a></span><span> </span><span class="annot"><span class="annottext">PostStub
</span><a href="#local-6989586621679159200"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-206"></span><span>                        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-string">&quot;:email&quot;</span></span><span>      </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; NamedParam
forall v. ToField v =&gt; Text -&gt; v -&gt; NamedParam
</span><span class="hs-operator hs-var">:=</span></span><span> </span><span class="annot"><span class="annottext">PostStub -&gt; Text
</span><a href="Imageboard.Types.html#email"><span class="hs-identifier hs-var hs-var">email</span></a></span><span> </span><span class="annot"><span class="annottext">PostStub
</span><a href="#local-6989586621679159200"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-207"></span><span>                        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-string">&quot;:subject&quot;</span></span><span>    </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; NamedParam
forall v. ToField v =&gt; Text -&gt; v -&gt; NamedParam
</span><span class="hs-operator hs-var">:=</span></span><span> </span><span class="annot"><span class="annottext">PostStub -&gt; Text
</span><a href="Imageboard.Types.html#subject"><span class="hs-identifier hs-var hs-var">subject</span></a></span><span> </span><span class="annot"><span class="annottext">PostStub
</span><a href="#local-6989586621679159200"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-208"></span><span>                        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-string">&quot;:text&quot;</span></span><span>       </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; NamedParam
forall v. ToField v =&gt; Text -&gt; v -&gt; NamedParam
</span><span class="hs-operator hs-var">:=</span></span><span> </span><span class="annot"><span class="annottext">PostStub -&gt; Text
</span><a href="Imageboard.Types.html#text"><span class="hs-identifier hs-var hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">PostStub
</span><a href="#local-6989586621679159200"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-209"></span><span>                        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-string">&quot;:fileid&quot;</span></span><span>     </span><span class="annot"><span class="annottext">Text -&gt; Int -&gt; NamedParam
forall v. ToField v =&gt; Text -&gt; v -&gt; NamedParam
</span><span class="hs-operator hs-var">:=</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679159199"><span class="hs-identifier hs-var">f</span></a></span><span>
</span><span id="line-210"></span><span>                        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-string">&quot;:board&quot;</span></span><span>      </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; NamedParam
forall v. ToField v =&gt; Text -&gt; v -&gt; NamedParam
</span><span class="hs-operator hs-var">:=</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679159201"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-211"></span><span>
</span><span id="line-212"></span><span class="hs-comment">-- | Obtain ID of previously inserted file.</span><span>
</span><span id="line-213"></span><span class="annot"><a href="Imageboard.Database.html#getFileId"><span class="hs-identifier hs-type">getFileId</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span> </span><span class="hs-comment">-- ^ Filename</span><span>
</span><span id="line-214"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- ^ File Id, if given filename exists in database.</span><span>
</span><span id="line-215"></span><span id="getFileId"><span class="annot"><span class="annottext">getFileId :: Text -&gt; IO (Maybe Int)
</span><a href="Imageboard.Database.html#getFileId"><span class="hs-identifier hs-var hs-var">getFileId</span></a></span></span><span> </span><span id="local-6989586621679159197"><span class="annot"><span class="annottext">f :: Text
</span><a href="#local-6989586621679159197"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Connection -&gt; IO (Maybe Int)) -&gt; IO (Maybe Int)
forall a. (Connection -&gt; IO a) -&gt; IO a
</span><a href="Imageboard.Database.html#runDb"><span class="hs-identifier hs-var">runDb</span></a></span><span> </span><span class="annot"><span class="annottext">((Connection -&gt; IO (Maybe Int)) -&gt; IO (Maybe Int))
-&gt; (Connection -&gt; IO (Maybe Int)) -&gt; IO (Maybe Int)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679159196"><span class="annot"><span class="annottext">c :: Connection
</span><a href="#local-6989586621679159196"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-216"></span><span>    </span><span class="annot"><span class="annottext">Connection -&gt; Query -&gt; [NamedParam] -&gt; IO [Only Int]
forall r.
FromRow r =&gt;
Connection -&gt; Query -&gt; [NamedParam] -&gt; IO [r]
</span><span class="hs-identifier hs-var">DB.queryNamed</span></span><span> </span><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621679159196"><span class="hs-identifier hs-var">c</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;SELECT Id FROM Files WHERE Name = :name&quot;</span></span><span> </span><span>
</span><span id="line-217"></span><span>                    </span><span class="hs-special">[</span><span class="annot"><span class="hs-string">&quot;:name&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; NamedParam
forall v. ToField v =&gt; Text -&gt; v -&gt; NamedParam
</span><span class="hs-operator hs-var">:=</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679159197"><span class="hs-identifier hs-var">f</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">DB.Only</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">]</span><span>
</span><span id="line-218"></span><span>    </span><span class="annot"><span class="annottext">IO [Only Int]
-&gt; ([Only Int] -&gt; Maybe (Only Int)) -&gt; IO (Maybe (Only Int))
forall (f :: * -&gt; *) a b. Functor f =&gt; f a -&gt; (a -&gt; b) -&gt; f b
</span><span class="hs-operator hs-var">&lt;&amp;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[Only Int] -&gt; Maybe (Only Int)
forall a. [a] -&gt; Maybe a
</span><span class="hs-identifier hs-var">listToMaybe</span></span><span> </span><span class="annot"><span class="annottext">IO (Maybe (Only Int))
-&gt; (Maybe (Only Int) -&gt; Maybe Int) -&gt; IO (Maybe Int)
forall (f :: * -&gt; *) a b. Functor f =&gt; f a -&gt; (a -&gt; b) -&gt; f b
</span><span class="hs-operator hs-var">&lt;&amp;&gt;</span></span><span> </span><span class="annot"><span class="annottext">(Only Int -&gt; Int) -&gt; Maybe (Only Int) -&gt; Maybe Int
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">Only Int -&gt; Int
forall a. Only a -&gt; a
</span><span class="hs-identifier hs-var hs-var">DB.fromOnly</span></span><span>
</span><span id="line-219"></span><span>
</span><span id="line-220"></span><span class="hs-comment">-- | 'getPosts' @n@ returns @n@ most recent posts, from all boards.</span><span>
</span><span id="line-221"></span><span class="annot"><a href="Imageboard.Database.html#getPosts"><span class="hs-identifier hs-type">getPosts</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Imageboard.Types.html#Post"><span class="hs-identifier hs-type">Post</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-222"></span><span id="getPosts"><span class="annot"><span class="annottext">getPosts :: Int -&gt; IO [Post]
</span><a href="Imageboard.Database.html#getPosts"><span class="hs-identifier hs-var hs-var">getPosts</span></a></span></span><span> </span><span id="local-6989586621679159193"><span class="annot"><span class="annottext">n :: Int
</span><a href="#local-6989586621679159193"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Connection -&gt; IO [Post]) -&gt; IO [Post]
forall a. (Connection -&gt; IO a) -&gt; IO a
</span><a href="Imageboard.Database.html#runDb"><span class="hs-identifier hs-var">runDb</span></a></span><span> </span><span class="annot"><span class="annottext">((Connection -&gt; IO [Post]) -&gt; IO [Post])
-&gt; (Connection -&gt; IO [Post]) -&gt; IO [Post]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679159192"><span class="annot"><span class="annottext">c :: Connection
</span><a href="#local-6989586621679159192"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-223"></span><span>    </span><span class="annot"><span class="annottext">Connection -&gt; Query -&gt; [NamedParam] -&gt; IO [Post]
forall r.
FromRow r =&gt;
Connection -&gt; Query -&gt; [NamedParam] -&gt; IO [r]
</span><span class="hs-identifier hs-var">DB.queryNamed</span></span><span> </span><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621679159192"><span class="hs-identifier hs-var">c</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;SELECT * FROM posts_and_files ORDER BY Date DESC LIMIT :n&quot;</span></span><span> </span><span>
</span><span id="line-224"></span><span>                    </span><span class="hs-special">[</span><span class="annot"><span class="hs-string">&quot;:n&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Int -&gt; NamedParam
forall v. ToField v =&gt; Text -&gt; v -&gt; NamedParam
</span><span class="hs-operator hs-var">:=</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679159193"><span class="hs-identifier hs-var">n</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-225"></span><span>
</span><span id="line-226"></span><span class="hs-comment">-- | Get thread by board name and number.</span><span>
</span><span id="line-227"></span><span class="annot"><a href="Imageboard.Database.html#getThread"><span class="hs-identifier hs-type">getThread</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Imageboard.Types.html#Board"><span class="hs-identifier hs-type">Board</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-comment">-- ^ Post number.</span><span>
</span><span id="line-228"></span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="Imageboard.Types.html#Thread"><span class="hs-identifier hs-type">Thread</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-229"></span><span id="getThread"><span class="annot"><span class="annottext">getThread :: Text -&gt; Int -&gt; IO (Maybe Thread)
</span><a href="Imageboard.Database.html#getThread"><span class="hs-identifier hs-var hs-var">getThread</span></a></span></span><span> </span><span id="local-6989586621679159191"><span class="annot"><span class="annottext">b :: Text
</span><a href="#local-6989586621679159191"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span id="local-6989586621679159190"><span class="annot"><span class="annottext">n :: Int
</span><a href="#local-6989586621679159190"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Connection -&gt; IO (Maybe Thread)) -&gt; IO (Maybe Thread)
forall a. (Connection -&gt; IO a) -&gt; IO a
</span><a href="Imageboard.Database.html#runDb"><span class="hs-identifier hs-var">runDb</span></a></span><span> </span><span class="annot"><span class="annottext">((Connection -&gt; IO (Maybe Thread)) -&gt; IO (Maybe Thread))
-&gt; (Connection -&gt; IO (Maybe Thread)) -&gt; IO (Maybe Thread)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679159189"><span class="annot"><span class="annottext">c :: Connection
</span><a href="#local-6989586621679159189"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-230"></span><span>    </span><span id="local-6989586621679159188"><span class="annot"><span class="annottext">[Post :. ThreadInfo]
</span><a href="#local-6989586621679159188"><span class="hs-identifier hs-var">h</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>  </span><span class="annot"><span class="annottext">Connection -&gt; Query -&gt; [NamedParam] -&gt; IO [Post :. ThreadInfo]
forall r.
FromRow r =&gt;
Connection -&gt; Query -&gt; [NamedParam] -&gt; IO [r]
</span><span class="hs-identifier hs-var">DB.queryNamed</span></span><span> </span><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621679159189"><span class="hs-identifier hs-var">c</span></a></span><span>   </span><span class="annot"><span class="hs-string">&quot;SELECT * FROM threads WHERE Number = :number AND Board = :board&quot;</span></span><span> </span><span>
</span><span id="line-231"></span><span>                            </span><span class="hs-special">[</span><span class="annot"><span class="hs-string">&quot;:number&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Int -&gt; NamedParam
forall v. ToField v =&gt; Text -&gt; v -&gt; NamedParam
</span><span class="hs-operator hs-var">:=</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679159190"><span class="hs-identifier hs-var">n</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-string">&quot;:board&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; NamedParam
forall v. ToField v =&gt; Text -&gt; v -&gt; NamedParam
</span><span class="hs-operator hs-var">:=</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679159191"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-232"></span><span>    </span><span id="local-6989586621679159187"><span class="annot"><span class="annottext">[Post]
</span><a href="#local-6989586621679159187"><span class="hs-identifier hs-var">ps</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Connection -&gt; Query -&gt; [NamedParam] -&gt; IO [Post]
forall r.
FromRow r =&gt;
Connection -&gt; Query -&gt; [NamedParam] -&gt; IO [r]
</span><span class="hs-identifier hs-var">DB.queryNamed</span></span><span> </span><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621679159189"><span class="hs-identifier hs-var">c</span></a></span><span>   </span><span class="annot"><span class="hs-string">&quot;SELECT * FROM posts_and_files WHERE Parent = :number \
                            \AND Board = :board ORDER BY Number ASC&quot;</span></span><span>
</span><span id="line-234"></span><span>                            </span><span class="hs-special">[</span><span class="annot"><span class="hs-string">&quot;:number&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Int -&gt; NamedParam
forall v. ToField v =&gt; Text -&gt; v -&gt; NamedParam
</span><span class="hs-operator hs-var">:=</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679159190"><span class="hs-identifier hs-var">n</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-string">&quot;:board&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; NamedParam
forall v. ToField v =&gt; Text -&gt; v -&gt; NamedParam
</span><span class="hs-operator hs-var">:=</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679159191"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">]</span><span> </span><span>
</span><span id="line-235"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">[Post :. ThreadInfo]
</span><a href="#local-6989586621679159188"><span class="hs-identifier hs-var">h</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-236"></span><span>        </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe Thread -&gt; IO (Maybe Thread)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Maybe Thread -&gt; IO (Maybe Thread))
-&gt; Maybe Thread -&gt; IO (Maybe Thread)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Maybe Thread
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-237"></span><span>        </span><span id="local-6989586621679159186"><span class="annot"><span class="annottext">x :: Post :. ThreadInfo
</span><a href="#local-6989586621679159186"><span class="hs-identifier hs-var">x</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe Thread -&gt; IO (Maybe Thread)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Maybe Thread -&gt; IO (Maybe Thread))
-&gt; Maybe Thread -&gt; IO (Maybe Thread)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Thread -&gt; Maybe Thread
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(Thread -&gt; Maybe Thread) -&gt; Thread -&gt; Maybe Thread
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ThreadHead -&gt; [Post] -&gt; Thread
</span><a href="Imageboard.Types.html#Thread"><span class="hs-identifier hs-var">Thread</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Post :. ThreadInfo) -&gt; ThreadHead
</span><a href="Imageboard.Database.html#mkThreadHead"><span class="hs-identifier hs-var">mkThreadHead</span></a></span><span> </span><span class="annot"><span class="annottext">Post :. ThreadInfo
</span><a href="#local-6989586621679159186"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Post]
</span><a href="#local-6989586621679159187"><span class="hs-identifier hs-var">ps</span></a></span><span>
</span><span id="line-238"></span><span>
</span><span id="line-239"></span><span class="hs-comment">-- | Check if thread with given number exists on given board. </span><span>
</span><span id="line-240"></span><span class="annot"><a href="Imageboard.Database.html#checkThread"><span class="hs-identifier hs-type">checkThread</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Imageboard.Types.html#Board"><span class="hs-identifier hs-type">Board</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-241"></span><span id="checkThread"><span class="annot"><span class="annottext">checkThread :: Text -&gt; Int -&gt; IO Bool
</span><a href="Imageboard.Database.html#checkThread"><span class="hs-identifier hs-var hs-var">checkThread</span></a></span></span><span> </span><span id="local-6989586621679159184"><span class="annot"><span class="annottext">b :: Text
</span><a href="#local-6989586621679159184"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span id="local-6989586621679159183"><span class="annot"><span class="annottext">n :: Int
</span><a href="#local-6989586621679159183"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Connection -&gt; IO Bool) -&gt; IO Bool
forall a. (Connection -&gt; IO a) -&gt; IO a
</span><a href="Imageboard.Database.html#runDb"><span class="hs-identifier hs-var">runDb</span></a></span><span> </span><span class="annot"><span class="annottext">((Connection -&gt; IO Bool) -&gt; IO Bool)
-&gt; (Connection -&gt; IO Bool) -&gt; IO Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679159182"><span class="annot"><span class="annottext">c :: Connection
</span><a href="#local-6989586621679159182"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-242"></span><span>    </span><span class="annot"><span class="annottext">Connection -&gt; Query -&gt; [NamedParam] -&gt; IO [Only Bool]
forall r.
FromRow r =&gt;
Connection -&gt; Query -&gt; [NamedParam] -&gt; IO [r]
</span><span class="hs-identifier hs-var">DB.queryNamed</span></span><span> </span><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621679159182"><span class="hs-identifier hs-var">c</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;SELECT EXISTS\
                    \(SELECT 1 FROM threads WHERE Number = :number AND Board = :board)&quot;</span></span><span> </span><span>
</span><span id="line-244"></span><span>                    </span><span class="hs-special">[</span><span class="annot"><span class="hs-string">&quot;:number&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Int -&gt; NamedParam
forall v. ToField v =&gt; Text -&gt; v -&gt; NamedParam
</span><span class="hs-operator hs-var">:=</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679159183"><span class="hs-identifier hs-var">n</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-string">&quot;:board&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; NamedParam
forall v. ToField v =&gt; Text -&gt; v -&gt; NamedParam
</span><span class="hs-operator hs-var">:=</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679159184"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">DB.Only</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span class="hs-special">]</span><span>
</span><span id="line-245"></span><span>    </span><span class="annot"><span class="annottext">IO [Only Bool] -&gt; ([Only Bool] -&gt; Bool) -&gt; IO Bool
forall (f :: * -&gt; *) a b. Functor f =&gt; f a -&gt; (a -&gt; b) -&gt; f b
</span><span class="hs-operator hs-var">&lt;&amp;&gt;</span></span><span> </span><span class="annot"><span class="annottext">(Only Bool -&gt; Bool) -&gt; [Only Bool] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">any</span></span><span> </span><span class="annot"><span class="annottext">Only Bool -&gt; Bool
forall a. Only a -&gt; a
</span><span class="hs-identifier hs-var hs-var">DB.fromOnly</span></span><span>
</span><span id="line-246"></span><span>
</span><span id="line-247"></span><span class="hs-comment">-- | Get thread information by board name and number. </span><span>
</span><span id="line-248"></span><span class="annot"><a href="Imageboard.Database.html#getThreadInfo"><span class="hs-identifier hs-type">getThreadInfo</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Imageboard.Types.html#Board"><span class="hs-identifier hs-type">Board</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="Imageboard.Types.html#ThreadInfo"><span class="hs-identifier hs-type">ThreadInfo</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-249"></span><span id="getThreadInfo"><span class="annot"><span class="annottext">getThreadInfo :: Text -&gt; Int -&gt; IO (Maybe ThreadInfo)
</span><a href="Imageboard.Database.html#getThreadInfo"><span class="hs-identifier hs-var hs-var">getThreadInfo</span></a></span></span><span> </span><span id="local-6989586621679159180"><span class="annot"><span class="annottext">b :: Text
</span><a href="#local-6989586621679159180"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span id="local-6989586621679159179"><span class="annot"><span class="annottext">n :: Int
</span><a href="#local-6989586621679159179"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Connection -&gt; IO (Maybe ThreadInfo)) -&gt; IO (Maybe ThreadInfo)
forall a. (Connection -&gt; IO a) -&gt; IO a
</span><a href="Imageboard.Database.html#runDb"><span class="hs-identifier hs-var">runDb</span></a></span><span> </span><span class="annot"><span class="annottext">((Connection -&gt; IO (Maybe ThreadInfo)) -&gt; IO (Maybe ThreadInfo))
-&gt; (Connection -&gt; IO (Maybe ThreadInfo)) -&gt; IO (Maybe ThreadInfo)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679159178"><span class="annot"><span class="annottext">c :: Connection
</span><a href="#local-6989586621679159178"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-250"></span><span>    </span><span class="annot"><span class="annottext">Connection -&gt; Query -&gt; [NamedParam] -&gt; IO [ThreadInfo]
forall r.
FromRow r =&gt;
Connection -&gt; Query -&gt; [NamedParam] -&gt; IO [r]
</span><span class="hs-identifier hs-var">DB.queryNamed</span></span><span> </span><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621679159178"><span class="hs-identifier hs-var">c</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;SELECT LastBump, Sticky, Lock, Autosage, Cycle, ReplyCount \
                    \FROM threads WHERE Number = :number AND Board = :board&quot;</span></span><span> </span><span>
</span><span id="line-252"></span><span>                    </span><span class="hs-special">[</span><span class="annot"><span class="hs-string">&quot;:number&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Int -&gt; NamedParam
forall v. ToField v =&gt; Text -&gt; v -&gt; NamedParam
</span><span class="hs-operator hs-var">:=</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679159179"><span class="hs-identifier hs-var">n</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-string">&quot;:board&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; NamedParam
forall v. ToField v =&gt; Text -&gt; v -&gt; NamedParam
</span><span class="hs-operator hs-var">:=</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679159180"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-253"></span><span>    </span><span class="annot"><span class="annottext">IO [ThreadInfo]
-&gt; ([ThreadInfo] -&gt; Maybe ThreadInfo) -&gt; IO (Maybe ThreadInfo)
forall (f :: * -&gt; *) a b. Functor f =&gt; f a -&gt; (a -&gt; b) -&gt; f b
</span><span class="hs-operator hs-var">&lt;&amp;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[ThreadInfo] -&gt; Maybe ThreadInfo
forall a. [a] -&gt; Maybe a
</span><span class="hs-identifier hs-var">listToMaybe</span></span><span>
</span><span id="line-254"></span><span>
</span><span id="line-255"></span><span class="hs-comment">-- | Get all threads from given board.</span><span>
</span><span id="line-256"></span><span class="annot"><a href="Imageboard.Database.html#getThreads"><span class="hs-identifier hs-type">getThreads</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Imageboard.Types.html#Board"><span class="hs-identifier hs-type">Board</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Imageboard.Types.html#ThreadHead"><span class="hs-identifier hs-type">ThreadHead</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-257"></span><span id="getThreads"><span class="annot"><span class="annottext">getThreads :: Text -&gt; IO [ThreadHead]
</span><a href="Imageboard.Database.html#getThreads"><span class="hs-identifier hs-var hs-var">getThreads</span></a></span></span><span> </span><span id="local-6989586621679159177"><span class="annot"><span class="annottext">b :: Text
</span><a href="#local-6989586621679159177"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Connection -&gt; IO [ThreadHead]) -&gt; IO [ThreadHead]
forall a. (Connection -&gt; IO a) -&gt; IO a
</span><a href="Imageboard.Database.html#runDb"><span class="hs-identifier hs-var">runDb</span></a></span><span> </span><span class="annot"><span class="annottext">((Connection -&gt; IO [ThreadHead]) -&gt; IO [ThreadHead])
-&gt; (Connection -&gt; IO [ThreadHead]) -&gt; IO [ThreadHead]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679159176"><span class="annot"><span class="annottext">c :: Connection
</span><a href="#local-6989586621679159176"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-258"></span><span>    </span><span class="annot"><span class="annottext">Connection -&gt; Query -&gt; [NamedParam] -&gt; IO [Post :. ThreadInfo]
forall r.
FromRow r =&gt;
Connection -&gt; Query -&gt; [NamedParam] -&gt; IO [r]
</span><span class="hs-identifier hs-var">DB.queryNamed</span></span><span> </span><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621679159176"><span class="hs-identifier hs-var">c</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;SELECT * FROM threads WHERE Board = :board \
                    \ORDER BY Sticky DESC, LastBump DESC&quot;</span></span><span> </span><span>
</span><span id="line-260"></span><span>                    </span><span class="hs-special">[</span><span class="annot"><span class="hs-string">&quot;:board&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; NamedParam
forall v. ToField v =&gt; Text -&gt; v -&gt; NamedParam
</span><span class="hs-operator hs-var">:=</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679159177"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-261"></span><span>    </span><span class="annot"><span class="annottext">IO [Post :. ThreadInfo]
-&gt; ([Post :. ThreadInfo] -&gt; [ThreadHead]) -&gt; IO [ThreadHead]
forall (f :: * -&gt; *) a b. Functor f =&gt; f a -&gt; (a -&gt; b) -&gt; f b
</span><span class="hs-operator hs-var">&lt;&amp;&gt;</span></span><span> </span><span class="annot"><span class="annottext">((Post :. ThreadInfo) -&gt; ThreadHead)
-&gt; [Post :. ThreadInfo] -&gt; [ThreadHead]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">(Post :. ThreadInfo) -&gt; ThreadHead
</span><a href="Imageboard.Database.html#mkThreadHead"><span class="hs-identifier hs-var">mkThreadHead</span></a></span><span>
</span><span id="line-262"></span><span>
</span><span id="line-263"></span><span class="hs-comment">-- | Get constraints of given board, if it exists.</span><span>
</span><span id="line-264"></span><span class="annot"><a href="Imageboard.Database.html#getConstraints"><span class="hs-identifier hs-type">getConstraints</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Imageboard.Types.html#Board"><span class="hs-identifier hs-type">Board</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="Imageboard.Types.html#BoardConstraints"><span class="hs-identifier hs-type">BoardConstraints</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-265"></span><span id="getConstraints"><span class="annot"><span class="annottext">getConstraints :: Text -&gt; IO (Maybe BoardConstraints)
</span><a href="Imageboard.Database.html#getConstraints"><span class="hs-identifier hs-var hs-var">getConstraints</span></a></span></span><span> </span><span id="local-6989586621679159175"><span class="annot"><span class="annottext">b :: Text
</span><a href="#local-6989586621679159175"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Connection -&gt; IO (Maybe BoardConstraints))
-&gt; IO (Maybe BoardConstraints)
forall a. (Connection -&gt; IO a) -&gt; IO a
</span><a href="Imageboard.Database.html#runDb"><span class="hs-identifier hs-var">runDb</span></a></span><span> </span><span class="annot"><span class="annottext">((Connection -&gt; IO (Maybe BoardConstraints))
 -&gt; IO (Maybe BoardConstraints))
-&gt; (Connection -&gt; IO (Maybe BoardConstraints))
-&gt; IO (Maybe BoardConstraints)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679159174"><span class="annot"><span class="annottext">c :: Connection
</span><a href="#local-6989586621679159174"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-266"></span><span>    </span><span class="annot"><span class="annottext">Connection -&gt; Query -&gt; [NamedParam] -&gt; IO [BoardConstraints]
forall r.
FromRow r =&gt;
Connection -&gt; Query -&gt; [NamedParam] -&gt; IO [r]
</span><span class="hs-identifier hs-var">DB.queryNamed</span></span><span> </span><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621679159174"><span class="hs-identifier hs-var">c</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;SELECT Lock, PostMinLength, PostMaxLength, PostMaxNewlines, \
                    \PostLimit, ThreadLimit FROM Boards WHERE Name = :board&quot;</span></span><span>
</span><span id="line-268"></span><span>                    </span><span class="hs-special">[</span><span class="annot"><span class="hs-string">&quot;:board&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; NamedParam
forall v. ToField v =&gt; Text -&gt; v -&gt; NamedParam
</span><span class="hs-operator hs-var">:=</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679159175"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Imageboard.Types.html#BoardConstraints"><span class="hs-identifier hs-type">BoardConstraints</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-269"></span><span>    </span><span class="annot"><span class="annottext">IO [BoardConstraints]
-&gt; ([BoardConstraints] -&gt; Maybe BoardConstraints)
-&gt; IO (Maybe BoardConstraints)
forall (f :: * -&gt; *) a b. Functor f =&gt; f a -&gt; (a -&gt; b) -&gt; f b
</span><span class="hs-operator hs-var">&lt;&amp;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[BoardConstraints] -&gt; Maybe BoardConstraints
forall a. [a] -&gt; Maybe a
</span><span class="hs-identifier hs-var">listToMaybe</span></span><span>
</span><span id="line-270"></span><span>
</span><span id="line-271"></span><span class="hs-comment">-- | Get names of all existing boards.</span><span>
</span><span id="line-272"></span><span class="annot"><a href="Imageboard.Database.html#getBoardNames"><span class="hs-identifier hs-type">getBoardNames</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Imageboard.Types.html#Board"><span class="hs-identifier hs-type">Board</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-273"></span><span id="getBoardNames"><span class="annot"><span class="annottext">getBoardNames :: IO [Text]
</span><a href="Imageboard.Database.html#getBoardNames"><span class="hs-identifier hs-var hs-var">getBoardNames</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Connection -&gt; IO [Text]) -&gt; IO [Text]
forall a. (Connection -&gt; IO a) -&gt; IO a
</span><a href="Imageboard.Database.html#runDb"><span class="hs-identifier hs-var">runDb</span></a></span><span> </span><span class="annot"><span class="annottext">((Connection -&gt; IO [Text]) -&gt; IO [Text])
-&gt; (Connection -&gt; IO [Text]) -&gt; IO [Text]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679159173"><span class="annot"><span class="annottext">c :: Connection
</span><a href="#local-6989586621679159173"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-274"></span><span>    </span><span class="annot"><span class="annottext">Connection -&gt; Query -&gt; IO [Only Text]
forall r. FromRow r =&gt; Connection -&gt; Query -&gt; IO [r]
</span><span class="hs-identifier hs-var">DB.query_</span></span><span> </span><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621679159173"><span class="hs-identifier hs-var">c</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;SELECT Name From Boards&quot;</span></span><span> </span><span class="annot"><span class="annottext">IO [Only Text] -&gt; ([Only Text] -&gt; [Text]) -&gt; IO [Text]
forall (f :: * -&gt; *) a b. Functor f =&gt; f a -&gt; (a -&gt; b) -&gt; f b
</span><span class="hs-operator hs-var">&lt;&amp;&gt;</span></span><span> </span><span class="annot"><span class="annottext">(Only Text -&gt; Text) -&gt; [Only Text] -&gt; [Text]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Only Text -&gt; Text
forall a. Only a -&gt; a
</span><span class="hs-identifier hs-var hs-var">DB.fromOnly</span></span><span>
</span><span id="line-275"></span><span>
</span><span id="line-276"></span><span class="hs-comment">-- | Get more detailed information for all existing boards.</span><span>
</span><span id="line-277"></span><span class="annot"><a href="Imageboard.Database.html#getBoardInfos"><span class="hs-identifier hs-type">getBoardInfos</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Imageboard.Types.html#BoardInfo"><span class="hs-identifier hs-type">BoardInfo</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-278"></span><span id="getBoardInfos"><span class="annot"><span class="annottext">getBoardInfos :: IO [BoardInfo]
</span><a href="Imageboard.Database.html#getBoardInfos"><span class="hs-identifier hs-var hs-var">getBoardInfos</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Connection -&gt; IO [BoardInfo]) -&gt; IO [BoardInfo]
forall a. (Connection -&gt; IO a) -&gt; IO a
</span><a href="Imageboard.Database.html#runDb"><span class="hs-identifier hs-var">runDb</span></a></span><span> </span><span class="annot"><span class="annottext">((Connection -&gt; IO [BoardInfo]) -&gt; IO [BoardInfo])
-&gt; (Connection -&gt; IO [BoardInfo]) -&gt; IO [BoardInfo]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679159171"><span class="annot"><span class="annottext">c :: Connection
</span><a href="#local-6989586621679159171"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-279"></span><span>    </span><span class="annot"><span class="annottext">Connection -&gt; Query -&gt; IO [BoardInfo]
forall r. FromRow r =&gt; Connection -&gt; Query -&gt; IO [r]
</span><span class="hs-identifier hs-var">DB.query_</span></span><span> </span><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621679159171"><span class="hs-identifier hs-var">c</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;SELECT Name, Title, Subtitle From Boards&quot;</span></span><span>
</span><span id="line-280"></span><span>
</span><span id="line-281"></span><span class="hs-comment">-- | Get more detailed information for given board.</span><span>
</span><span id="line-282"></span><span class="annot"><a href="Imageboard.Database.html#getBoardInfo"><span class="hs-identifier hs-type">getBoardInfo</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Imageboard.Types.html#Board"><span class="hs-identifier hs-type">Board</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="Imageboard.Types.html#BoardInfo"><span class="hs-identifier hs-type">BoardInfo</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-283"></span><span id="getBoardInfo"><span class="annot"><span class="annottext">getBoardInfo :: Text -&gt; IO (Maybe BoardInfo)
</span><a href="Imageboard.Database.html#getBoardInfo"><span class="hs-identifier hs-var hs-var">getBoardInfo</span></a></span></span><span> </span><span id="local-6989586621679159170"><span class="annot"><span class="annottext">b :: Text
</span><a href="#local-6989586621679159170"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Connection -&gt; IO (Maybe BoardInfo)) -&gt; IO (Maybe BoardInfo)
forall a. (Connection -&gt; IO a) -&gt; IO a
</span><a href="Imageboard.Database.html#runDb"><span class="hs-identifier hs-var">runDb</span></a></span><span> </span><span class="annot"><span class="annottext">((Connection -&gt; IO (Maybe BoardInfo)) -&gt; IO (Maybe BoardInfo))
-&gt; (Connection -&gt; IO (Maybe BoardInfo)) -&gt; IO (Maybe BoardInfo)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679159169"><span class="annot"><span class="annottext">c :: Connection
</span><a href="#local-6989586621679159169"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-284"></span><span>    </span><span class="annot"><span class="annottext">Connection -&gt; Query -&gt; [NamedParam] -&gt; IO [BoardInfo]
forall r.
FromRow r =&gt;
Connection -&gt; Query -&gt; [NamedParam] -&gt; IO [r]
</span><span class="hs-identifier hs-var">DB.queryNamed</span></span><span> </span><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621679159169"><span class="hs-identifier hs-var">c</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;SELECT Name, Title, Subtitle FROM Boards WHERE Name = :board&quot;</span></span><span>
</span><span id="line-285"></span><span>                    </span><span class="hs-special">[</span><span class="annot"><span class="hs-string">&quot;:board&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; NamedParam
forall v. ToField v =&gt; Text -&gt; v -&gt; NamedParam
</span><span class="hs-operator hs-var">:=</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679159170"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Imageboard.Types.html#BoardInfo"><span class="hs-identifier hs-type">BoardInfo</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-286"></span><span>    </span><span class="annot"><span class="annottext">IO [BoardInfo]
-&gt; ([BoardInfo] -&gt; Maybe BoardInfo) -&gt; IO (Maybe BoardInfo)
forall (f :: * -&gt; *) a b. Functor f =&gt; f a -&gt; (a -&gt; b) -&gt; f b
</span><span class="hs-operator hs-var">&lt;&amp;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[BoardInfo] -&gt; Maybe BoardInfo
forall a. [a] -&gt; Maybe a
</span><span class="hs-identifier hs-var">listToMaybe</span></span><span>
</span><span id="line-287"></span><span>
</span><span id="line-288"></span><span class="hs-comment">-- | Insert new account into database.</span><span>
</span><span id="line-289"></span><span class="annot"><a href="Imageboard.Database.html#insertAccount"><span class="hs-identifier hs-type">insertAccount</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Imageboard.Types.html#Username"><span class="hs-identifier hs-type">Username</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">PasswordHash</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bcrypt</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Imageboard.Types.html#Role"><span class="hs-identifier hs-type">Role</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-290"></span><span id="insertAccount"><span class="annot"><span class="annottext">insertAccount :: Text -&gt; PasswordHash Bcrypt -&gt; Role -&gt; IO ()
</span><a href="Imageboard.Database.html#insertAccount"><span class="hs-identifier hs-var hs-var">insertAccount</span></a></span></span><span> </span><span id="local-6989586621679159167"><span class="annot"><span class="annottext">u :: Text
</span><a href="#local-6989586621679159167"><span class="hs-identifier hs-var">u</span></a></span></span><span> </span><span id="local-6989586621679159166"><span class="annot"><span class="annottext">h :: PasswordHash Bcrypt
</span><a href="#local-6989586621679159166"><span class="hs-identifier hs-var">h</span></a></span></span><span> </span><span id="local-6989586621679159165"><span class="annot"><span class="annottext">r :: Role
</span><a href="#local-6989586621679159165"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Connection -&gt; IO ()) -&gt; IO ()
forall a. (Connection -&gt; IO a) -&gt; IO a
</span><a href="Imageboard.Database.html#runDb"><span class="hs-identifier hs-var">runDb</span></a></span><span> </span><span class="annot"><span class="annottext">((Connection -&gt; IO ()) -&gt; IO ()) -&gt; (Connection -&gt; IO ()) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679159164"><span class="annot"><span class="annottext">c :: Connection
</span><a href="#local-6989586621679159164"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-291"></span><span>    </span><span class="annot"><span class="annottext">Connection -&gt; Query -&gt; [NamedParam] -&gt; IO ()
</span><span class="hs-identifier hs-var">DB.executeNamed</span></span><span> </span><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621679159164"><span class="hs-identifier hs-var">c</span></a></span><span>   </span><span class="annot"><span class="hs-string">&quot;INSERT INTO Accounts (Username, Password, Role) \
                        \VALUES (:name, :hash, :role)&quot;</span></span><span> </span><span>
</span><span id="line-293"></span><span>                        </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="hs-string">&quot;:name&quot;</span></span><span>   </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; NamedParam
forall v. ToField v =&gt; Text -&gt; v -&gt; NamedParam
</span><span class="hs-operator hs-var">:=</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679159167"><span class="hs-identifier hs-var">u</span></a></span><span>
</span><span id="line-294"></span><span>                        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-string">&quot;:hash&quot;</span></span><span>   </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; NamedParam
forall v. ToField v =&gt; Text -&gt; v -&gt; NamedParam
</span><span class="hs-operator hs-var">:=</span></span><span> </span><span class="annot"><span class="annottext">PasswordHash Bcrypt -&gt; Text
forall a. PasswordHash a -&gt; Text
</span><span class="hs-identifier hs-var hs-var">unPasswordHash</span></span><span> </span><span class="annot"><span class="annottext">PasswordHash Bcrypt
</span><a href="#local-6989586621679159166"><span class="hs-identifier hs-var">h</span></a></span><span>
</span><span id="line-295"></span><span>                        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-string">&quot;:role&quot;</span></span><span>   </span><span class="annot"><span class="annottext">Text -&gt; Int -&gt; NamedParam
forall v. ToField v =&gt; Text -&gt; v -&gt; NamedParam
</span><span class="hs-operator hs-var">:=</span></span><span> </span><span class="annot"><span class="annottext">Role -&gt; Int
forall a. Enum a =&gt; a -&gt; Int
</span><span class="hs-identifier hs-var">fromEnum</span></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621679159165"><span class="hs-identifier hs-var">r</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-296"></span><span>
</span><span id="line-297"></span><span class="hs-comment">-- | Get list of all accounts.</span><span>
</span><span id="line-298"></span><span class="annot"><a href="Imageboard.Database.html#getAccounts"><span class="hs-identifier hs-type">getAccounts</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Imageboard.Types.html#AccountInfo"><span class="hs-identifier hs-type">AccountInfo</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-299"></span><span id="getAccounts"><span class="annot"><span class="annottext">getAccounts :: IO [AccountInfo]
</span><a href="Imageboard.Database.html#getAccounts"><span class="hs-identifier hs-var hs-var">getAccounts</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Connection -&gt; IO [AccountInfo]) -&gt; IO [AccountInfo]
forall a. (Connection -&gt; IO a) -&gt; IO a
</span><a href="Imageboard.Database.html#runDb"><span class="hs-identifier hs-var">runDb</span></a></span><span> </span><span class="annot"><span class="annottext">((Connection -&gt; IO [AccountInfo]) -&gt; IO [AccountInfo])
-&gt; (Connection -&gt; IO [AccountInfo]) -&gt; IO [AccountInfo]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679159163"><span class="annot"><span class="annottext">c :: Connection
</span><a href="#local-6989586621679159163"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-300"></span><span>    </span><span class="annot"><span class="annottext">Connection -&gt; Query -&gt; IO [AccountInfo]
forall r. FromRow r =&gt; Connection -&gt; Query -&gt; IO [r]
</span><span class="hs-identifier hs-var">DB.query_</span></span><span> </span><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621679159163"><span class="hs-identifier hs-var">c</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;SELECT Username, CreationDate, Role FROM Accounts&quot;</span></span><span>
</span><span id="line-301"></span><span>
</span><span id="line-302"></span><span class="hs-comment">-- | Check if account with given username exists.</span><span>
</span><span id="line-303"></span><span class="annot"><a href="Imageboard.Database.html#checkAccount"><span class="hs-identifier hs-type">checkAccount</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Imageboard.Types.html#Username"><span class="hs-identifier hs-type">Username</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-304"></span><span id="checkAccount"><span class="annot"><span class="annottext">checkAccount :: Text -&gt; IO Bool
</span><a href="Imageboard.Database.html#checkAccount"><span class="hs-identifier hs-var hs-var">checkAccount</span></a></span></span><span> </span><span id="local-6989586621679159162"><span class="annot"><span class="annottext">u :: Text
</span><a href="#local-6989586621679159162"><span class="hs-identifier hs-var">u</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Connection -&gt; IO Bool) -&gt; IO Bool
forall a. (Connection -&gt; IO a) -&gt; IO a
</span><a href="Imageboard.Database.html#runDb"><span class="hs-identifier hs-var">runDb</span></a></span><span> </span><span class="annot"><span class="annottext">((Connection -&gt; IO Bool) -&gt; IO Bool)
-&gt; (Connection -&gt; IO Bool) -&gt; IO Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679159161"><span class="annot"><span class="annottext">c :: Connection
</span><a href="#local-6989586621679159161"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-305"></span><span>    </span><span class="annot"><span class="annottext">Connection -&gt; Query -&gt; Only Text -&gt; IO [Only Bool]
forall q r.
(ToRow q, FromRow r) =&gt;
Connection -&gt; Query -&gt; q -&gt; IO [r]
</span><span class="hs-identifier hs-var">DB.query</span></span><span> </span><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621679159161"><span class="hs-identifier hs-var">c</span></a></span><span>  </span><span class="annot"><span class="hs-string">&quot;SELECT EXISTS(SELECT * FROM Accounts WHERE Username = ?)&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text -&gt; Only Text
forall a. a -&gt; Only a
</span><span class="hs-identifier hs-var">DB.Only</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679159162"><span class="hs-identifier hs-var">u</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-306"></span><span>    </span><span class="annot"><span class="annottext">IO [Only Bool] -&gt; ([Only Bool] -&gt; Bool) -&gt; IO Bool
forall (f :: * -&gt; *) a b. Functor f =&gt; f a -&gt; (a -&gt; b) -&gt; f b
</span><span class="hs-operator hs-var">&lt;&amp;&gt;</span></span><span> </span><span class="annot"><span class="annottext">(Only Bool -&gt; Bool) -&gt; [Only Bool] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">any</span></span><span> </span><span class="annot"><span class="annottext">Only Bool -&gt; Bool
forall a. Only a -&gt; a
</span><span class="hs-identifier hs-var hs-var">DB.fromOnly</span></span><span>
</span><span id="line-307"></span><span>
</span><span id="line-308"></span><span class="hs-comment">-- | Change password of given user.</span><span>
</span><span id="line-309"></span><span class="annot"><a href="Imageboard.Database.html#changePassword"><span class="hs-identifier hs-type">changePassword</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Imageboard.Types.html#Username"><span class="hs-identifier hs-type">Username</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">PasswordHash</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bcrypt</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-310"></span><span id="changePassword"><span class="annot"><span class="annottext">changePassword :: Text -&gt; PasswordHash Bcrypt -&gt; IO ()
</span><a href="Imageboard.Database.html#changePassword"><span class="hs-identifier hs-var hs-var">changePassword</span></a></span></span><span> </span><span id="local-6989586621679159158"><span class="annot"><span class="annottext">u :: Text
</span><a href="#local-6989586621679159158"><span class="hs-identifier hs-var">u</span></a></span></span><span> </span><span id="local-6989586621679159157"><span class="annot"><span class="annottext">h :: PasswordHash Bcrypt
</span><a href="#local-6989586621679159157"><span class="hs-identifier hs-var">h</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Connection -&gt; IO ()) -&gt; IO ()
forall a. (Connection -&gt; IO a) -&gt; IO a
</span><a href="Imageboard.Database.html#runDb"><span class="hs-identifier hs-var">runDb</span></a></span><span> </span><span class="annot"><span class="annottext">((Connection -&gt; IO ()) -&gt; IO ()) -&gt; (Connection -&gt; IO ()) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679159156"><span class="annot"><span class="annottext">c :: Connection
</span><a href="#local-6989586621679159156"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-311"></span><span>    </span><span class="annot"><span class="annottext">Connection -&gt; Query -&gt; [NamedParam] -&gt; IO ()
</span><span class="hs-identifier hs-var">DB.executeNamed</span></span><span> </span><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621679159156"><span class="hs-identifier hs-var">c</span></a></span><span>   </span><span class="annot"><span class="hs-string">&quot;UPDATE Accounts SET Password = :hash WHERE Username = :name&quot;</span></span><span> </span><span>
</span><span id="line-312"></span><span>                        </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="hs-string">&quot;:name&quot;</span></span><span>   </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; NamedParam
forall v. ToField v =&gt; Text -&gt; v -&gt; NamedParam
</span><span class="hs-operator hs-var">:=</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679159158"><span class="hs-identifier hs-var">u</span></a></span><span>
</span><span id="line-313"></span><span>                        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-string">&quot;:hash&quot;</span></span><span>   </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; NamedParam
forall v. ToField v =&gt; Text -&gt; v -&gt; NamedParam
</span><span class="hs-operator hs-var">:=</span></span><span> </span><span class="annot"><span class="annottext">PasswordHash Bcrypt -&gt; Text
forall a. PasswordHash a -&gt; Text
</span><span class="hs-identifier hs-var hs-var">unPasswordHash</span></span><span> </span><span class="annot"><span class="annottext">PasswordHash Bcrypt
</span><a href="#local-6989586621679159157"><span class="hs-identifier hs-var">h</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-314"></span><span> </span><span>
</span><span id="line-315"></span><span class="hs-comment">-- | Get hashed password if given user exists.</span><span>
</span><span id="line-316"></span><span class="annot"><a href="Imageboard.Database.html#getPasswordHash"><span class="hs-identifier hs-type">getPasswordHash</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Imageboard.Types.html#Username"><span class="hs-identifier hs-type">Username</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">PasswordHash</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bcrypt</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-317"></span><span id="getPasswordHash"><span class="annot"><span class="annottext">getPasswordHash :: Text -&gt; IO (Maybe (PasswordHash Bcrypt))
</span><a href="Imageboard.Database.html#getPasswordHash"><span class="hs-identifier hs-var hs-var">getPasswordHash</span></a></span></span><span> </span><span id="local-6989586621679159155"><span class="annot"><span class="annottext">u :: Text
</span><a href="#local-6989586621679159155"><span class="hs-identifier hs-var">u</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>  </span><span class="annot"><span class="annottext">(Connection -&gt; IO (Maybe (PasswordHash Bcrypt)))
-&gt; IO (Maybe (PasswordHash Bcrypt))
forall a. (Connection -&gt; IO a) -&gt; IO a
</span><a href="Imageboard.Database.html#runDb"><span class="hs-identifier hs-var">runDb</span></a></span><span> </span><span class="annot"><span class="annottext">((Connection -&gt; IO (Maybe (PasswordHash Bcrypt)))
 -&gt; IO (Maybe (PasswordHash Bcrypt)))
-&gt; (Connection -&gt; IO (Maybe (PasswordHash Bcrypt)))
-&gt; IO (Maybe (PasswordHash Bcrypt))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679159154"><span class="annot"><span class="annottext">c :: Connection
</span><a href="#local-6989586621679159154"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-318"></span><span>    </span><span id="local-6989586621679159153"><span class="annot"><span class="annottext">[Only Text]
</span><a href="#local-6989586621679159153"><span class="hs-identifier hs-var">q</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Connection -&gt; Query -&gt; [NamedParam] -&gt; IO [Only Text]
forall r.
FromRow r =&gt;
Connection -&gt; Query -&gt; [NamedParam] -&gt; IO [r]
</span><span class="hs-identifier hs-var">DB.queryNamed</span></span><span> </span><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621679159154"><span class="hs-identifier hs-var">c</span></a></span><span>    </span><span class="annot"><span class="hs-string">&quot;SELECT Password From Accounts WHERE USERNAME = :user&quot;</span></span><span>
</span><span id="line-319"></span><span>                            </span><span class="hs-special">[</span><span class="annot"><span class="hs-string">&quot;:user&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; NamedParam
forall v. ToField v =&gt; Text -&gt; v -&gt; NamedParam
</span><span class="hs-operator hs-var">:=</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679159155"><span class="hs-identifier hs-var">u</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">DB.Only</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span class="hs-special">]</span><span>
</span><span id="line-320"></span><span>    </span><span class="annot"><span class="annottext">Maybe (PasswordHash Bcrypt) -&gt; IO (Maybe (PasswordHash Bcrypt))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Maybe (PasswordHash Bcrypt) -&gt; IO (Maybe (PasswordHash Bcrypt)))
-&gt; Maybe (PasswordHash Bcrypt) -&gt; IO (Maybe (PasswordHash Bcrypt))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; PasswordHash Bcrypt
forall a. Text -&gt; PasswordHash a
</span><span class="hs-identifier hs-var">PasswordHash</span></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; PasswordHash Bcrypt)
-&gt; (Only Text -&gt; Text) -&gt; Only Text -&gt; PasswordHash Bcrypt
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Only Text -&gt; Text
forall a. Only a -&gt; a
</span><span class="hs-identifier hs-var hs-var">DB.fromOnly</span></span><span> </span><span class="annot"><span class="annottext">(Only Text -&gt; PasswordHash Bcrypt)
-&gt; Maybe (Only Text) -&gt; Maybe (PasswordHash Bcrypt)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">[Only Text] -&gt; Maybe (Only Text)
forall a. [a] -&gt; Maybe a
</span><span class="hs-identifier hs-var">listToMaybe</span></span><span> </span><span class="annot"><span class="annottext">[Only Text]
</span><a href="#local-6989586621679159153"><span class="hs-identifier hs-var">q</span></a></span><span>
</span><span id="line-321"></span><span>
</span><span id="line-322"></span><span class="hs-comment">-- | Insert new sesion token for given user. Will delete old session tokens for the user.</span><span>
</span><span id="line-323"></span><span class="annot"><a href="Imageboard.Database.html#insertSessionToken"><span class="hs-identifier hs-type">insertSessionToken</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Imageboard.Types.html#Username"><span class="hs-identifier hs-type">Username</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Imageboard.Types.html#SessionKey"><span class="hs-identifier hs-type">SessionKey</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-324"></span><span id="insertSessionToken"><span class="annot"><span class="annottext">insertSessionToken :: Text -&gt; Text -&gt; IO ()
</span><a href="Imageboard.Database.html#insertSessionToken"><span class="hs-identifier hs-var hs-var">insertSessionToken</span></a></span></span><span> </span><span id="local-6989586621679159150"><span class="annot"><span class="annottext">a :: Text
</span><a href="#local-6989586621679159150"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621679159149"><span class="annot"><span class="annottext">t :: Text
</span><a href="#local-6989586621679159149"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Connection -&gt; IO ()) -&gt; IO ()
forall a. (Connection -&gt; IO a) -&gt; IO a
</span><a href="Imageboard.Database.html#runDb"><span class="hs-identifier hs-var">runDb</span></a></span><span> </span><span class="annot"><span class="annottext">((Connection -&gt; IO ()) -&gt; IO ()) -&gt; (Connection -&gt; IO ()) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679159148"><span class="annot"><span class="annottext">c :: Connection
</span><a href="#local-6989586621679159148"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-325"></span><span>    </span><span class="annot"><span class="annottext">Connection -&gt; Query -&gt; [NamedParam] -&gt; IO ()
</span><span class="hs-identifier hs-var">DB.executeNamed</span></span><span> </span><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621679159148"><span class="hs-identifier hs-var">c</span></a></span><span>   </span><span class="annot"><span class="hs-string">&quot;INSERT INTO Sessions (Username, Key) \
                        \VALUES (:name, :token)&quot;</span></span><span> </span><span>
</span><span id="line-327"></span><span>                        </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="hs-string">&quot;:name&quot;</span></span><span>   </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; NamedParam
forall v. ToField v =&gt; Text -&gt; v -&gt; NamedParam
</span><span class="hs-operator hs-var">:=</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679159150"><span class="hs-identifier hs-var">a</span></a></span><span>
</span><span id="line-328"></span><span>                        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-string">&quot;:token&quot;</span></span><span>  </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; NamedParam
forall v. ToField v =&gt; Text -&gt; v -&gt; NamedParam
</span><span class="hs-operator hs-var">:=</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679159149"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-329"></span><span>
</span><span id="line-330"></span><span class="hs-comment">-- | Remove given session token from database.</span><span>
</span><span id="line-331"></span><span class="annot"><a href="Imageboard.Database.html#removeSessionToken"><span class="hs-identifier hs-type">removeSessionToken</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Imageboard.Types.html#SessionKey"><span class="hs-identifier hs-type">SessionKey</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-332"></span><span id="removeSessionToken"><span class="annot"><span class="annottext">removeSessionToken :: Text -&gt; IO ()
</span><a href="Imageboard.Database.html#removeSessionToken"><span class="hs-identifier hs-var hs-var">removeSessionToken</span></a></span></span><span> </span><span id="local-6989586621679159147"><span class="annot"><span class="annottext">t :: Text
</span><a href="#local-6989586621679159147"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Connection -&gt; IO ()) -&gt; IO ()
forall a. (Connection -&gt; IO a) -&gt; IO a
</span><a href="Imageboard.Database.html#runDb"><span class="hs-identifier hs-var">runDb</span></a></span><span> </span><span class="annot"><span class="annottext">((Connection -&gt; IO ()) -&gt; IO ()) -&gt; (Connection -&gt; IO ()) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679159146"><span class="annot"><span class="annottext">c :: Connection
</span><a href="#local-6989586621679159146"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-333"></span><span>    </span><span class="annot"><span class="annottext">Connection -&gt; Query -&gt; [NamedParam] -&gt; IO ()
</span><span class="hs-identifier hs-var">DB.executeNamed</span></span><span> </span><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621679159146"><span class="hs-identifier hs-var">c</span></a></span><span>   </span><span class="annot"><span class="hs-string">&quot;DELETE FROM Sessions WHERE Username = \
                        \(SELECT Username FROM Sessions WHERE Key = :token)&quot;</span></span><span> </span><span>
</span><span id="line-335"></span><span>                        </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="hs-string">&quot;:token&quot;</span></span><span>  </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; NamedParam
forall v. ToField v =&gt; Text -&gt; v -&gt; NamedParam
</span><span class="hs-operator hs-var">:=</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679159147"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-336"></span><span>
</span><span id="line-337"></span><span class="hs-comment">-- | Check if session token is still valid.</span><span>
</span><span id="line-338"></span><span class="annot"><a href="Imageboard.Database.html#checkSession"><span class="hs-identifier hs-type">checkSession</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Imageboard.Types.html#SessionKey"><span class="hs-identifier hs-type">SessionKey</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-339"></span><span id="checkSession"><span class="annot"><span class="annottext">checkSession :: Text -&gt; IO Bool
</span><a href="Imageboard.Database.html#checkSession"><span class="hs-identifier hs-var hs-var">checkSession</span></a></span></span><span> </span><span id="local-6989586621679159145"><span class="annot"><span class="annottext">t :: Text
</span><a href="#local-6989586621679159145"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Connection -&gt; IO Bool) -&gt; IO Bool
forall a. (Connection -&gt; IO a) -&gt; IO a
</span><a href="Imageboard.Database.html#runDb"><span class="hs-identifier hs-var">runDb</span></a></span><span> </span><span class="annot"><span class="annottext">((Connection -&gt; IO Bool) -&gt; IO Bool)
-&gt; (Connection -&gt; IO Bool) -&gt; IO Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679159144"><span class="annot"><span class="annottext">c :: Connection
</span><a href="#local-6989586621679159144"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-340"></span><span>    </span><span class="annot"><span class="annottext">Connection -&gt; Query -&gt; [NamedParam] -&gt; IO [Only Bool]
forall r.
FromRow r =&gt;
Connection -&gt; Query -&gt; [NamedParam] -&gt; IO [r]
</span><span class="hs-identifier hs-var">DB.queryNamed</span></span><span> </span><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621679159144"><span class="hs-identifier hs-var">c</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;SELECT EXISTS(SELECT * FROM Sessions WHERE Key = :token \
                    \AND ExpireDate &gt; STRFTIME('%s', 'now'))&quot;</span></span><span>
</span><span id="line-342"></span><span>                    </span><span class="hs-special">[</span><span class="annot"><span class="hs-string">&quot;:token&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; NamedParam
forall v. ToField v =&gt; Text -&gt; v -&gt; NamedParam
</span><span class="hs-operator hs-var">:=</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679159145"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">]</span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">DB.Only</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span class="hs-special">]</span><span>
</span><span id="line-343"></span><span>    </span><span class="annot"><span class="annottext">IO [Only Bool] -&gt; ([Only Bool] -&gt; Bool) -&gt; IO Bool
forall (f :: * -&gt; *) a b. Functor f =&gt; f a -&gt; (a -&gt; b) -&gt; f b
</span><span class="hs-operator hs-var">&lt;&amp;&gt;</span></span><span> </span><span class="annot"><span class="annottext">(Only Bool -&gt; Bool) -&gt; [Only Bool] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">any</span></span><span> </span><span class="annot"><span class="annottext">Only Bool -&gt; Bool
forall a. Only a -&gt; a
</span><span class="hs-identifier hs-var hs-var">DB.fromOnly</span></span><span>
</span><span id="line-344"></span><span>
</span><span id="line-345"></span><span class="hs-comment">-- | Get account associated with given session token, if it exists.</span><span>
</span><span id="line-346"></span><span class="annot"><a href="Imageboard.Database.html#getAccountByToken"><span class="hs-identifier hs-type">getAccountByToken</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Imageboard.Types.html#SessionKey"><span class="hs-identifier hs-type">SessionKey</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="Imageboard.Types.html#AccountInfo"><span class="hs-identifier hs-type">AccountInfo</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-347"></span><span id="getAccountByToken"><span class="annot"><span class="annottext">getAccountByToken :: Text -&gt; IO (Maybe AccountInfo)
</span><a href="Imageboard.Database.html#getAccountByToken"><span class="hs-identifier hs-var hs-var">getAccountByToken</span></a></span></span><span> </span><span id="local-6989586621679159143"><span class="annot"><span class="annottext">t :: Text
</span><a href="#local-6989586621679159143"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Connection -&gt; IO (Maybe AccountInfo)) -&gt; IO (Maybe AccountInfo)
forall a. (Connection -&gt; IO a) -&gt; IO a
</span><a href="Imageboard.Database.html#runDb"><span class="hs-identifier hs-var">runDb</span></a></span><span> </span><span class="annot"><span class="annottext">((Connection -&gt; IO (Maybe AccountInfo)) -&gt; IO (Maybe AccountInfo))
-&gt; (Connection -&gt; IO (Maybe AccountInfo)) -&gt; IO (Maybe AccountInfo)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679159142"><span class="annot"><span class="annottext">c :: Connection
</span><a href="#local-6989586621679159142"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-348"></span><span>    </span><span class="annot"><span class="annottext">Connection -&gt; Query -&gt; [NamedParam] -&gt; IO [AccountInfo]
forall r.
FromRow r =&gt;
Connection -&gt; Query -&gt; [NamedParam] -&gt; IO [r]
</span><span class="hs-identifier hs-var">DB.queryNamed</span></span><span> </span><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621679159142"><span class="hs-identifier hs-var">c</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;SELECT Accounts.Username, CreationDate, Role \
                    \FROM Accounts JOIN Sessions ON Accounts.Username = Sessions.Username \
                    \WHERE Sessions.Key = :token AND ExpireDate &gt; STRFTIME('%s', 'now')&quot;</span></span><span>
</span><span id="line-351"></span><span>                    </span><span class="hs-special">[</span><span class="annot"><span class="hs-string">&quot;:token&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; NamedParam
forall v. ToField v =&gt; Text -&gt; v -&gt; NamedParam
</span><span class="hs-operator hs-var">:=</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679159143"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-352"></span><span>    </span><span class="annot"><span class="annottext">IO [AccountInfo]
-&gt; ([AccountInfo] -&gt; Maybe AccountInfo) -&gt; IO (Maybe AccountInfo)
forall (f :: * -&gt; *) a b. Functor f =&gt; f a -&gt; (a -&gt; b) -&gt; f b
</span><span class="hs-operator hs-var">&lt;&amp;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[AccountInfo] -&gt; Maybe AccountInfo
forall a. [a] -&gt; Maybe a
</span><span class="hs-identifier hs-var">listToMaybe</span></span><span>
</span><span id="line-353"></span><span>
</span><span id="line-354"></span><span class="hs-comment">-- | Change board configuration.</span><span>
</span><span id="line-355"></span><span class="annot"><a href="Imageboard.Database.html#updateBoard"><span class="hs-identifier hs-type">updateBoard</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Imageboard.Types.html#Board"><span class="hs-identifier hs-type">Board</span></a></span><span> </span><span class="hs-comment">-- ^ Old board name.</span><span>
</span><span id="line-356"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Imageboard.Types.html#BoardInfo"><span class="hs-identifier hs-type">BoardInfo</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Imageboard.Types.html#BoardConstraints"><span class="hs-identifier hs-type">BoardConstraints</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-357"></span><span id="updateBoard"><span class="annot"><span class="annottext">updateBoard :: Text -&gt; BoardInfo -&gt; BoardConstraints -&gt; IO ()
</span><a href="Imageboard.Database.html#updateBoard"><span class="hs-identifier hs-var hs-var">updateBoard</span></a></span></span><span> </span><span id="local-6989586621679159141"><span class="annot"><span class="annottext">b :: Text
</span><a href="#local-6989586621679159141"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span id="local-6989586621679159138"><span id="local-6989586621679159139"><span id="local-6989586621679159140"><span class="annot"><a href="Imageboard.Types.html#BoardInfo"><span class="hs-identifier hs-type">BoardInfo</span></a></span><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span></span></span></span><span> </span><span id="local-6989586621679159129"><span id="local-6989586621679159130"><span id="local-6989586621679159131"><span id="local-6989586621679159132"><span id="local-6989586621679159133"><span id="local-6989586621679159134"><span class="annot"><a href="Imageboard.Types.html#Constraints"><span class="hs-identifier hs-type">Constraints</span></a></span><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span></span></span></span></span></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Connection -&gt; IO ()) -&gt; IO ()
forall a. (Connection -&gt; IO a) -&gt; IO a
</span><a href="Imageboard.Database.html#runDb"><span class="hs-identifier hs-var">runDb</span></a></span><span> </span><span class="annot"><span class="annottext">((Connection -&gt; IO ()) -&gt; IO ()) -&gt; (Connection -&gt; IO ()) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679159122"><span class="annot"><span class="annottext">c :: Connection
</span><a href="#local-6989586621679159122"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-358"></span><span>    </span><span class="annot"><span class="annottext">Connection -&gt; IO ()
</span><a href="Imageboard.Database.html#foreignKeyPragma"><span class="hs-identifier hs-var">foreignKeyPragma</span></a></span><span> </span><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621679159122"><span class="hs-identifier hs-var">c</span></a></span><span>
</span><span id="line-359"></span><span>    </span><span class="annot"><span class="annottext">Connection
-&gt; Query
-&gt; (Text, Text, Text, Bool, Int, Int, Int, Int, Int, Text)
-&gt; IO ()
forall q. ToRow q =&gt; Connection -&gt; Query -&gt; q -&gt; IO ()
</span><span class="hs-identifier hs-var">DB.execute</span></span><span> </span><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621679159122"><span class="hs-identifier hs-var">c</span></a></span><span>    </span><span class="annot"><span class="hs-string">&quot;UPDATE Boards SET Name = ?, Title = ?, Subtitle = ?, \
                    \Lock = ?, PostMinLength = ?, PostMaxLength = ?, \
                    \PostMaxNewlines = ?, PostLimit = ?, ThreadLimit = ? \
                    \WHERE Name = ?&quot;</span></span><span> </span><span>
</span><span id="line-363"></span><span>                    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679159140"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679159139"><span class="hs-identifier hs-var">title</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679159138"><span class="hs-identifier hs-var">subtitle</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-364"></span><span>                    </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679159134"><span class="hs-identifier hs-var">isLocked</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679159133"><span class="hs-identifier hs-var">minLen</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679159132"><span class="hs-identifier hs-var">maxLen</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-365"></span><span>                    </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679159131"><span class="hs-identifier hs-var">maxNewLines</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679159130"><span class="hs-identifier hs-var">maxReplies</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679159129"><span class="hs-identifier hs-var">maxThreads</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679159141"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-366"></span><span>
</span><span id="line-367"></span><span class="hs-comment">-- | Insert new board into a database.</span><span>
</span><span id="line-368"></span><span class="annot"><a href="Imageboard.Database.html#insertBoard"><span class="hs-identifier hs-type">insertBoard</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Imageboard.Types.html#BoardInfo"><span class="hs-identifier hs-type">BoardInfo</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Imageboard.Types.html#BoardConstraints"><span class="hs-identifier hs-type">BoardConstraints</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-369"></span><span id="insertBoard"><span class="annot"><span class="annottext">insertBoard :: BoardInfo -&gt; BoardConstraints -&gt; IO ()
</span><a href="Imageboard.Database.html#insertBoard"><span class="hs-identifier hs-var hs-var">insertBoard</span></a></span></span><span> </span><span id="local-6989586621679159118"><span id="local-6989586621679159119"><span id="local-6989586621679159120"><span class="annot"><a href="Imageboard.Types.html#BoardInfo"><span class="hs-identifier hs-type">BoardInfo</span></a></span><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span></span></span></span><span> </span><span id="local-6989586621679159112"><span id="local-6989586621679159113"><span id="local-6989586621679159114"><span id="local-6989586621679159115"><span id="local-6989586621679159116"><span id="local-6989586621679159117"><span class="annot"><a href="Imageboard.Types.html#Constraints"><span class="hs-identifier hs-type">Constraints</span></a></span><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span></span></span></span></span></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Connection -&gt; IO ()) -&gt; IO ()
forall a. (Connection -&gt; IO a) -&gt; IO a
</span><a href="Imageboard.Database.html#runDb"><span class="hs-identifier hs-var">runDb</span></a></span><span> </span><span class="annot"><span class="annottext">((Connection -&gt; IO ()) -&gt; IO ()) -&gt; (Connection -&gt; IO ()) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679159111"><span class="annot"><span class="annottext">c :: Connection
</span><a href="#local-6989586621679159111"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-370"></span><span>    </span><span class="annot"><span class="annottext">Connection
-&gt; Query
-&gt; (Text, Text, Text, Bool, Int, Int, Int, Int, Int)
-&gt; IO ()
forall q. ToRow q =&gt; Connection -&gt; Query -&gt; q -&gt; IO ()
</span><span class="hs-identifier hs-var">DB.execute</span></span><span> </span><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621679159111"><span class="hs-identifier hs-var">c</span></a></span><span>    </span><span class="annot"><span class="hs-string">&quot;INSERT INTO Boards (Name, Title, Subtitle, \
                    \Lock, PostMinLength, PostMaxLength, PostMaxNewLines, PostLimit, ThreadLimit) \
                    \VALUES (?,?,?,?,?,?,?,?,?)&quot;</span></span><span>
</span><span id="line-373"></span><span>                    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679159120"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679159119"><span class="hs-identifier hs-var">title</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679159118"><span class="hs-identifier hs-var">subtitle</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-374"></span><span>                    </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679159117"><span class="hs-identifier hs-var">isLocked</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679159116"><span class="hs-identifier hs-var">minLen</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679159115"><span class="hs-identifier hs-var">maxLen</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679159114"><span class="hs-identifier hs-var">maxNewLines</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679159113"><span class="hs-identifier hs-var">maxReplies</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679159112"><span class="hs-identifier hs-var">maxThreads</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-375"></span><span>    </span><span>
</span><span id="line-376"></span><span class="hs-comment">-- | Remove file with given filename from database.</span><span>
</span><span id="line-377"></span><span class="annot"><a href="Imageboard.Database.html#removeFile"><span class="hs-identifier hs-type">removeFile</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-378"></span><span id="removeFile"><span class="annot"><span class="annottext">removeFile :: Text -&gt; IO ()
</span><a href="Imageboard.Database.html#removeFile"><span class="hs-identifier hs-var hs-var">removeFile</span></a></span></span><span> </span><span id="local-6989586621679159110"><span class="annot"><span class="annottext">f :: Text
</span><a href="#local-6989586621679159110"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Connection -&gt; IO ()) -&gt; IO ()
forall a. (Connection -&gt; IO a) -&gt; IO a
</span><a href="Imageboard.Database.html#runDb"><span class="hs-identifier hs-var">runDb</span></a></span><span> </span><span class="annot"><span class="annottext">((Connection -&gt; IO ()) -&gt; IO ()) -&gt; (Connection -&gt; IO ()) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679159109"><span class="annot"><span class="annottext">c :: Connection
</span><a href="#local-6989586621679159109"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-379"></span><span>    </span><span class="annot"><span class="annottext">Connection -&gt; IO ()
</span><a href="Imageboard.Database.html#foreignKeyPragma"><span class="hs-identifier hs-var">foreignKeyPragma</span></a></span><span> </span><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621679159109"><span class="hs-identifier hs-var">c</span></a></span><span>
</span><span id="line-380"></span><span>    </span><span class="annot"><span class="annottext">Connection -&gt; Query -&gt; [NamedParam] -&gt; IO ()
</span><span class="hs-identifier hs-var">DB.executeNamed</span></span><span> </span><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621679159109"><span class="hs-identifier hs-var">c</span></a></span><span>   </span><span class="annot"><span class="hs-string">&quot;DELETE FROM Files WHERE Name = :name&quot;</span></span><span> </span><span>
</span><span id="line-381"></span><span>                        </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="hs-string">&quot;:name&quot;</span></span><span>  </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; NamedParam
forall v. ToField v =&gt; Text -&gt; v -&gt; NamedParam
</span><span class="hs-operator hs-var">:=</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679159110"><span class="hs-identifier hs-var">f</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-382"></span><span>
</span><span id="line-383"></span><span class="hs-comment">-- | Remove posts with given number from given board.</span><span>
</span><span id="line-384"></span><span class="annot"><a href="Imageboard.Database.html#removePost"><span class="hs-identifier hs-type">removePost</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Imageboard.Types.html#Board"><span class="hs-identifier hs-type">Board</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-385"></span><span id="removePost"><span class="annot"><span class="annottext">removePost :: Text -&gt; Int -&gt; IO ()
</span><a href="Imageboard.Database.html#removePost"><span class="hs-identifier hs-var hs-var">removePost</span></a></span></span><span> </span><span id="local-6989586621679159108"><span class="annot"><span class="annottext">b :: Text
</span><a href="#local-6989586621679159108"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span id="local-6989586621679159107"><span class="annot"><span class="annottext">n :: Int
</span><a href="#local-6989586621679159107"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Connection -&gt; IO ()) -&gt; IO ()
forall a. (Connection -&gt; IO a) -&gt; IO a
</span><a href="Imageboard.Database.html#runDb"><span class="hs-identifier hs-var">runDb</span></a></span><span> </span><span class="annot"><span class="annottext">((Connection -&gt; IO ()) -&gt; IO ()) -&gt; (Connection -&gt; IO ()) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679159106"><span class="annot"><span class="annottext">c :: Connection
</span><a href="#local-6989586621679159106"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-386"></span><span>    </span><span class="annot"><span class="annottext">Connection -&gt; IO ()
</span><a href="Imageboard.Database.html#foreignKeyPragma"><span class="hs-identifier hs-var">foreignKeyPragma</span></a></span><span> </span><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621679159106"><span class="hs-identifier hs-var">c</span></a></span><span>
</span><span id="line-387"></span><span>    </span><span class="annot"><span class="annottext">Connection -&gt; Query -&gt; [NamedParam] -&gt; IO ()
</span><span class="hs-identifier hs-var">DB.executeNamed</span></span><span> </span><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621679159106"><span class="hs-identifier hs-var">c</span></a></span><span>   </span><span class="annot"><span class="hs-string">&quot;DELETE FROM Posts WHERE Board = :board AND Number = :num&quot;</span></span><span> </span><span>
</span><span id="line-388"></span><span>                        </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="hs-string">&quot;:board&quot;</span></span><span>  </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; NamedParam
forall v. ToField v =&gt; Text -&gt; v -&gt; NamedParam
</span><span class="hs-operator hs-var">:=</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679159108"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-string">&quot;:num&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Int -&gt; NamedParam
forall v. ToField v =&gt; Text -&gt; v -&gt; NamedParam
</span><span class="hs-operator hs-var">:=</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679159107"><span class="hs-identifier hs-var">n</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-389"></span><span>
</span><span id="line-390"></span><span class="hs-comment">-- | Unlink file from post with given number on given board, </span><span>
</span><span id="line-391"></span><span class="hs-comment">-- a.k.a. turn it into post with no file attached, without removing</span><span>
</span><span id="line-392"></span><span class="hs-comment">-- file from database.</span><span>
</span><span id="line-393"></span><span class="annot"><a href="Imageboard.Database.html#unlinkFile"><span class="hs-identifier hs-type">unlinkFile</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Imageboard.Types.html#Board"><span class="hs-identifier hs-type">Board</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-394"></span><span id="unlinkFile"><span class="annot"><span class="annottext">unlinkFile :: Text -&gt; Int -&gt; IO ()
</span><a href="Imageboard.Database.html#unlinkFile"><span class="hs-identifier hs-var hs-var">unlinkFile</span></a></span></span><span> </span><span id="local-6989586621679159105"><span class="annot"><span class="annottext">b :: Text
</span><a href="#local-6989586621679159105"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span id="local-6989586621679159104"><span class="annot"><span class="annottext">n :: Int
</span><a href="#local-6989586621679159104"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Connection -&gt; IO ()) -&gt; IO ()
forall a. (Connection -&gt; IO a) -&gt; IO a
</span><a href="Imageboard.Database.html#runDb"><span class="hs-identifier hs-var">runDb</span></a></span><span> </span><span class="annot"><span class="annottext">((Connection -&gt; IO ()) -&gt; IO ()) -&gt; (Connection -&gt; IO ()) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679159103"><span class="annot"><span class="annottext">c :: Connection
</span><a href="#local-6989586621679159103"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-395"></span><span>    </span><span class="annot"><span class="annottext">Connection -&gt; Query -&gt; [NamedParam] -&gt; IO ()
</span><span class="hs-identifier hs-var">DB.executeNamed</span></span><span> </span><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621679159103"><span class="hs-identifier hs-var">c</span></a></span><span>   </span><span class="annot"><span class="hs-string">&quot;UPDATE Posts SET FileId = NULL WHERE Board = :board AND Number = :num&quot;</span></span><span> </span><span>
</span><span id="line-396"></span><span>                        </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="hs-string">&quot;:board&quot;</span></span><span>  </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; NamedParam
forall v. ToField v =&gt; Text -&gt; v -&gt; NamedParam
</span><span class="hs-operator hs-var">:=</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679159105"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-string">&quot;:num&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Int -&gt; NamedParam
forall v. ToField v =&gt; Text -&gt; v -&gt; NamedParam
</span><span class="hs-operator hs-var">:=</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679159104"><span class="hs-identifier hs-var">n</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-397"></span><span>
</span><span id="line-398"></span><span class="annot"><a href="Imageboard.Database.html#execOnThread"><span class="hs-identifier hs-type">execOnThread</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DB.Query</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Imageboard.Types.html#Board"><span class="hs-identifier hs-type">Board</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-399"></span><span id="execOnThread"><span class="annot"><span class="annottext">execOnThread :: Query -&gt; Text -&gt; Int -&gt; IO ()
</span><a href="Imageboard.Database.html#execOnThread"><span class="hs-identifier hs-var hs-var">execOnThread</span></a></span></span><span> </span><span id="local-6989586621679159101"><span class="annot"><span class="annottext">q :: Query
</span><a href="#local-6989586621679159101"><span class="hs-identifier hs-var">q</span></a></span></span><span> </span><span id="local-6989586621679159100"><span class="annot"><span class="annottext">b :: Text
</span><a href="#local-6989586621679159100"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span id="local-6989586621679159099"><span class="annot"><span class="annottext">n :: Int
</span><a href="#local-6989586621679159099"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Connection -&gt; IO ()) -&gt; IO ()
forall a. (Connection -&gt; IO a) -&gt; IO a
</span><a href="Imageboard.Database.html#runDb"><span class="hs-identifier hs-var">runDb</span></a></span><span> </span><span class="annot"><span class="annottext">((Connection -&gt; IO ()) -&gt; IO ()) -&gt; (Connection -&gt; IO ()) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679159098"><span class="annot"><span class="annottext">c :: Connection
</span><a href="#local-6989586621679159098"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Connection -&gt; Query -&gt; (Text, Int) -&gt; IO ()
forall q. ToRow q =&gt; Connection -&gt; Query -&gt; q -&gt; IO ()
</span><span class="hs-identifier hs-var">DB.execute</span></span><span> </span><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621679159098"><span class="hs-identifier hs-var">c</span></a></span><span> </span><span class="annot"><span class="annottext">Query
</span><a href="#local-6989586621679159101"><span class="hs-identifier hs-var">q</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679159100"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679159099"><span class="hs-identifier hs-var">n</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-400"></span><span>
</span><span id="line-401"></span><span class="annot"><a href="Imageboard.Database.html#toggleSticky"><span class="hs-identifier hs-type">toggleSticky</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Imageboard.Types.html#Board"><span class="hs-identifier hs-type">Board</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-402"></span><span id="toggleSticky"><span class="annot"><span class="annottext">toggleSticky :: Text -&gt; Int -&gt; IO ()
</span><a href="Imageboard.Database.html#toggleSticky"><span class="hs-identifier hs-var hs-var">toggleSticky</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Query -&gt; Text -&gt; Int -&gt; IO ()
</span><a href="Imageboard.Database.html#execOnThread"><span class="hs-identifier hs-var">execOnThread</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;UPDATE Posts SET Sticky = NOT STICKY WHERE Board = ? AND Number = ?&quot;</span></span><span> </span><span>
</span><span id="line-403"></span><span>
</span><span id="line-404"></span><span class="annot"><a href="Imageboard.Database.html#toggleAutosage"><span class="hs-identifier hs-type">toggleAutosage</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Imageboard.Types.html#Board"><span class="hs-identifier hs-type">Board</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-405"></span><span id="toggleAutosage"><span class="annot"><span class="annottext">toggleAutosage :: Text -&gt; Int -&gt; IO ()
</span><a href="Imageboard.Database.html#toggleAutosage"><span class="hs-identifier hs-var hs-var">toggleAutosage</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Query -&gt; Text -&gt; Int -&gt; IO ()
</span><a href="Imageboard.Database.html#execOnThread"><span class="hs-identifier hs-var">execOnThread</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;UPDATE Posts SET Autosage = NOT Autosage WHERE Board = ? AND Number = ?&quot;</span></span><span> </span><span>
</span><span id="line-406"></span><span>
</span><span id="line-407"></span><span class="annot"><a href="Imageboard.Database.html#toggleLock"><span class="hs-identifier hs-type">toggleLock</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Imageboard.Types.html#Board"><span class="hs-identifier hs-type">Board</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-408"></span><span id="toggleLock"><span class="annot"><span class="annottext">toggleLock :: Text -&gt; Int -&gt; IO ()
</span><a href="Imageboard.Database.html#toggleLock"><span class="hs-identifier hs-var hs-var">toggleLock</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Query -&gt; Text -&gt; Int -&gt; IO ()
</span><a href="Imageboard.Database.html#execOnThread"><span class="hs-identifier hs-var">execOnThread</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;UPDATE Posts SET Lock = NOT Lock WHERE Board = ? AND Number = ?&quot;</span></span><span> </span><span>
</span><span id="line-409"></span><span>
</span><span id="line-410"></span><span class="annot"><a href="Imageboard.Database.html#toggleCycle"><span class="hs-identifier hs-type">toggleCycle</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Imageboard.Types.html#Board"><span class="hs-identifier hs-type">Board</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-411"></span><span id="toggleCycle"><span class="annot"><span class="annottext">toggleCycle :: Text -&gt; Int -&gt; IO ()
</span><a href="Imageboard.Database.html#toggleCycle"><span class="hs-identifier hs-var hs-var">toggleCycle</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Query -&gt; Text -&gt; Int -&gt; IO ()
</span><a href="Imageboard.Database.html#execOnThread"><span class="hs-identifier hs-var">execOnThread</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;UPDATE Posts SET Cycle = NOT Cycle WHERE Board = ? AND Number = ?&quot;</span></span><span>
</span><span id="line-412"></span><span>
</span><span id="line-413"></span><span class="hs-comment">-- | Store new captcha in database. Delete expired captchas.</span><span>
</span><span id="line-414"></span><span class="annot"><a href="Imageboard.Database.html#insertCaptcha"><span class="hs-identifier hs-type">insertCaptcha</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-415"></span><span id="insertCaptcha"><span class="annot"><span class="annottext">insertCaptcha :: String -&gt; IO ()
</span><a href="Imageboard.Database.html#insertCaptcha"><span class="hs-identifier hs-var hs-var">insertCaptcha</span></a></span></span><span> </span><span id="local-6989586621679159097"><span class="annot"><span class="annottext">t :: String
</span><a href="#local-6989586621679159097"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Connection -&gt; IO ()) -&gt; IO ()
forall a. (Connection -&gt; IO a) -&gt; IO a
</span><a href="Imageboard.Database.html#runDb"><span class="hs-identifier hs-var">runDb</span></a></span><span> </span><span class="annot"><span class="annottext">((Connection -&gt; IO ()) -&gt; IO ()) -&gt; (Connection -&gt; IO ()) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679159096"><span class="annot"><span class="annottext">c :: Connection
</span><a href="#local-6989586621679159096"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-416"></span><span>    </span><span class="annot"><span class="annottext">Connection -&gt; Query -&gt; IO ()
</span><span class="hs-identifier hs-var">DB.execute_</span></span><span> </span><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621679159096"><span class="hs-identifier hs-var">c</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;DELETE FROM Captchas WHERE ExpireDate &lt; strftime('%s','now')&quot;</span></span><span>
</span><span id="line-417"></span><span>    </span><span class="annot"><span class="annottext">Connection -&gt; Query -&gt; Only String -&gt; IO ()
forall q. ToRow q =&gt; Connection -&gt; Query -&gt; q -&gt; IO ()
</span><span class="hs-identifier hs-var">DB.execute</span></span><span> </span><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621679159096"><span class="hs-identifier hs-var">c</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;INSERT INTO Captchas (Text) VALUES (?)&quot;</span></span><span> </span><span class="annot"><span class="annottext">(Only String -&gt; IO ()) -&gt; Only String -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Only String
forall a. a -&gt; Only a
</span><span class="hs-identifier hs-var">DB.Only</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679159097"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-418"></span><span>
</span><span id="line-419"></span><span class="hs-comment">-- | Check if captcha  exists and is unexpired.</span><span>
</span><span id="line-420"></span><span class="annot"><a href="Imageboard.Database.html#checkCaptcha"><span class="hs-identifier hs-type">checkCaptcha</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-421"></span><span id="checkCaptcha"><span class="annot"><span class="annottext">checkCaptcha :: Text -&gt; IO Bool
</span><a href="Imageboard.Database.html#checkCaptcha"><span class="hs-identifier hs-var hs-var">checkCaptcha</span></a></span></span><span> </span><span id="local-6989586621679159095"><span class="annot"><span class="annottext">t :: Text
</span><a href="#local-6989586621679159095"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Connection -&gt; IO Bool) -&gt; IO Bool
forall a. (Connection -&gt; IO a) -&gt; IO a
</span><a href="Imageboard.Database.html#runDb"><span class="hs-identifier hs-var">runDb</span></a></span><span> </span><span class="annot"><span class="annottext">((Connection -&gt; IO Bool) -&gt; IO Bool)
-&gt; (Connection -&gt; IO Bool) -&gt; IO Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679159094"><span class="annot"><span class="annottext">c :: Connection
</span><a href="#local-6989586621679159094"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-422"></span><span>    </span><span id="local-6989586621679159093"><span class="annot"><span class="annottext">[Only Bool]
</span><a href="#local-6989586621679159093"><span class="hs-identifier hs-var">isValid</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Connection -&gt; Query -&gt; Only Text -&gt; IO [Only Bool]
forall q r.
(ToRow q, FromRow r) =&gt;
Connection -&gt; Query -&gt; q -&gt; IO [r]
</span><span class="hs-identifier hs-var">DB.query</span></span><span> </span><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621679159094"><span class="hs-identifier hs-var">c</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;SELECT EXISTS(SELECT * FROM CAPTCHAS \
                \WHERE Text = upper(?) AND ExpireDate &gt;= strftime('%s','now'))&quot;</span></span><span> </span><span class="annot"><span class="annottext">(Only Text -&gt; IO [Only Bool]) -&gt; Only Text -&gt; IO [Only Bool]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Only Text
forall a. a -&gt; Only a
</span><span class="hs-identifier hs-var">DB.Only</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679159095"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">DB.Only</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span class="hs-special">]</span><span>
</span><span id="line-424"></span><span>    </span><span class="annot"><span class="annottext">Connection -&gt; Query -&gt; Only Text -&gt; IO ()
forall q. ToRow q =&gt; Connection -&gt; Query -&gt; q -&gt; IO ()
</span><span class="hs-identifier hs-var">DB.execute</span></span><span> </span><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621679159094"><span class="hs-identifier hs-var">c</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;DELETE FROM Captchas WHERE Text = upper(?)&quot;</span></span><span> </span><span class="annot"><span class="annottext">(Only Text -&gt; IO ()) -&gt; Only Text -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Only Text
forall a. a -&gt; Only a
</span><span class="hs-identifier hs-var">DB.Only</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679159095"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-425"></span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; IO Bool
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; IO Bool) -&gt; Bool -&gt; IO Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Only Bool -&gt; Bool) -&gt; [Only Bool] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">any</span></span><span> </span><span class="annot"><span class="annottext">Only Bool -&gt; Bool
forall a. Only a -&gt; a
</span><span class="hs-identifier hs-var hs-var">DB.fromOnly</span></span><span> </span><span class="annot"><span class="annottext">[Only Bool]
</span><a href="#local-6989586621679159093"><span class="hs-identifier hs-var">isValid</span></a></span></pre></body></html>