<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE OverloadedStrings, RecordWildCards, BlockArguments #-}</span><span>
</span><span id="line-2"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Imageboard.Actions.Posting</span><span> </span><span class="hs-special">(</span><span>
</span><span id="line-3"></span><span>    </span><span class="annot"><a href="Imageboard.Actions.Posting.html#createPost"><span class="hs-identifier">createPost</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-4"></span><span>    </span><span class="annot"><a href="Imageboard.Actions.Posting.html#createThread"><span class="hs-identifier">createThread</span></a></span><span>
</span><span id="line-5"></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-6"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Except</span></span><span>
</span><span id="line-7"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Maybe</span></span><span>
</span><span id="line-8"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.String</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">IsString</span></span><span class="hs-special">)</span><span>
</span><span id="line-9"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Foldable</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">fold</span></span><span class="hs-special">)</span><span>
</span><span id="line-10"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Text</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Text</span></span><span class="hs-special">)</span><span>
</span><span id="line-11"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Text.Lazy</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Lazy</span></span><span>
</span><span id="line-12"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Text</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">T</span></span><span>
</span><span id="line-13"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Web.Scotty</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">S</span></span><span>
</span><span id="line-14"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Network.HTTP.Types.Status</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">created201</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">badRequest400</span></span><span class="hs-special">)</span><span>
</span><span id="line-15"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Imageboard.Database.html"><span class="hs-identifier">Imageboard.Database</span></a></span><span>
</span><span id="line-16"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Imageboard.Types.html"><span class="hs-identifier">Imageboard.Types</span></a></span><span>
</span><span id="line-17"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Imageboard.Pages.html"><span class="hs-identifier">Imageboard.Pages</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Imageboard.Pages.html#errorView"><span class="hs-identifier">errorView</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-18"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Imageboard.FileUpload.html"><span class="hs-identifier">Imageboard.FileUpload</span></a></span><span>
</span><span id="line-19"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Imageboard.Actions.Common.html"><span class="hs-identifier">Imageboard.Actions.Common</span></a></span><span>
</span><span id="line-20"></span><span>
</span><span id="line-21"></span><span class="annot"><a href="Imageboard.Actions.Posting.html#tryMkStub"><span class="hs-identifier hs-type">tryMkStub</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Imageboard.Types.html#BoardConstraints"><span class="hs-identifier hs-type">BoardConstraints</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span> </span><span>
</span><span id="line-22"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span> </span><span class="annot"><a href="Imageboard.Types.html#PostStub"><span class="hs-identifier hs-type">PostStub</span></a></span><span>
</span><span id="line-23"></span><span id="tryMkStub"><span class="annot"><span class="annottext">tryMkStub :: BoardConstraints
-&gt; Bool
-&gt; Maybe Text
-&gt; Maybe Text
-&gt; Maybe Text
-&gt; Maybe Text
-&gt; Either Text PostStub
</span><a href="Imageboard.Actions.Posting.html#tryMkStub"><span class="hs-identifier hs-var hs-var">tryMkStub</span></a></span></span><span> </span><span id="local-6989586621679160409"><span id="local-6989586621679160410"><span id="local-6989586621679160411"><span id="local-6989586621679160412"><span id="local-6989586621679160413"><span id="local-6989586621679160414"><span class="annot"><a href="Imageboard.Types.html#Constraints"><span class="hs-identifier hs-type">Constraints</span></a></span><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span></span></span></span></span></span></span><span> </span><span id="local-6989586621679160401"><span class="annot"><span class="annottext">hasFile :: Bool
</span><a href="#local-6989586621679160401"><span class="hs-identifier hs-var">hasFile</span></a></span></span><span> </span><span id="local-6989586621679160400"><span class="annot"><span class="annottext">a :: Maybe Text
</span><a href="#local-6989586621679160400"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621679160399"><span class="annot"><span class="annottext">e :: Maybe Text
</span><a href="#local-6989586621679160399"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span id="local-6989586621679160398"><span class="annot"><span class="annottext">s :: Maybe Text
</span><a href="#local-6989586621679160398"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span id="local-6989586621679160397"><span class="annot"><span class="annottext">t :: Maybe Text
</span><a href="#local-6989586621679160397"><span class="hs-identifier hs-var">t</span></a></span></span><span>
</span><span id="line-24"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679160414"><span class="hs-identifier hs-var">isLocked</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text -&gt; Either Text PostStub
forall a b. a -&gt; Either a b
</span><span class="hs-identifier hs-var">Left</span></span><span> </span><span class="annot"><span class="hs-string">&quot;Board is locked&quot;</span></span><span>
</span><span id="line-25"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679160396"><span class="hs-identifier hs-var">postText</span></a></span><span>    </span><span class="annot"><span class="annottext">Text -&gt; Int -&gt; Bool
</span><a href="#local-6989586621679160395"><span class="hs-operator hs-var">#&lt;</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679160413"><span class="hs-identifier hs-var">minLen</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679160401"><span class="hs-identifier hs-var">hasFile</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text -&gt; Either Text PostStub
forall a b. a -&gt; Either a b
</span><span class="hs-identifier hs-var">Left</span></span><span> </span><span class="annot"><span class="hs-string">&quot;Post text too short&quot;</span></span><span>
</span><span id="line-26"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679160396"><span class="hs-identifier hs-var">postText</span></a></span><span>    </span><span class="annot"><span class="annottext">Text -&gt; Int -&gt; Bool
</span><a href="#local-6989586621679160392"><span class="hs-operator hs-var">#&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679160412"><span class="hs-identifier hs-var">maxLen</span></a></span><span>                 </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text -&gt; Either Text PostStub
forall a b. a -&gt; Either a b
</span><span class="hs-identifier hs-var">Left</span></span><span> </span><span class="annot"><span class="hs-string">&quot;Post text too long&quot;</span></span><span>
</span><span id="line-27"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679160391"><span class="hs-identifier hs-var">postEmail</span></a></span><span>   </span><span class="annot"><span class="annottext">Text -&gt; Int -&gt; Bool
</span><a href="#local-6989586621679160392"><span class="hs-operator hs-var">#&gt;</span></a></span><span> </span><span class="annot"><span class="hs-number">320</span></span><span>                    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text -&gt; Either Text PostStub
forall a b. a -&gt; Either a b
</span><span class="hs-identifier hs-var">Left</span></span><span> </span><span class="annot"><span class="hs-string">&quot;Email too long&quot;</span></span><span>
</span><span id="line-28"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679160390"><span class="hs-identifier hs-var">postSubject</span></a></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Int -&gt; Bool
</span><a href="#local-6989586621679160392"><span class="hs-operator hs-var">#&gt;</span></a></span><span> </span><span class="annot"><span class="hs-number">128</span></span><span>                    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text -&gt; Either Text PostStub
forall a b. a -&gt; Either a b
</span><span class="hs-identifier hs-var">Left</span></span><span> </span><span class="annot"><span class="hs-string">&quot;Subject too long&quot;</span></span><span>
</span><span id="line-29"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679160389"><span class="hs-identifier hs-var">postAuthor</span></a></span><span>  </span><span class="annot"><span class="annottext">Text -&gt; Int -&gt; Bool
</span><a href="#local-6989586621679160392"><span class="hs-operator hs-var">#&gt;</span></a></span><span> </span><span class="annot"><span class="hs-number">64</span></span><span>                     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text -&gt; Either Text PostStub
forall a b. a -&gt; Either a b
</span><span class="hs-identifier hs-var">Left</span></span><span> </span><span class="annot"><span class="hs-string">&quot;Author name too long&quot;</span></span><span>
</span><span id="line-30"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Int
</span><span class="hs-identifier hs-var">T.count</span></span><span> </span><span class="annot"><span class="hs-string">&quot;\n&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679160396"><span class="hs-identifier hs-var">postText</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679160411"><span class="hs-identifier hs-var">maxNewLines</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text -&gt; Either Text PostStub
forall a b. a -&gt; Either a b
</span><span class="hs-identifier hs-var">Left</span></span><span> </span><span class="annot"><span class="hs-string">&quot;Too many newlines in post text&quot;</span></span><span>
</span><span id="line-31"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PostStub -&gt; Either Text PostStub
forall a b. b -&gt; Either a b
</span><span class="hs-identifier hs-var">Right</span></span><span> </span><span class="annot"><span class="annottext">(PostStub -&gt; Either Text PostStub)
-&gt; PostStub -&gt; Either Text PostStub
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text -&gt; Text -&gt; PostStub
</span><a href="Imageboard.Types.html#Stub"><span class="hs-identifier hs-var">Stub</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679160389"><span class="hs-identifier hs-var">postAuthor</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679160391"><span class="hs-identifier hs-var">postEmail</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679160390"><span class="hs-identifier hs-var">postSubject</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679160396"><span class="hs-identifier hs-var">postText</span></a></span><span>
</span><span id="line-32"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-33"></span><span>        </span><span id="local-6989586621679160385"><span class="annot"><span class="annottext">x :: Text
</span><a href="#local-6989586621679160385"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679160395"><span class="annot"><span class="annottext">#&lt; :: Text -&gt; Int -&gt; Bool
</span><a href="#local-6989586621679160395"><span class="hs-operator hs-var hs-var">#&lt;</span></a></span></span><span> </span><span id="local-6989586621679160384"><span class="annot"><span class="annottext">y :: Int
</span><a href="#local-6989586621679160384"><span class="hs-identifier hs-var">y</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text -&gt; Int -&gt; Ordering
</span><span class="hs-identifier hs-var">T.compareLength</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679160385"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679160384"><span class="hs-identifier hs-var">y</span></a></span><span> </span><span class="annot"><span class="annottext">Ordering -&gt; Ordering -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Ordering
</span><span class="hs-identifier hs-var">LT</span></span><span>
</span><span id="line-34"></span><span>        </span><span id="local-6989586621679160382"><span class="annot"><span class="annottext">x :: Text
</span><a href="#local-6989586621679160382"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679160392"><span class="annot"><span class="annottext">#&gt; :: Text -&gt; Int -&gt; Bool
</span><a href="#local-6989586621679160392"><span class="hs-operator hs-var hs-var">#&gt;</span></a></span></span><span> </span><span id="local-6989586621679160381"><span class="annot"><span class="annottext">y :: Int
</span><a href="#local-6989586621679160381"><span class="hs-identifier hs-var">y</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text -&gt; Int -&gt; Ordering
</span><span class="hs-identifier hs-var">T.compareLength</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679160382"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679160381"><span class="hs-identifier hs-var">y</span></a></span><span> </span><span class="annot"><span class="annottext">Ordering -&gt; Ordering -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Ordering
</span><span class="hs-identifier hs-var">GT</span></span><span>
</span><span id="line-35"></span><span>        </span><span id="local-6989586621679160389"><span class="annot"><span class="annottext">postAuthor :: Text
</span><a href="#local-6989586621679160389"><span class="hs-identifier hs-var hs-var">postAuthor</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe Text
</span><a href="#local-6989586621679160400"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-36"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679160380"><span class="annot"><span class="annottext">name :: Text
</span><a href="#local-6989586621679160380"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Bool) -&gt; Bool -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Bool
</span><span class="hs-identifier hs-var">T.null</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679160380"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679160380"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-37"></span><span>            </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-string">&quot;Nameless&quot;</span></span><span>
</span><span id="line-38"></span><span>        </span><span id="local-6989586621679160391"><span class="annot"><span class="annottext">postEmail :: Text
</span><a href="#local-6989586621679160391"><span class="hs-identifier hs-var hs-var">postEmail</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe Text -&gt; Text
forall (t :: * -&gt; *) m. (Foldable t, Monoid m) =&gt; t m -&gt; m
</span><span class="hs-identifier hs-var">fold</span></span><span> </span><span class="annot"><span class="annottext">Maybe Text
</span><a href="#local-6989586621679160399"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-39"></span><span>        </span><span id="local-6989586621679160390"><span class="annot"><span class="annottext">postSubject :: Text
</span><a href="#local-6989586621679160390"><span class="hs-identifier hs-var hs-var">postSubject</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe Text -&gt; Text
forall (t :: * -&gt; *) m. (Foldable t, Monoid m) =&gt; t m -&gt; m
</span><span class="hs-identifier hs-var">fold</span></span><span> </span><span class="annot"><span class="annottext">Maybe Text
</span><a href="#local-6989586621679160398"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-40"></span><span>        </span><span id="local-6989586621679160396"><span class="annot"><span class="annottext">postText :: Text
</span><a href="#local-6989586621679160396"><span class="hs-identifier hs-var hs-var">postText</span></a></span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe Text -&gt; Text
forall (t :: * -&gt; *) m. (Foldable t, Monoid m) =&gt; t m -&gt; m
</span><span class="hs-identifier hs-var">fold</span></span><span> </span><span class="annot"><span class="annottext">Maybe Text
</span><a href="#local-6989586621679160397"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-41"></span><span>
</span><span id="line-42"></span><span id="local-6989586621679160470"><span class="annot"><a href="Imageboard.Actions.Posting.html#tryInsertFile"><span class="hs-identifier hs-type">tryInsertFile</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621679160470"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Imageboard.FileUpload.html#FileData"><span class="hs-identifier hs-type">FileData</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ExceptT</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span> </span><span class="annot"><a href="#local-6989586621679160470"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span></span><span>
</span><span id="line-43"></span><span id="tryInsertFile"><span class="annot"><span class="annottext">tryInsertFile :: FileData -&gt; ExceptT Text m Int
</span><a href="Imageboard.Actions.Posting.html#tryInsertFile"><span class="hs-identifier hs-var hs-var">tryInsertFile</span></a></span></span><span> </span><span id="local-6989586621679160377"><span class="annot"><span class="annottext">fdata :: FileData
</span><a href="#local-6989586621679160377"><span class="hs-identifier hs-var">fdata</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-44"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621679160376"><span class="annot"><span class="annottext">f :: File
</span><a href="#local-6989586621679160376"><span class="hs-identifier hs-var">f</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679160375"><span class="annot"><span class="annottext">fPath :: FilePath
</span><a href="#local-6989586621679160375"><span class="hs-identifier hs-var">fPath</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Either Text (File, FilePath) -&gt; ExceptT Text m (File, FilePath)
forall e (m :: * -&gt; *) a. MonadError e m =&gt; Either e a -&gt; m a
</span><span class="hs-identifier hs-var">liftEither</span></span><span> </span><span class="annot"><span class="annottext">(Either Text (File, FilePath) -&gt; ExceptT Text m (File, FilePath))
-&gt; Either Text (File, FilePath) -&gt; ExceptT Text m (File, FilePath)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">FileData -&gt; Either Text (File, FilePath)
</span><a href="Imageboard.FileUpload.html#tryMkFile"><span class="hs-identifier hs-var">tryMkFile</span></a></span><span> </span><span class="annot"><span class="annottext">FileData
</span><a href="#local-6989586621679160377"><span class="hs-identifier hs-var">fdata</span></a></span><span>
</span><span id="line-45"></span><span>    </span><span id="local-6989586621679160372"><span class="annot"><span class="annottext">Maybe Int
</span><a href="#local-6989586621679160372"><span class="hs-identifier hs-var">exists</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span class="annot"><span class="annottext">IO (Maybe Int) -&gt; ExceptT Text m (Maybe Int)
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO (Maybe Int) -&gt; ExceptT Text m (Maybe Int))
-&gt; IO (Maybe Int) -&gt; ExceptT Text m (Maybe Int)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; IO (Maybe Int)
</span><a href="Imageboard.Database.html#getFileId"><span class="hs-identifier hs-var">getFileId</span></a></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; IO (Maybe Int)) -&gt; Text -&gt; IO (Maybe Int)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">File -&gt; Text
</span><a href="Imageboard.Types.html#filename"><span class="hs-identifier hs-var hs-var">filename</span></a></span><span> </span><span class="annot"><span class="annottext">File
</span><a href="#local-6989586621679160376"><span class="hs-identifier hs-var">f</span></a></span><span>
</span><span id="line-46"></span><span>    </span><span class="annot"><span class="annottext">ExceptT Text m Int
-&gt; (Int -&gt; ExceptT Text m Int) -&gt; Maybe Int -&gt; ExceptT Text m Int
forall b a. b -&gt; (a -&gt; b) -&gt; Maybe a -&gt; b
</span><span class="hs-identifier hs-var">maybe</span></span><span>
</span><span id="line-47"></span><span>        </span><span class="hs-keyword">do</span><span>
</span><span id="line-48"></span><span>            </span><span id="local-6989586621679160367"><span class="annot"><span class="annottext">File
</span><a href="#local-6989586621679160367"><span class="hs-identifier hs-var">newF</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">File -&gt; FileData -&gt; FilePath -&gt; ExceptT Text m File
forall (m :: * -&gt; *).
MonadIO m =&gt;
File -&gt; FileData -&gt; FilePath -&gt; ExceptT Text m File
</span><a href="Imageboard.FileUpload.html#saveFile"><span class="hs-identifier hs-var">saveFile</span></a></span><span> </span><span class="annot"><span class="annottext">File
</span><a href="#local-6989586621679160376"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">FileData
</span><a href="#local-6989586621679160377"><span class="hs-identifier hs-var">fdata</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621679160375"><span class="hs-identifier hs-var">fPath</span></a></span><span>
</span><span id="line-49"></span><span>            </span><span class="annot"><span class="annottext">IO Int -&gt; ExceptT Text m Int
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO Int -&gt; ExceptT Text m Int) -&gt; IO Int -&gt; ExceptT Text m Int
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">File -&gt; IO Int
</span><a href="Imageboard.Database.html#insertFile"><span class="hs-identifier hs-var">insertFile</span></a></span><span> </span><span class="annot"><span class="annottext">File
</span><a href="#local-6989586621679160367"><span class="hs-identifier hs-var">newF</span></a></span><span>
</span><span id="line-50"></span><span>        </span><span class="annot"><span class="annottext">Int -&gt; ExceptT Text m Int
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span>
</span><span id="line-51"></span><span>        </span><span class="annot"><span class="annottext">Maybe Int
</span><a href="#local-6989586621679160372"><span class="hs-identifier hs-var">exists</span></a></span><span>
</span><span id="line-52"></span><span>
</span><span id="line-53"></span><span class="annot"><a href="Imageboard.Actions.Posting.html#canReply"><span class="hs-identifier hs-type">canReply</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Imageboard.Types.html#ThreadInfo"><span class="hs-identifier hs-type">ThreadInfo</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Imageboard.Types.html#BoardConstraints"><span class="hs-identifier hs-type">BoardConstraints</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-54"></span><span id="canReply"><span class="annot"><span class="annottext">canReply :: ThreadInfo -&gt; BoardConstraints -&gt; Either Text ()
</span><a href="Imageboard.Actions.Posting.html#canReply"><span class="hs-identifier hs-var hs-var">canReply</span></a></span></span><span> </span><span id="local-6989586621679160361"><span id="local-6989586621679160362"><span id="local-6989586621679160363"><span class="annot"><a href="Imageboard.Types.html#ThreadInfo"><span class="hs-identifier hs-type">ThreadInfo</span></a></span><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span></span></span></span><span> </span><span id="local-6989586621679160351"><span id="local-6989586621679160352"><span id="local-6989586621679160353"><span id="local-6989586621679160354"><span id="local-6989586621679160355"><span id="local-6989586621679160356"><span class="annot"><a href="Imageboard.Types.html#Constraints"><span class="hs-identifier hs-type">Constraints</span></a></span><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span></span></span></span></span></span></span><span>
</span><span id="line-55"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">ThreadFlags -&gt; Bool
</span><a href="Imageboard.Types.html#lock"><span class="hs-identifier hs-var hs-var">lock</span></a></span><span> </span><span class="annot"><span class="annottext">ThreadFlags
</span><a href="#local-6989586621679160362"><span class="hs-identifier hs-var">flags</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text -&gt; Either Text ()
forall a b. a -&gt; Either a b
</span><span class="hs-identifier hs-var">Left</span></span><span> </span><span class="annot"><span class="hs-string">&quot;Thread is locked&quot;</span></span><span>
</span><span id="line-56"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Bool) -&gt; Bool -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ThreadFlags -&gt; Bool
</span><a href="Imageboard.Types.html#cycle_"><span class="hs-identifier hs-var hs-var">cycle_</span></a></span><span> </span><span class="annot"><span class="annottext">ThreadFlags
</span><a href="#local-6989586621679160362"><span class="hs-identifier hs-var">flags</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679160361"><span class="hs-identifier hs-var">replyCount</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679160352"><span class="hs-identifier hs-var">maxReplies</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text -&gt; Either Text ()
forall a b. a -&gt; Either a b
</span><span class="hs-identifier hs-var">Left</span></span><span> </span><span class="annot"><span class="hs-string">&quot;Thread reached maximum number of replies&quot;</span></span><span>
</span><span id="line-57"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">() -&gt; Either Text ()
forall a b. b -&gt; Either a b
</span><span class="hs-identifier hs-var">Right</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-58"></span><span>
</span><span id="line-59"></span><span id="local-6989586621679160427"><span class="annot"><a href="Imageboard.Actions.Posting.html#tryInsertThread"><span class="hs-identifier hs-type">tryInsertThread</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621679160427"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Imageboard.Types.html#Board"><span class="hs-identifier hs-type">Board</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Imageboard.Types.html#PostStub"><span class="hs-identifier hs-type">PostStub</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="Imageboard.FileUpload.html#FileData"><span class="hs-identifier hs-type">FileData</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ExceptT</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span> </span><span class="annot"><a href="#local-6989586621679160427"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-60"></span><span id="tryInsertThread"><span class="annot"><span class="annottext">tryInsertThread :: Text -&gt; PostStub -&gt; Maybe FileData -&gt; ExceptT Text m ()
</span><a href="Imageboard.Actions.Posting.html#tryInsertThread"><span class="hs-identifier hs-var hs-var">tryInsertThread</span></a></span></span><span> </span><span id="local-6989586621679160346"><span class="annot"><span class="annottext">b :: Text
</span><a href="#local-6989586621679160346"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span id="local-6989586621679160345"><span class="annot"><span class="annottext">stub :: PostStub
</span><a href="#local-6989586621679160345"><span class="hs-identifier hs-var">stub</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ExceptT Text m ()
-&gt; (FileData -&gt; ExceptT Text m ())
-&gt; Maybe FileData
-&gt; ExceptT Text m ()
forall b a. b -&gt; (a -&gt; b) -&gt; Maybe a -&gt; b
</span><span class="hs-identifier hs-var">maybe</span></span><span>
</span><span id="line-61"></span><span>    </span><span class="hs-keyword">do</span><span> </span><span class="annot"><span class="annottext">IO () -&gt; ExceptT Text m ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; ExceptT Text m ()) -&gt; IO () -&gt; ExceptT Text m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; PostStub -&gt; IO ()
</span><a href="Imageboard.Database.html#insertThread"><span class="hs-identifier hs-var">insertThread</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679160346"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="annot"><span class="annottext">PostStub
</span><a href="#local-6989586621679160345"><span class="hs-identifier hs-var">stub</span></a></span><span> </span><span>
</span><span id="line-62"></span><span>    </span><span class="hs-glyph">\</span><span id="local-6989586621679160343"><span class="annot"><span class="annottext">fdata :: FileData
</span><a href="#local-6989586621679160343"><span class="hs-identifier hs-var">fdata</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-63"></span><span>        </span><span id="local-6989586621679160342"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679160342"><span class="hs-identifier hs-var">fileId</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">FileData -&gt; ExceptT Text m Int
forall (m :: * -&gt; *). MonadIO m =&gt; FileData -&gt; ExceptT Text m Int
</span><a href="Imageboard.Actions.Posting.html#tryInsertFile"><span class="hs-identifier hs-var">tryInsertFile</span></a></span><span> </span><span class="annot"><span class="annottext">FileData
</span><a href="#local-6989586621679160343"><span class="hs-identifier hs-var">fdata</span></a></span><span>
</span><span id="line-64"></span><span>        </span><span class="annot"><span class="annottext">IO () -&gt; ExceptT Text m ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; ExceptT Text m ()) -&gt; IO () -&gt; ExceptT Text m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; PostStub -&gt; Int -&gt; IO ()
</span><a href="Imageboard.Database.html#insertThreadWithFile"><span class="hs-identifier hs-var">insertThreadWithFile</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679160346"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="annot"><span class="annottext">PostStub
</span><a href="#local-6989586621679160345"><span class="hs-identifier hs-var">stub</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679160342"><span class="hs-identifier hs-var">fileId</span></a></span><span>
</span><span id="line-65"></span><span>    </span><span>
</span><span id="line-66"></span><span>
</span><span id="line-67"></span><span id="local-6989586621679160433"><span class="annot"><a href="Imageboard.Actions.Posting.html#tryInsertPost"><span class="hs-identifier hs-type">tryInsertPost</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621679160433"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Imageboard.Types.html#Board"><span class="hs-identifier hs-type">Board</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Imageboard.Types.html#PostStub"><span class="hs-identifier hs-type">PostStub</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="Imageboard.FileUpload.html#FileData"><span class="hs-identifier hs-type">FileData</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ExceptT</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span> </span><span class="annot"><a href="#local-6989586621679160433"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-68"></span><span id="tryInsertPost"><span class="annot"><span class="annottext">tryInsertPost :: Text -&gt; Int -&gt; PostStub -&gt; Maybe FileData -&gt; ExceptT Text m ()
</span><a href="Imageboard.Actions.Posting.html#tryInsertPost"><span class="hs-identifier hs-var hs-var">tryInsertPost</span></a></span></span><span> </span><span id="local-6989586621679160339"><span class="annot"><span class="annottext">b :: Text
</span><a href="#local-6989586621679160339"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span id="local-6989586621679160338"><span class="annot"><span class="annottext">p :: Int
</span><a href="#local-6989586621679160338"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span id="local-6989586621679160337"><span class="annot"><span class="annottext">stub :: PostStub
</span><a href="#local-6989586621679160337"><span class="hs-identifier hs-var">stub</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ExceptT Text m ()
-&gt; (FileData -&gt; ExceptT Text m ())
-&gt; Maybe FileData
-&gt; ExceptT Text m ()
forall b a. b -&gt; (a -&gt; b) -&gt; Maybe a -&gt; b
</span><span class="hs-identifier hs-var">maybe</span></span><span>
</span><span id="line-69"></span><span>    </span><span class="hs-keyword">do</span><span> </span><span class="annot"><span class="annottext">IO () -&gt; ExceptT Text m ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; ExceptT Text m ()) -&gt; IO () -&gt; ExceptT Text m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Int -&gt; PostStub -&gt; IO ()
</span><a href="Imageboard.Database.html#insertPost"><span class="hs-identifier hs-var">insertPost</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679160339"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679160338"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="annot"><span class="annottext">PostStub
</span><a href="#local-6989586621679160337"><span class="hs-identifier hs-var">stub</span></a></span><span> </span><span>
</span><span id="line-70"></span><span>    </span><span class="hs-glyph">\</span><span id="local-6989586621679160335"><span class="annot"><span class="annottext">fdata :: FileData
</span><a href="#local-6989586621679160335"><span class="hs-identifier hs-var">fdata</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-71"></span><span>        </span><span id="local-6989586621679160334"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679160334"><span class="hs-identifier hs-var">fileId</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">FileData -&gt; ExceptT Text m Int
forall (m :: * -&gt; *). MonadIO m =&gt; FileData -&gt; ExceptT Text m Int
</span><a href="Imageboard.Actions.Posting.html#tryInsertFile"><span class="hs-identifier hs-var">tryInsertFile</span></a></span><span> </span><span class="annot"><span class="annottext">FileData
</span><a href="#local-6989586621679160335"><span class="hs-identifier hs-var">fdata</span></a></span><span>
</span><span id="line-72"></span><span>        </span><span class="annot"><span class="annottext">IO () -&gt; ExceptT Text m ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; ExceptT Text m ()) -&gt; IO () -&gt; ExceptT Text m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Int -&gt; PostStub -&gt; Int -&gt; IO ()
</span><a href="Imageboard.Database.html#insertPostWithFile"><span class="hs-identifier hs-var">insertPostWithFile</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679160339"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679160338"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="annot"><span class="annottext">PostStub
</span><a href="#local-6989586621679160337"><span class="hs-identifier hs-var">stub</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679160334"><span class="hs-identifier hs-var">fileId</span></a></span><span>
</span><span id="line-73"></span><span>        </span><span>
</span><span id="line-74"></span><span>
</span><span id="line-75"></span><span class="annot"><a href="Imageboard.Actions.Posting.html#validatePost"><span class="hs-identifier hs-type">validatePost</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Imageboard.Types.html#BoardConstraints"><span class="hs-identifier hs-type">BoardConstraints</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">S.ActionM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span> </span><span class="annot"><a href="Imageboard.Types.html#PostStub"><span class="hs-identifier hs-type">PostStub</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-76"></span><span id="validatePost"><span class="annot"><span class="annottext">validatePost :: BoardConstraints -&gt; Bool -&gt; ActionM (Either Text PostStub)
</span><a href="Imageboard.Actions.Posting.html#validatePost"><span class="hs-identifier hs-var hs-var">validatePost</span></a></span></span><span> </span><span id="local-6989586621679160331"><span class="annot"><span class="annottext">cstr :: BoardConstraints
</span><a href="#local-6989586621679160331"><span class="hs-identifier hs-var">cstr</span></a></span></span><span> </span><span id="local-6989586621679160330"><span class="annot"><span class="annottext">hasFile :: Bool
</span><a href="#local-6989586621679160330"><span class="hs-identifier hs-var">hasFile</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-77"></span><span>    </span><span class="annot"><span class="annottext">BoardConstraints
-&gt; Bool
-&gt; Maybe Text
-&gt; Maybe Text
-&gt; Maybe Text
-&gt; Maybe Text
-&gt; Either Text PostStub
</span><a href="Imageboard.Actions.Posting.html#tryMkStub"><span class="hs-identifier hs-var">tryMkStub</span></a></span><span> </span><span class="annot"><span class="annottext">BoardConstraints
</span><a href="#local-6989586621679160331"><span class="hs-identifier hs-var">cstr</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679160330"><span class="hs-identifier hs-var">hasFile</span></a></span><span>
</span><span id="line-78"></span><span>            </span><span class="annot"><span class="annottext">(Maybe Text
 -&gt; Maybe Text -&gt; Maybe Text -&gt; Maybe Text -&gt; Either Text PostStub)
-&gt; ActionT Text IO (Maybe Text)
-&gt; ActionT
     Text
     IO
     (Maybe Text -&gt; Maybe Text -&gt; Maybe Text -&gt; Either Text PostStub)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; ActionT Text IO (Maybe Text)
forall a. Parsable a =&gt; Text -&gt; ActionM (Maybe a)
</span><a href="Imageboard.Actions.Common.html#maybeParam"><span class="hs-identifier hs-var">maybeParam</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;name&quot;</span></span><span>
</span><span id="line-79"></span><span>            </span><span class="annot"><span class="annottext">ActionT
  Text
  IO
  (Maybe Text -&gt; Maybe Text -&gt; Maybe Text -&gt; Either Text PostStub)
-&gt; ActionT Text IO (Maybe Text)
-&gt; ActionT
     Text IO (Maybe Text -&gt; Maybe Text -&gt; Either Text PostStub)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; ActionT Text IO (Maybe Text)
forall a. Parsable a =&gt; Text -&gt; ActionM (Maybe a)
</span><a href="Imageboard.Actions.Common.html#maybeParam"><span class="hs-identifier hs-var">maybeParam</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;email&quot;</span></span><span>
</span><span id="line-80"></span><span>            </span><span class="annot"><span class="annottext">ActionT Text IO (Maybe Text -&gt; Maybe Text -&gt; Either Text PostStub)
-&gt; ActionT Text IO (Maybe Text)
-&gt; ActionT Text IO (Maybe Text -&gt; Either Text PostStub)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; ActionT Text IO (Maybe Text)
forall a. Parsable a =&gt; Text -&gt; ActionM (Maybe a)
</span><a href="Imageboard.Actions.Common.html#maybeParam"><span class="hs-identifier hs-var">maybeParam</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;subject&quot;</span></span><span>
</span><span id="line-81"></span><span>            </span><span class="annot"><span class="annottext">ActionT Text IO (Maybe Text -&gt; Either Text PostStub)
-&gt; ActionT Text IO (Maybe Text) -&gt; ActionM (Either Text PostStub)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; ActionT Text IO (Maybe Text)
forall a. Parsable a =&gt; Text -&gt; ActionM (Maybe a)
</span><a href="Imageboard.Actions.Common.html#maybeParam"><span class="hs-identifier hs-var">maybeParam</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;comment&quot;</span></span><span>
</span><span id="line-82"></span><span>
</span><span id="line-83"></span><span id="local-6989586621679160445"><span id="local-6989586621679160446"><span class="annot"><a href="Imageboard.Actions.Posting.html#validateCaptcha"><span class="hs-identifier hs-type">validateCaptcha</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">IsString</span></span><span> </span><span class="annot"><a href="#local-6989586621679160446"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621679160445"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadError</span></span><span> </span><span class="annot"><a href="#local-6989586621679160446"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679160445"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679160445"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span></span><span>
</span><span id="line-84"></span><span id="validateCaptcha"><span class="annot"><span class="annottext">validateCaptcha :: Text -&gt; m ()
</span><a href="Imageboard.Actions.Posting.html#validateCaptcha"><span class="hs-identifier hs-var hs-var">validateCaptcha</span></a></span></span><span> </span><span id="local-6989586621679160326"><span class="annot"><span class="annottext">captcha :: Text
</span><a href="#local-6989586621679160326"><span class="hs-identifier hs-var">captcha</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-85"></span><span>    </span><span id="local-6989586621679160325"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679160325"><span class="hs-identifier hs-var">validCaptcha</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO Bool -&gt; m Bool
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO Bool -&gt; m Bool) -&gt; IO Bool -&gt; m Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; IO Bool
</span><a href="Imageboard.Database.html#checkCaptcha"><span class="hs-identifier hs-var">checkCaptcha</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679160326"><span class="hs-identifier hs-var">captcha</span></a></span><span>
</span><span id="line-86"></span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; m () -&gt; m ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679160325"><span class="hs-identifier hs-var">validCaptcha</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(m () -&gt; m ()) -&gt; m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; m ()
forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwError</span></span><span> </span><span class="annot"><span class="hs-string">&quot;Invalid or expired captcha&quot;</span></span><span>
</span><span id="line-87"></span><span>
</span><span id="line-88"></span><span class="hs-comment">-- | This action will try to insert post sent by the user.</span><span>
</span><span id="line-89"></span><span class="hs-comment">-- In case of failure it will send user appropriate error page.</span><span>
</span><span id="line-90"></span><span class="annot"><a href="Imageboard.Actions.Posting.html#createPost"><span class="hs-identifier hs-type">createPost</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Imageboard.Types.html#Board"><span class="hs-identifier hs-type">Board</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Imageboard.Actions.Common.html#Action"><span class="hs-identifier hs-type">Action</span></a></span><span>
</span><span id="line-91"></span><span id="createPost"><span class="annot"><span class="annottext">createPost :: Text -&gt; Int -&gt; Action
</span><a href="Imageboard.Actions.Posting.html#createPost"><span class="hs-identifier hs-var hs-var">createPost</span></a></span></span><span> </span><span id="local-6989586621679160321"><span class="annot"><span class="annottext">b :: Text
</span><a href="#local-6989586621679160321"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span id="local-6989586621679160320"><span class="annot"><span class="annottext">p :: Int
</span><a href="#local-6989586621679160320"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span>
</span><span id="line-92"></span><span>    </span><span id="local-6989586621679160319"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679160319"><span class="hs-identifier hs-var">captcha</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Text -&gt; ActionM Text
forall a. Parsable a =&gt; Text -&gt; ActionM a
</span><span class="hs-identifier hs-var">S.param</span></span><span> </span><span class="annot"><span class="hs-string">&quot;captcha&quot;</span></span><span>
</span><span id="line-93"></span><span>    </span><span id="local-6989586621679160317"><span class="annot"><span class="annottext">Maybe FileData
</span><a href="#local-6989586621679160317"><span class="hs-identifier hs-var">postFile</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ActionM (Maybe FileData)
</span><a href="Imageboard.Actions.Common.html#maybeFile"><span class="hs-identifier hs-var">maybeFile</span></a></span><span>
</span><span id="line-94"></span><span>    </span><span id="local-6989586621679160315"><span class="annot"><span class="annottext">Either Text ()
</span><a href="#local-6989586621679160315"><span class="hs-identifier hs-var">result</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ExceptT Text (ActionT Text IO) ()
-&gt; ActionT Text IO (Either Text ())
forall e (m :: * -&gt; *) a. ExceptT e m a -&gt; m (Either e a)
</span><span class="hs-identifier hs-var">runExceptT</span></span><span> </span><span class="annot"><span class="annottext">(ExceptT Text (ActionT Text IO) ()
 -&gt; ActionT Text IO (Either Text ()))
-&gt; ExceptT Text (ActionT Text IO) ()
-&gt; ActionT Text IO (Either Text ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span> </span><span>
</span><span id="line-95"></span><span>        </span><span class="annot"><span class="annottext">Text -&gt; ExceptT Text (ActionT Text IO) ()
forall a (m :: * -&gt; *).
(IsString a, MonadIO m, MonadError a m) =&gt;
Text -&gt; m ()
</span><a href="Imageboard.Actions.Posting.html#validateCaptcha"><span class="hs-identifier hs-var">validateCaptcha</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679160319"><span class="hs-identifier hs-var">captcha</span></a></span><span>
</span><span id="line-96"></span><span>        </span><span id="local-6989586621679160313"><span class="annot"><span class="annottext">BoardConstraints
</span><a href="#local-6989586621679160313"><span class="hs-identifier hs-var">cstr</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Text
-&gt; Maybe BoardConstraints
-&gt; ExceptT Text (ActionT Text IO) BoardConstraints
forall (m :: * -&gt; *) b a. Monad m =&gt; b -&gt; Maybe a -&gt; ExceptT b m a
</span><a href="Imageboard.Actions.Common.html#maybetoExcept"><span class="hs-identifier hs-var">maybetoExcept</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;Board does not exist&quot;</span></span><span> </span><span class="annot"><span class="annottext">(Maybe BoardConstraints
 -&gt; ExceptT Text (ActionT Text IO) BoardConstraints)
-&gt; ExceptT Text (ActionT Text IO) (Maybe BoardConstraints)
-&gt; ExceptT Text (ActionT Text IO) BoardConstraints
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IO (Maybe BoardConstraints)
-&gt; ExceptT Text (ActionT Text IO) (Maybe BoardConstraints)
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO (Maybe BoardConstraints)
 -&gt; ExceptT Text (ActionT Text IO) (Maybe BoardConstraints))
-&gt; IO (Maybe BoardConstraints)
-&gt; ExceptT Text (ActionT Text IO) (Maybe BoardConstraints)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; IO (Maybe BoardConstraints)
</span><a href="Imageboard.Database.html#getConstraints"><span class="hs-identifier hs-var">getConstraints</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679160321"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-97"></span><span>        </span><span id="local-6989586621679160309"><span class="annot"><span class="annottext">PostStub
</span><a href="#local-6989586621679160309"><span class="hs-identifier hs-var">stub</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Either Text PostStub -&gt; ExceptT Text (ActionT Text IO) PostStub
forall e (m :: * -&gt; *) a. MonadError e m =&gt; Either e a -&gt; m a
</span><span class="hs-identifier hs-var">liftEither</span></span><span> </span><span class="annot"><span class="annottext">(Either Text PostStub -&gt; ExceptT Text (ActionT Text IO) PostStub)
-&gt; ExceptT Text (ActionT Text IO) (Either Text PostStub)
-&gt; ExceptT Text (ActionT Text IO) PostStub
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ActionM (Either Text PostStub)
-&gt; ExceptT Text (ActionT Text IO) (Either Text PostStub)
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">(ActionM (Either Text PostStub)
 -&gt; ExceptT Text (ActionT Text IO) (Either Text PostStub))
-&gt; ActionM (Either Text PostStub)
-&gt; ExceptT Text (ActionT Text IO) (Either Text PostStub)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BoardConstraints -&gt; Bool -&gt; ActionM (Either Text PostStub)
</span><a href="Imageboard.Actions.Posting.html#validatePost"><span class="hs-identifier hs-var">validatePost</span></a></span><span> </span><span class="annot"><span class="annottext">BoardConstraints
</span><a href="#local-6989586621679160313"><span class="hs-identifier hs-var">cstr</span></a></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; ActionM (Either Text PostStub))
-&gt; Bool -&gt; ActionM (Either Text PostStub)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Maybe FileData -&gt; Bool
forall a. Maybe a -&gt; Bool
</span><span class="hs-identifier hs-var">isJust</span></span><span> </span><span class="annot"><span class="annottext">Maybe FileData
</span><a href="#local-6989586621679160317"><span class="hs-identifier hs-var">postFile</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-98"></span><span>        </span><span id="local-6989586621679160306"><span class="annot"><span class="annottext">ThreadInfo
</span><a href="#local-6989586621679160306"><span class="hs-identifier hs-var">info</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Text
-&gt; Maybe ThreadInfo -&gt; ExceptT Text (ActionT Text IO) ThreadInfo
forall (m :: * -&gt; *) b a. Monad m =&gt; b -&gt; Maybe a -&gt; ExceptT b m a
</span><a href="Imageboard.Actions.Common.html#maybetoExcept"><span class="hs-identifier hs-var">maybetoExcept</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;Thread does not exist&quot;</span></span><span> </span><span class="annot"><span class="annottext">(Maybe ThreadInfo -&gt; ExceptT Text (ActionT Text IO) ThreadInfo)
-&gt; ExceptT Text (ActionT Text IO) (Maybe ThreadInfo)
-&gt; ExceptT Text (ActionT Text IO) ThreadInfo
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IO (Maybe ThreadInfo)
-&gt; ExceptT Text (ActionT Text IO) (Maybe ThreadInfo)
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO (Maybe ThreadInfo)
 -&gt; ExceptT Text (ActionT Text IO) (Maybe ThreadInfo))
-&gt; IO (Maybe ThreadInfo)
-&gt; ExceptT Text (ActionT Text IO) (Maybe ThreadInfo)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Int -&gt; IO (Maybe ThreadInfo)
</span><a href="Imageboard.Database.html#getThreadInfo"><span class="hs-identifier hs-var">getThreadInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679160321"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679160320"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-99"></span><span>        </span><span class="annot"><span class="annottext">Either Text () -&gt; ExceptT Text (ActionT Text IO) ()
forall e (m :: * -&gt; *) a. MonadError e m =&gt; Either e a -&gt; m a
</span><span class="hs-identifier hs-var">liftEither</span></span><span> </span><span class="annot"><span class="annottext">(Either Text () -&gt; ExceptT Text (ActionT Text IO) ())
-&gt; Either Text () -&gt; ExceptT Text (ActionT Text IO) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ThreadInfo -&gt; BoardConstraints -&gt; Either Text ()
</span><a href="Imageboard.Actions.Posting.html#canReply"><span class="hs-identifier hs-var">canReply</span></a></span><span> </span><span class="annot"><span class="annottext">ThreadInfo
</span><a href="#local-6989586621679160306"><span class="hs-identifier hs-var">info</span></a></span><span> </span><span class="annot"><span class="annottext">BoardConstraints
</span><a href="#local-6989586621679160313"><span class="hs-identifier hs-var">cstr</span></a></span><span>
</span><span id="line-100"></span><span>        </span><span class="annot"><span class="annottext">Text
-&gt; Int
-&gt; PostStub
-&gt; Maybe FileData
-&gt; ExceptT Text (ActionT Text IO) ()
forall (m :: * -&gt; *).
MonadIO m =&gt;
Text -&gt; Int -&gt; PostStub -&gt; Maybe FileData -&gt; ExceptT Text m ()
</span><a href="Imageboard.Actions.Posting.html#tryInsertPost"><span class="hs-identifier hs-var">tryInsertPost</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679160321"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679160320"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="annot"><span class="annottext">PostStub
</span><a href="#local-6989586621679160309"><span class="hs-identifier hs-var">stub</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe FileData
</span><a href="#local-6989586621679160317"><span class="hs-identifier hs-var">postFile</span></a></span><span>
</span><span id="line-101"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Either Text ()
</span><a href="#local-6989586621679160315"><span class="hs-identifier hs-var">result</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-102"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621679160304"><span class="annot"><span class="annottext">msg :: Text
</span><a href="#local-6989586621679160304"><span class="hs-identifier hs-var">msg</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-103"></span><span>            </span><span class="annot"><span class="annottext">Status -&gt; Action
</span><span class="hs-identifier hs-var">S.status</span></span><span> </span><span class="annot"><span class="annottext">Status
</span><span class="hs-identifier hs-var">badRequest400</span></span><span>
</span><span id="line-104"></span><span>            </span><span class="annot"><span class="annottext">Html -&gt; Action
</span><a href="Imageboard.Actions.Common.html#blaze"><span class="hs-identifier hs-var">blaze</span></a></span><span> </span><span class="annot"><span class="annottext">(Html -&gt; Action) -&gt; Html -&gt; Action
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Html
</span><a href="Imageboard.Pages.html#errorView"><span class="hs-identifier hs-var">errorView</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679160304"><span class="hs-identifier hs-var">msg</span></a></span><span>
</span><span id="line-105"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-106"></span><span>            </span><span class="annot"><span class="annottext">Status -&gt; Action
</span><span class="hs-identifier hs-var">S.status</span></span><span> </span><span class="annot"><span class="annottext">Status
</span><span class="hs-identifier hs-var">created201</span></span><span>
</span><span id="line-107"></span><span>            </span><span class="annot"><span class="annottext">Text -&gt; Action
forall a. Text -&gt; ActionM a
</span><span class="hs-identifier hs-var">S.redirect</span></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; Action) -&gt; Text -&gt; Action
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="hs-string">&quot;/&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text
</span><span class="hs-identifier hs-var">Lazy.fromStrict</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679160321"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="hs-string">&quot;/&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FilePath -&gt; Text
</span><span class="hs-identifier hs-var">Lazy.pack</span></span><span> </span><span class="annot"><span class="annottext">(FilePath -&gt; Text) -&gt; FilePath -&gt; Text
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; FilePath
forall a. Show a =&gt; a -&gt; FilePath
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679160320"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-108"></span><span>
</span><span id="line-109"></span><span class="hs-comment">-- | This action will try to insert new thread sent by the user.</span><span>
</span><span id="line-110"></span><span class="hs-comment">-- In case of failure it will send user appropriate error page.</span><span>
</span><span id="line-111"></span><span class="annot"><a href="Imageboard.Actions.Posting.html#createThread"><span class="hs-identifier hs-type">createThread</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Imageboard.Types.html#Board"><span class="hs-identifier hs-type">Board</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Imageboard.Actions.Common.html#Action"><span class="hs-identifier hs-type">Action</span></a></span><span>
</span><span id="line-112"></span><span id="createThread"><span class="annot"><span class="annottext">createThread :: Text -&gt; Action
</span><a href="Imageboard.Actions.Posting.html#createThread"><span class="hs-identifier hs-var hs-var">createThread</span></a></span></span><span> </span><span id="local-6989586621679160297"><span class="annot"><span class="annottext">b :: Text
</span><a href="#local-6989586621679160297"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-113"></span><span>    </span><span id="local-6989586621679160296"><span class="annot"><span class="annottext">Maybe FileData
</span><a href="#local-6989586621679160296"><span class="hs-identifier hs-var">postFile</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ActionM (Maybe FileData)
</span><a href="Imageboard.Actions.Common.html#maybeFile"><span class="hs-identifier hs-var">maybeFile</span></a></span><span>
</span><span id="line-114"></span><span>    </span><span id="local-6989586621679160295"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679160295"><span class="hs-identifier hs-var">captcha</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Text -&gt; ActionM Text
forall a. Parsable a =&gt; Text -&gt; ActionM a
</span><span class="hs-identifier hs-var">S.param</span></span><span> </span><span class="annot"><span class="hs-string">&quot;captcha&quot;</span></span><span>
</span><span id="line-115"></span><span>    </span><span class="annot"><span class="annottext">ExceptT Text (ActionT Text IO) ()
-&gt; ActionT Text IO (Either Text ())
forall e (m :: * -&gt; *) a. ExceptT e m a -&gt; m (Either e a)
</span><span class="hs-identifier hs-var">runExceptT</span></span><span> </span><span class="hs-keyword">do</span><span> </span><span>
</span><span id="line-116"></span><span>        </span><span class="annot"><span class="annottext">Text -&gt; ExceptT Text (ActionT Text IO) ()
forall a (m :: * -&gt; *).
(IsString a, MonadIO m, MonadError a m) =&gt;
Text -&gt; m ()
</span><a href="Imageboard.Actions.Posting.html#validateCaptcha"><span class="hs-identifier hs-var">validateCaptcha</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679160295"><span class="hs-identifier hs-var">captcha</span></a></span><span>
</span><span id="line-117"></span><span>        </span><span id="local-6989586621679160294"><span class="annot"><span class="annottext">BoardConstraints
</span><a href="#local-6989586621679160294"><span class="hs-identifier hs-var">cstr</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Text
-&gt; Maybe BoardConstraints
-&gt; ExceptT Text (ActionT Text IO) BoardConstraints
forall (m :: * -&gt; *) b a. Monad m =&gt; b -&gt; Maybe a -&gt; ExceptT b m a
</span><a href="Imageboard.Actions.Common.html#maybetoExcept"><span class="hs-identifier hs-var">maybetoExcept</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;Board does not exist&quot;</span></span><span> </span><span class="annot"><span class="annottext">(Maybe BoardConstraints
 -&gt; ExceptT Text (ActionT Text IO) BoardConstraints)
-&gt; ExceptT Text (ActionT Text IO) (Maybe BoardConstraints)
-&gt; ExceptT Text (ActionT Text IO) BoardConstraints
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IO (Maybe BoardConstraints)
-&gt; ExceptT Text (ActionT Text IO) (Maybe BoardConstraints)
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO (Maybe BoardConstraints)
 -&gt; ExceptT Text (ActionT Text IO) (Maybe BoardConstraints))
-&gt; IO (Maybe BoardConstraints)
-&gt; ExceptT Text (ActionT Text IO) (Maybe BoardConstraints)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; IO (Maybe BoardConstraints)
</span><a href="Imageboard.Database.html#getConstraints"><span class="hs-identifier hs-var">getConstraints</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679160297"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-118"></span><span>        </span><span id="local-6989586621679160293"><span class="annot"><span class="annottext">PostStub
</span><a href="#local-6989586621679160293"><span class="hs-identifier hs-var">stub</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Either Text PostStub -&gt; ExceptT Text (ActionT Text IO) PostStub
forall e (m :: * -&gt; *) a. MonadError e m =&gt; Either e a -&gt; m a
</span><span class="hs-identifier hs-var">liftEither</span></span><span> </span><span class="annot"><span class="annottext">(Either Text PostStub -&gt; ExceptT Text (ActionT Text IO) PostStub)
-&gt; ExceptT Text (ActionT Text IO) (Either Text PostStub)
-&gt; ExceptT Text (ActionT Text IO) PostStub
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ActionM (Either Text PostStub)
-&gt; ExceptT Text (ActionT Text IO) (Either Text PostStub)
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">(ActionM (Either Text PostStub)
 -&gt; ExceptT Text (ActionT Text IO) (Either Text PostStub))
-&gt; ActionM (Either Text PostStub)
-&gt; ExceptT Text (ActionT Text IO) (Either Text PostStub)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BoardConstraints -&gt; Bool -&gt; ActionM (Either Text PostStub)
</span><a href="Imageboard.Actions.Posting.html#validatePost"><span class="hs-identifier hs-var">validatePost</span></a></span><span> </span><span class="annot"><span class="annottext">BoardConstraints
</span><a href="#local-6989586621679160294"><span class="hs-identifier hs-var">cstr</span></a></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; ActionM (Either Text PostStub))
-&gt; Bool -&gt; ActionM (Either Text PostStub)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Maybe FileData -&gt; Bool
forall a. Maybe a -&gt; Bool
</span><span class="hs-identifier hs-var">isJust</span></span><span> </span><span class="annot"><span class="annottext">Maybe FileData
</span><a href="#local-6989586621679160296"><span class="hs-identifier hs-var">postFile</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-119"></span><span>        </span><span class="annot"><span class="annottext">Text
-&gt; PostStub -&gt; Maybe FileData -&gt; ExceptT Text (ActionT Text IO) ()
forall (m :: * -&gt; *).
MonadIO m =&gt;
Text -&gt; PostStub -&gt; Maybe FileData -&gt; ExceptT Text m ()
</span><a href="Imageboard.Actions.Posting.html#tryInsertThread"><span class="hs-identifier hs-var">tryInsertThread</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679160297"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="annot"><span class="annottext">PostStub
</span><a href="#local-6989586621679160293"><span class="hs-identifier hs-var">stub</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe FileData
</span><a href="#local-6989586621679160296"><span class="hs-identifier hs-var">postFile</span></a></span><span>
</span><span id="line-120"></span><span>    </span><span class="annot"><span class="annottext">ActionT Text IO (Either Text ())
-&gt; (Either Text () -&gt; Action) -&gt; Action
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; Action) -&gt; (() -&gt; Action) -&gt; Either Text () -&gt; Action
forall a c b. (a -&gt; c) -&gt; (b -&gt; c) -&gt; Either a b -&gt; c
</span><span class="hs-identifier hs-var">either</span></span><span>
</span><span id="line-121"></span><span>        </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679160291"><span class="annot"><span class="annottext">msg :: Text
</span><a href="#local-6989586621679160291"><span class="hs-identifier hs-var">msg</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-122"></span><span>            </span><span class="annot"><span class="annottext">Status -&gt; Action
</span><span class="hs-identifier hs-var">S.status</span></span><span> </span><span class="annot"><span class="annottext">Status
</span><span class="hs-identifier hs-var">badRequest400</span></span><span>
</span><span id="line-123"></span><span>            </span><span class="annot"><span class="annottext">Html -&gt; Action
</span><a href="Imageboard.Actions.Common.html#blaze"><span class="hs-identifier hs-var">blaze</span></a></span><span> </span><span class="annot"><span class="annottext">(Html -&gt; Action) -&gt; Html -&gt; Action
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Html
</span><a href="Imageboard.Pages.html#errorView"><span class="hs-identifier hs-var">errorView</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679160291"><span class="hs-identifier hs-var">msg</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-124"></span><span>        </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-125"></span><span>            </span><span class="annot"><span class="annottext">Status -&gt; Action
</span><span class="hs-identifier hs-var">S.status</span></span><span> </span><span class="annot"><span class="annottext">Status
</span><span class="hs-identifier hs-var">created201</span></span><span>
</span><span id="line-126"></span><span>            </span><span class="annot"><span class="annottext">Text -&gt; Action
forall a. Text -&gt; ActionM a
</span><span class="hs-identifier hs-var">S.redirect</span></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; Action) -&gt; Text -&gt; Action
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="hs-string">&quot;/&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text
</span><span class="hs-identifier hs-var">Lazy.fromStrict</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679160297"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-127"></span></pre></body></html>